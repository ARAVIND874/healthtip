<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ஆரோக்கிய நண்பன் - உங்கள் ஆரோக்கிய வழிகாட்டி</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Tone.js for sound generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #E6F7FF; /* Light Blue */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1.5rem;
            color: #333333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
            transition: all 0.5s ease-in-out;
            overflow-y: auto; /* Allow scrolling for features */
        }

        body.main-content-active {
            min-height: auto;
            align-items: flex-start;
            padding-top: 2rem;
            padding-bottom: 2rem;
            overflow-y: auto;
        }

        .container {
            max-width: 640px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 1.75rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
            padding: 2.5rem;
            text-align: center;
            position: relative;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .language-selector-wrapper {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
        }
        .input-wrapper {
            position: relative;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }
        .input-field {
            flex-grow: 1;
            padding: 1rem 1.25rem;
            padding-right: 3.5rem; /* Space for mic icon */
            border: 1px solid #D1D5DB;
            border-radius: 0.875rem;
            font-size: 1.05rem;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus {
            border-color: #87CEEB;
            box-shadow: 0 0 0 3px rgba(135, 206, 235, 0.4);
        }
        .mic-button {
            position: absolute;
            right: 1rem;
            background: none;
            border: none;
            color: #0000FF;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: color 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .mic-button:hover {
            color: #DC2626; /* Red */
            background-color: rgba(220, 38, 38, 0.1);
        }
        .mic-button.recording {
            color: #DC2626; /* Red */
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0.7); }
        }

        .generate-button, .action-button, .open-tracker-button, .ai-voice-button {
            background-color: #6A0DAD; /* Dark Violet */
            color: #ffffff;
            padding: 1rem 2rem;
            border-radius: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(106, 13, 173, 0.4);
            letter-spacing: 0.025em;
            margin-top: 1rem;
            border: none;
            display: inline-flex; /* Ensure flex behavior for centering icon/text */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
        }
        .generate-button:hover, .action-button:hover, .open-tracker-button:hover, .ai-voice-button:hover {
            background-color: #4B0A7B; /* Darker Violet */
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(106, 13, 173, 0.5);
        }
        .generate-button:active, .action-button:active, .open-tracker-button:active, .ai-voice-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(106, 13, 173, 0.3);
        }
        .loading-indicator {
            display: none;
            margin-top: 2rem;
            font-size: 1.15rem;
            color: #6B7280;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6A0DAD;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tip-box, .result-box { /* Unified style for all output boxes */
            background-color: #FFFFAA; /* Light Yellow */
            border: 1px solid #CCCC88; /* Darker Yellow */
            border-radius: 1.25rem;
            padding: 2rem;
            margin-top: 2rem;
            text-align: left;
            color: #333333;
            line-height: 1.7;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            font-size: 1.05rem;
            transition: all 0.5s ease-in-out;
            word-break: break-word; /* Ensure long words break */
        }
        .tip-box p, .result-box p {
            margin: 0;
        }
        .text-red-600 {
            color: #DC2626; /* Red */
        }
        /* Responsive adjustments */
        @media (max-width: 640px) {
            body {
                padding: 1rem;
            }
            .container {
                padding: 1.5rem;
                border-radius: 1.25rem;
            }
            .generate-button, .action-button, .open-tracker-button, .ai-voice-button {
                width: 100%;
                padding: 0.9rem 1.5rem;
            }
            .flex.flex-wrap.justify-center.gap-4 {
                flex-direction: column;
                gap: 0.75rem;
            }
            .language-selector-wrapper {
                top: 0.75rem;
                right: 0.75rem;
            }
            .input-wrapper {
                flex-direction: row;
                justify-content: center;
            }
            .mic-button {
                position: absolute;
                right: 0.5rem;
            }
        }
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #E6F7FF;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease-out;
            overflow: hidden;
        }
        .splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .splash-screen img {
            max-width: 25%;
            max-height: 25%;
            object-fit: contain;
        }

        /* Feature Button for Main Page */
        .features-toggle-button {
            font-size: 4rem; /* Even larger emoji size for the main toggle */
            cursor: pointer;
            padding: 1rem;
            border-radius: 1rem;
            transition: transform 0.3s ease, background-color 0.3s ease;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            line-height: 1;
            margin-top: 2rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            background-color: #e0f2fe; /* Light blue background */
        }
        .features-toggle-button:hover {
            transform: scale(1.05);
            background-color: #bee3f8; /* Slightly darker blue hover */
        }
        .features-toggle-button span.label {
            font-size: 1rem;
            margin-top: 0.75rem;
            color: #333;
            font-weight: 600;
        }

        /* Feature Icons and Sections */
        .feature-icon-container {
            display: flex;
            justify-content: center;
            gap: 1.5rem; /* Space between icons */
            margin-top: 2rem;
            flex-wrap: wrap; /* Allow icons to wrap on smaller screens */
        }
        .feature-icon {
            font-size: 3rem; /* Larger emoji size */
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.75rem;
            transition: transform 0.2s ease, background-color 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            line-height: 1;
        }
        .feature-icon:hover {
            transform: translateY(-5px);
            background-color: rgba(135, 206, 235, 0.1); /* Light blue hover */
        }
        .feature-icon span.label {
            font-size: 0.8rem; /* Smaller text label */
            margin-top: 0.5rem;
            color: #555;
            font-weight: 500;
        }

        /* Feature sections (initially hidden, shown by JS) */
        .feature-section {
            display: none;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb; /* Subtle separator */
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Specific feature section styles */
        .dropdown-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #D1D5DB;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            padding: 0.5rem 0;
            top: calc(100% + 5px); /* Position below input */
            left: 0;
        }
        .dropdown-menu div {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
        }
        .dropdown-menu div:hover {
            background-color: #F3F4F6;
        }
        .dropdown-menu div.selected {
            background-color: #e0f2fe; /* light blue */
            font-weight: 500;
        }
        
        .tts-voice-selector {
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.875rem;
            font-size: 0.95rem;
            background-color: white;
            margin-left: 1rem;
            flex-grow: 1;
        }
        .body-map-container {
            position: relative;
            width: 100%;
            max-width: 300px; /* Adjust as needed */
            margin: 0 auto;
            border: 1px solid #ccc;
            border-radius: 10px;
            overflow: hidden;
        }
        .body-map-image {
            width: 100%;
            height: auto;
            display: block;
        }
        .pain-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: red;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%); /* Center the dot on the click */
        }
        .pain-dot.selected {
            background-color: darkred;
            border: 2px solid yellow;
        }
        /* Hide all feature sections by default */
        .feature-section {
            display: none;
        }
        /* Show the main view or a specific section */
        #initialView, #allFeatureIconsContainer.active, .feature-section.active {
            display: block;
        }
        .back-button {
            background: none;
            border: none;
            color: #6A0DAD;
            font-weight: 600;
            cursor: pointer;
            padding: 0.5rem 0;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            transition: color 0.3s ease;
        }
        .back-button:hover {
            color: #4B0A7B;
        }

        /* Alarm Modal Styles */
        .alarm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .alarm-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .alarm-modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .alarm-modal.show .alarm-modal-content {
            transform: translateY(0);
        }
        .alarm-modal-content h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #6A0DAD;
            margin-bottom: 1rem;
        }
        .alarm-modal-content p {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 1.5rem;
        }
        .alarm-modal-content button {
            background-color: #6A0DAD;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .alarm-modal-content button:hover {
            background-color: #4B0A7B;
        }
    </style>
</head>
<body>
    <div id="splashScreen" class="splash-screen">
        <img src="https://placehold.co/150x150/E6F7FF/000000?text=Healthcare+Logo" alt="Healthcare related image">
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div class="language-selector-wrapper">
            <select id="languageSelect" aria-label="Select Language" class="p-2 border border-gray-300 rounded-md text-sm bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300">
                <option value="ta">தமிழ்</option>
                <option value="en">English</option>
            </select>
        </div>

        <div id="initialView">
            <h1 id="mainTitle" class="text-3xl font-bold text-gray-800 mb-4 lg:text-4xl"></h1>
            <p id="descriptionText" class="text-gray-600 mb-8 text-lg"></p>

            <h2 id="tipSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4"></h2>
            <div class="input-wrapper">
                <input type="text" id="goalInput" class="input-field" aria-label="உங்கள் ஆரோக்கிய இலக்கை உள்ளிடவும்">
                <button id="micBtn" class="mic-button" title="உங்கள் இலக்கைப் பேசுங்கள்" aria-label="உங்கள் ஆரோக்கிய இலக்கைப் பதிவு செய்யவும்">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                </button>
            </div>
            <div class="flex flex-wrap justify-center gap-4 mt-4">
                <button id="generateBtn" class="generate-button">✨ <span data-label-key="generateBtn"></span></button>
            </div>
            <div class="flex flex-wrap justify-center gap-4 mt-4">
                <button id="aiVoiceBtn" class="ai-voice-button" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                    </svg>
                </button>
                <select id="ttsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
            </div>
            <div id="loading" class="loading-indicator" aria-live="polite">
                <div class="loading-spinner"></div>
                <p id="loadingText"></p>
            </div>
            <div id="tipOutput" class="tip-box" aria-live="polite"></div>

            <hr class="border-t border-gray-300 my-8">

            <h2 id="featuresTitle" class="text-2xl font-semibold text-gray-700 mb-4"></h2>
            <button id="toggleFeaturesBtn" class="features-toggle-button" title="அனைத்து அம்சங்களையும் காண்க">
                ✨<span class="label" data-label-key="showFeaturesLabel"></span>
            </button>
        </div>

        <!-- This div will now contain both the list of icons and the individual feature sections -->
        <div id="featuresContainer" style="display: none;">
            <!-- This button takes you back to the initial view from the features section -->
            <button class="back-button" id="backToMainFromFeaturesContainer" style="display: none;">← <span data-label-key="backToMain"></span></button>
            <h1 id="featuresPageTitle" class="text-3xl font-bold text-gray-800 mb-6 mt-4 lg:text-4xl"></h1>

            <!-- All feature icons container -->
            <div id="allFeatureIconsContainer" class="feature-icon-container">
                <div id="iconStepTracker" class="feature-icon" data-section="stepTrackerSection" title="படி டிராக்கர்">👟<span class="label" data-label-key="stepTrackerLabel"></span></div>
                <div id="iconHeartRateTracker" class="feature-icon" data-section="heartRateTrackerSection" title="இதயத் துடிப்பு டிராக்கர்">💓<span class="label" data-label-key="heartRateTrackerLabel"></span></div>
                <div id="iconWaterTracker" class="feature-icon" data-section="waterTrackerSection" title="தண்ணீர் டிராக்கர்">💧<span class="label" data-label-key="waterTrackerLabel"></span></div>
                <div id="iconJournal" class="feature-icon" data-section="journalSection" title="மனநிலை & நன்றியுணர்வு ஜர்னல்">📝<span class="label" data-label-key="journalLabel"></span></div>
                <div id="iconLocalTips" class="feature-icon" data-section="localTipsSection" title="உள்ளூர் ஆரோக்கிய குறிப்புகள்">🌱<span class="label" data-label-key="localTipsLabel"></span></div>
                <div id="iconMealPlan" class="feature-icon" data-section="mealPlanSection" title="உணவுத் திட்டப் பரிந்துரைகள்">🍽️<span class="label" data-label-key="mealPlanLabel"></span></div>
                <div id="iconMoodAnalysis" class="feature-icon" data-section="moodAnalysisSection" title="உணர்வுப் பதிவேடு பகுப்பாய்வு">🧠<span class="label" data-label-key="moodAnalysisLabel"></span></div>
                <div id="iconExerciseYoga" class="feature-icon" data-section="exerciseYogaSection" title="உடற்பயிற்சி & யோகா">🤸‍♀️<span class="label" data-label-key="exerciseYogaLabel"></span></div>
                <div id="iconDiseasePrevention" class="feature-icon" data-section="diseasePreventionSection" title="நோய் தடுப்பு">🛡️<span class="label" data-label-key="diseasePreventionLabel"></span></div>
                <div id="iconWellnessChallenge" class="feature-icon" data-section="wellnessChallengeSection" title="ஆரோக்கிய சவால்கள்">🏅<span class="label" data-label-key="wellnessChallengeLabel"></span></div>
                <div id="iconMedicationReminder" class="feature-icon" data-section="medicationReminderSection" title="மருந்து நினைவூட்டல்">⏰<span class="label" data-label-key="medicationReminderLabel"></span></div>
                <div id="iconBodyPainMapping" class="feature-icon" data-section="bodyPainMappingSection" title="உடல் வலி மேப்பிங்">📍<span class="label" data-label-key="bodyPainMappingLabel"></span></div>
                <div id="iconFirstAidEmergency" class="feature-icon" data-section="firstAidEmergencySection" title="முதலுதவி & அவசர உதவி">🆘<span class="label" data-label-key="firstAidEmergencyLabel"></span></div>
            </div>

            <!-- All feature sections are now children of featuresContainer -->
            <div id="stepTrackerSection" class="feature-section">
                <!-- Data target for back button now points to the icons container -->
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="stepSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <div class="input-wrapper">
                    <label for="currentStepsDisplay" class="sr-only">தற்போதைய படிகள்</label>
                    <input type="text" id="currentStepsDisplay" class="input-field" value="0" readonly aria-atomic="true">
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="addOneStepBtn" class="action-button"></button>
                    <button id="addSingleStepBtn" class="action-button"></button> <!-- New button for single step -->
                    <button id="toggleTrackingBtn" class="action-button"></button>
                    <button id="resetStepsBtn" class="action-button"></button>
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="stepTipAiVoiceBtn" class="ai-voice-button" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="stepTipTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
                <div id="stepResultOutput" class="result-box" aria-live="polite"></div>
                <div id="stepTipOutput" class="tip-box" aria-live="polite"></div> <!-- Dedicated tip output -->
            </div>

            <div id="heartRateTrackerSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="heartRateSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <div class="input-wrapper">
                    <label for="currentHeartRateDisplay" class="sr-only">தற்போதைய இதயத் துடிப்பு</label>
                    <input type="text" id="currentHeartRateDisplay" class="input-field" value="0" readonly aria-atomic="true">
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="simulateHeartRateBtn" class="action-button"></button>
                    <button id="resetHeartRateBtn" class="action-button"></button>
                </div>
                <div id="heartRateResultOutput" class="result-box" aria-live="polite"></div>
                <div id="heartRateTipOutput" class="tip-box" aria-live="polite"></div> <!-- Dedicated tip output -->
            </div>

            <div id="waterTrackerSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="waterSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <div class="input-wrapper">
                    <label for="waterIntakeDisplay" class="sr-only">தற்போதைய தண்ணீர் உட்கொள்ளல்</label>
                    <input type="text" id="waterIntakeDisplay" class="input-field" value="0 ml" readonly aria-atomic="true">
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="addWaterBtn" class="action-button"></button>
                    <button id="resetWaterBtn" class="action-button"></button>
                </div>
                <div id="waterResultOutput" class="result-box" aria-live="polite"></div>
                <div id="waterTipOutput" class="tip-box" aria-live="polite"></div> <!-- Dedicated tip output -->
            </div>

            <div id="journalSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="journalSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="journalDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper flex-col items-stretch">
                    <label for="moodSelect" class="sr-only">உங்கள் மனநிலையைத் தேர்ந்தெடுக்கவும்</label>
                    <select id="moodSelect" class="input-field mb-4" aria-label="உங்கள் மனநிலையைத் தேர்ந்தெடுக்கவும்">
                        <option value="">உங்கள் மனநிலையைத் தேர்ந்தெடுக்கவும்</option>
                        <option value="happy">மகிழ்ச்சி 😄</option>
                        <option value="neutral">சாதாரணம் 😐</option>
                        <option value="sad">சோகம் 😔</option>
                        <option value="stressed">மன அழுத்தம் 😩</option>
                        <option value="energetic">ஆற்றல் 💪</option>
                    </select>
                    <label for="gratitudeInput" class="sr-only">நீங்கள் நன்றியுள்ள ஒரு விஷயத்தை எழுதுங்கள்</label>
                    <textarea id="gratitudeInput" class="input-field min-h-[100px]" placeholder="நீங்கள் நன்றியுள்ள ஒரு விஷயத்தை எழுதுங்கள்..." aria-label="நீங்கள் நன்றியுள்ள ஒரு விஷயத்தை எழுதுங்கள்"></textarea>
                </div>
                <button id="saveJournalEntryBtn" class="action-button mt-4"></button>
                <div id="journalEntriesOutput" class="result-box mt-4 text-left"></div>
                <button id="analyzeMoodJournalBtn" class="action-button mt-4">✨ <span data-label-key="analyzeMoodJournalBtn"></span></button>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="moodAnalysisAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="moodAnalysisTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
                <div id="moodAnalysisOutput" class="result-box mt-4 text-left" aria-live="polite"></div>
            </div>

            <div id="localTipsSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="localTipsSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="localTipsDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper mb-4"> <!-- Nested input-wrapper for mic -->
                    <input type="text" id="localTipCategory" class="input-field" aria-label="உதவிக்குறிப்பு வகையை உள்ளிடவும்" placeholder="எ.கா. மஞ்சள், முருங்கை, தியானம்...">
                    <button id="localTipMicBtn" class="mic-button" title="உதவிக்குறிப்பு வகையை பேசவும்" aria-label="உதவிக்குறிப்பு வகையைப் பதிவு செய்யவும்">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    </button>
                    <div id="localTipCategoryDropdown" class="dropdown-menu hidden mt-2 top-full left-0"></div>
                </div>
                <button id="getLocalTipBtn" class="generate-button">✨ <span data-label-key="getLocalTipBtn"></span></button>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="localTipAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="localTipTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
                <div id="localTipOutput" class="tip-box" aria-live="polite"></div>
            </div>

            <div id="mealPlanSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="mealPlanSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="mealPlanDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper flex-col items-stretch">
                    <label for="dietaryPreference" class="sr-only">உணவு விருப்பம் (எ.கா: சைவ உணவு, பழ உணவு)</label>
                    <input type="text" id="dietaryPreference" class="input-field mb-4" placeholder="உணவு விருப்பம் (எ.கா: சைவ உணவு, பழ உணவு)" aria-label="உணவு விருப்பம்">
                    <label for="allergies" class="sr-only">ஒவ்வாமைகள் (எ.கா: பால், கடலை)</label>
                    <input type="text" id="allergies" class="input-field mb-4" placeholder="ஒவ்வாமைகள் (எ.கா: பால், கடலை)" aria-label="ஒவ்வாமைகள்">
                    <label for="healthGoalMeal" class="sr-only">ஆரோக்கிய இலக்கு (எ.கா: எடை குறைப்பு, தசை வளர்ச்சி)</label>
                    <input type="text" id="healthGoalMeal" class="input-field" placeholder="ஆரோக்கிய இலக்கு (எ.கா: எடை குறைப்பு, தசை வளர்ச்சி)" aria-label="ஆரோக்கிய இலக்கு">
                </div>
                <button id="generateMealPlanBtn" class="generate-button">✨ <span data-label-key="generateMealPlanBtn"></span></button>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="mealPlanAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="mealPlanTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
                <div id="mealPlanOutput" class="result-box mt-4 text-left" aria-live="polite"></div>
            </div>

            <div id="exerciseYogaSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="exerciseYogaSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="exerciseYogaDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper flex-col items-stretch">
                    <label for="exerciseGoal" class="sr-only">உங்கள் உடற்பயிற்சி/யோகா இலக்கு (எ.கா: நெகிழ்வுத்தன்மை, வலிமை, தியானம்)</label>
                    <input type="text" id="exerciseGoal" class="input-field mb-4" placeholder="உங்கள் உடற்பயிற்சி/யோகா இலக்கு (எ.கா: நெகிழ்வுத்தன்மை, வலிமை, தியானம்)" aria-label="உடற்பயிற்சி/யோகா இலக்கு">
                    <label for="experienceLevel" class="sr-only">அனுபவ நிலை (எ.கா: ஆரம்பநிலை, இடைநிலை, மேம்பட்ட)</label>
                    <input type="text" id="experienceLevel" class="input-field" placeholder="அனுபவ நிலை (எ.கா: ஆரம்பநிலை, இடைநிலை, மேம்பட்ட)" aria-label="அனுபவ நிலை">
                </div>
                <button id="generateExerciseYogaBtn" class="generate-button">✨ <span data-label-key="generateExerciseYogaBtn"></span></button>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="exerciseYogaAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="exerciseYogaTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
                <div id="exerciseYogaOutput" class="result-box mt-4 text-left" aria-live="polite"></div>
            </div>

            <div id="diseasePreventionSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="diseasePreventionSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="diseasePreventionDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper mb-4">
                    <label for="diseaseName" class="sr-only">நோய் அல்லது நிலையின் பெயர்</label>
                    <input type="text" id="diseaseName" class="input-field" placeholder="நோய் அல்லது நிலையின் பெயர் (எ.கா: சர்க்கரை நோய், இதய நோய்)" aria-label="நோய் அல்லது நிலையின் பெயர்">
                </div>
                <button id="getPreventionTipsBtn" class="generate-button">✨ <span data-label-key="getPreventionTipsBtn"></span></button>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="diseasePreventionAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="diseasePreventionTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
                <div id="diseasePreventionOutput" class="result-box mt-4 text-left" aria-live="polite"></div>
            </div>

            <div id="wellnessChallengeSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="wellnessChallengeSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="wellnessChallengeDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper mb-4">
                    <label for="challengeType" class="sr-only">சவாலின் வகை (எ.கா: 30 நாள் தண்ணீர் சவால், 7 நாள் தியான சவால்)</label>
                    <input type="text" id="challengeType" class="input-field" placeholder="சவாலின் வகை (எ.கா: 30 நாள் தண்ணீர் சவால், 7 நாள் தியான சவால்)" aria-label="சவாலின் வகை">
                </div>
                <button id="generateChallengeBtn" class="generate-button">✨ <span data-label-key="generateChallengeBtn"></span></button>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="wellnessChallengeAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="wellnessChallengeTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
                <div id="wellnessChallengeOutput" class="result-box mt-4 text-left" aria-live="polite"></div>
            </div>

            <div id="medicationReminderSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="medicationReminderSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="medicationReminderDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper flex-col items-stretch">
                    <label for="medicationName" class="sr-only">மருந்தின் பெயர்</label>
                    <input type="text" id="medicationName" class="input-field mb-4" placeholder="மருந்தின் பெயர்" aria-label="மருந்தின் பெயர்">
                    <label for="medicationTime" class="sr-only">நேரம்</label>
                    <input type="time" id="medicationTime" class="input-field mb-4" aria-label="நேரம்">
                    <label for="medicationFrequency" class="sr-only">அதிர்வெண்</label>
                    <select id="medicationFrequency" class="input-field" aria-label="அதிர்வெண்">
                        <option value="daily">தினசரி</option>
                        <option value="monday">திங்கள்</option>
                        <option value="tuesday">செவ்வாய்</option>
                        <option value="wednesday">புதன்</option>
                        <option value="thursday">வியாழன்</option>
                        <option value="friday">வெள்ளி</option>
                        <option value="saturday">சனி</option>
                        <option value="sunday">ஞாயிறு</option>
                    </select>
                </div>
                <button id="addMedicationReminderBtn" class="action-button mt-4"></button>
                <div id="medicationRemindersList" class="result-box mt-4 text-left">
                    <h3 class="text-xl font-semibold text-gray-700 mb-2" data-label-key="currentReminders"></h3>
                    <ul id="remindersList" class="list-disc pl-5"></ul>
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="medicationReminderAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="medicationReminderTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
                <div id="medicationReminderOutput" class="tip-box mt-4" aria-live="polite"></div>
            </div>

            <div id="bodyPainMappingSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="bodyPainMappingSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="bodyPainMappingDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="body-map-container" id="bodyMapContainer">
                    <img src="https://placehold.co/300x500/E6F7FF/000000?text=Human+Body+Map" alt="Human Body Map" class="body-map-image" id="bodyMapImage">
                    <!-- Pain dots will be added here by JS -->
                </div>
                <div class="input-wrapper flex-col items-stretch mt-4">
                    <label for="painDescription" class="sr-only">வலி விளக்கம் (தேர்ந்தெடுக்கப்பட்ட புள்ளிக்கு)</label>
                    <textarea id="painDescription" class="input-field min-h-[80px]" placeholder="வலி விளக்கம் (தேர்ந்தெடுக்கப்பட்ட புள்ளிக்கு)..." aria-label="வலி விளக்கம்"></textarea>
                </div>
                <button id="addPainPointBtn" class="action-button mt-4"></button>
                <button id="getPainAdviceBtn" class="generate-button mt-4">✨ <span data-label-key="getPainAdviceBtn"></span></button>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="bodyPainAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="bodyPainTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
                <div id="painPointsOutput" class="result-box mt-4 text-left">
                    <h3 class="text-xl font-semibold text-gray-700 mb-2" data-label-key="recordedPainPoints"></h3>
                    <ul id="painPointsList" class="list-disc pl-5"></ul>
                </div>
                <div id="painAdviceOutput" class="tip-box mt-4" aria-live="polite"></div>
            </div>

            <div id="firstAidEmergencySection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="firstAidEmergencySectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="firstAidEmergencyDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper mb-4">
                    <label for="emergencyType" class="sr-only">அவசர நிலை வகை (எ.கா: காயம், மூச்சுத்திணறல், மயக்கம்)</label>
                    <input type="text" id="emergencyType" class="input-field" placeholder="அவசர நிலை வகை (எ.கா: காயம், மூச்சுத்திணறல், மயக்கம்)" aria-label="அவசர நிலை வகை">
                </div>
                <button id="getFirstAidStepsBtn" class="generate-button">✨ <span data-label-key="getFirstAidStepsBtn"></span></button>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="firstAidAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="firstAidTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
                <div id="firstAidOutput" class="result-box mt-4 text-left" aria-live="polite"></div>
            </div>

        </div>
    </div>

    <!-- Alarm Modal -->
    <div id="alarmModal" class="alarm-modal">
        <div class="alarm-modal-content">
            <h3 id="alarmModalTitle"></h3>
            <p id="alarmModalMessage"></p>
            <button id="closeAlarmModalBtn"></button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, addDoc, deleteDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous
        let isAuthReady = false; // Flag to indicate if authentication is ready

        // Global state variables
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let synth = window.speechSynthesis;
        let currentUtterance = null;
        let currentLanguage = 'ta'; // Default language
        let currentActiveSection = 'initialView'; // To track which section is currently visible

        // Tone.js for alarm sound
        const synthAlarm = new Tone.Synth().toDestination();

        // Translations object
        const translations = {
            ta: {
                mainTitle: "ஆரோக்கிய நண்பன்",
                descriptionText: "உங்கள் ஆரோக்கிய இலக்குகளை அடையவும், நல்வாழ்வுக்கான குறிப்புகள் பெறவும், பல்வேறு ஆரோக்கிய அம்சங்களை அணுகவும் உங்களுக்கு உதவும் ஒரு விரிவான வழிகாட்டி.",
                tipSectionTitle: "உங்கள் ஆரோக்கிய இலக்கை உள்ளிடவும்",
                generateBtn: "குறிப்பு பெறுங்கள்",
                loadingText: "குறிப்புகளை உருவாக்குகிறோம்...",
                tipOutputPlaceholder: "உங்கள் ஆரோக்கிய இலக்கை உள்ளிட்டு, 'குறிப்பு பெறுங்கள்' பொத்தானை அழுத்தவும்.",
                showFeaturesLabel: "அம்சங்கள்",
                featuresPageTitle: "ஆரோக்கிய நண்பன் அம்சங்கள்",
                backToMain: "முக்கிய பக்கத்திற்குத் திரும்பு",
                backToFeatures: "அம்சங்களுக்குத் திரும்பு",

                // Feature specific translations
                steps: "படிகள்", // Added for step tracker
                moodSelectPlaceholder: "உங்கள் மனநிலையைத் தேர்ந்தெடுக்கவும்", // Added
                gratitudeInputPlaceholder: "நீங்கள் நன்றியுள்ள ஒரு விஷயத்தை எழுதுங்கள்...", // Added
                localTipCategoryPlaceholder: "எ.கா. மஞ்சள், முருங்கை, தியானம்...", // Added
                dietaryPreferencePlaceholder: "உணவு விருப்பம் (எ.கா: சைவ உணவு, பழ உணவு)", // Added
                allergiesPlaceholder: "ஒவ்வாமைகள் (எ.கா: பால், கடலை)", // Added
                healthGoalMealPlaceholder: "ஆரோக்கிய இலக்கு (எ.கா: எடை குறைப்பு, தசை வளர்ச்சி)", // Added
                exerciseGoalPlaceholder: "உங்கள் உடற்பயிற்சி/யோகா இலக்கு (எ.கா: நெகிழ்வுத்தன்மை, வலிமை, தியானம்)", // Added
                experienceLevelPlaceholder: "அனுபவ நிலை (எ.கா: ஆரம்பநிலை, இடைநிலை, மேம்பட்ட)", // Added
                diseaseNamePlaceholder: "நோய் அல்லது நிலையின் பெயர் (எ.கா: சர்க்கரை நோய், இதய நோய்)", // Added
                challengeTypePlaceholder: "சவாலின் வகை (எ.கா: 30 நாள் தண்ணீர் சவால், 7 நாள் தியான சவால்)", // Added
                medicationNamePlaceholder: "மருந்தின் பெயர்", // Added
                painDescriptionPlaceholder: "வலி விளக்கம் (தேர்ந்தெடுக்கப்பட்ட புள்ளிக்கு)...", // Added
                emergencyTypePlaceholder: "அவசர நிலை வகை (எ.கா: காயம், மூச்சுத்திணறல், மயக்கம்)", // Added

                stepTrackerLabel: "படி டிராக்கர்",
                stepSectionTitle: "படி டிராக்கர்",
                addOneStepBtn: "100 படிகள் சேர்",
                addSingleStepBtn: "ஒரு படி சேர்",
                toggleTrackingBtn: "தானியங்கு டிராக்கிங் தொடங்கு",
                resetStepsBtn: "படிகளை மீட்டமை",
                stepResultOutputPlaceholder: "உங்கள் படிகளைக் கண்காணிக்கவும். தானியங்கு டிராக்கிங்கிற்கு 'தானியங்கு டிராக்கிங் தொடங்கு' என்பதை அழுத்தவும்.",
                stepTipOutputPlaceholder: "உங்கள் படிகளின் எண்ணிக்கையைப் பொறுத்து ஆரோக்கிய குறிப்புகள் இங்கு தோன்றும்.",

                heartRateTrackerLabel: "இதயத் துடிப்பு டிராக்கர்",
                heartRateSectionTitle: "இதயத் துடிப்பு டிராக்கர்",
                simulateHeartRateBtn: "இதயத் துடிப்பை உருவகப்படுத்து",
                resetHeartRateBtn: "இதயத் துடிப்பை மீட்டமை",
                heartRateResultOutputPlaceholder: "உங்கள் இதயத் துடிப்பை உருவகப்படுத்தி கண்காணிக்கவும்.",
                heartRateTipOutputPlaceholder: "உங்கள் இதயத் துடிப்பின் அடிப்படையில் ஆரோக்கிய குறிப்புகள் இங்கு தோன்றும்.",

                waterTrackerLabel: "தண்ணீர் டிராக்கர்",
                waterSectionTitle: "தண்ணீர் டிராக்கர்",
                addWaterBtn: "250ml தண்ணீர் சேர்",
                resetWaterBtn: "தண்ணீரை மீட்டமை",
                waterResultOutputPlaceholder: "உங்கள் தினசரி தண்ணீர் உட்கொள்ளலைக் கண்காணிக்கவும்.",
                waterTipOutputPlaceholder: "உங்கள் தண்ணீர் உட்கொள்ளலைப் பொறுத்து ஆரோக்கிய குறிப்புகள் இங்கு தோன்றும்.",

                journalLabel: "மனநிலை & நன்றியுணர்வு ஜர்னல்",
                journalSectionTitle: "மனநிலை & நன்றியுணர்வு ஜர்னல்",
                journalDescription: "உங்கள் மனநிலையையும், நீங்கள் நன்றியுள்ள விஷயங்களையும் பதிவு செய்து, உங்கள் உணர்வுகளைப் பகுப்பாய்வு செய்யுங்கள்.",
                saveJournalEntryBtn: "பதிவைச் சேமி",
                journalEntriesOutputPlaceholder: "உங்கள் ஜர்னல் பதிவுகள் இங்கு தோன்றும்.",
                analyzeMoodJournalBtn: "மனநிலையைப் பகுப்பாய்வு செய்",
                moodAnalysisOutputPlaceholder: "உங்கள் ஜர்னல் பதிவுகளின் அடிப்படையில் மனநிலை பகுப்பாய்வு இங்கு தோன்றும்.",

                localTipsLabel: "உள்ளூர் ஆரோக்கிய குறிப்புகள்",
                localTipsSectionTitle: "உள்ளூர் ஆரோக்கிய குறிப்புகள்",
                localTipsDescription: "பாரம்பரிய மற்றும் உள்ளூர் ஆரோக்கிய குறிப்புகளைப் பெறுங்கள். ஒரு வகையை உள்ளிடவும் அல்லது தேர்ந்தெடுக்கவும்.",
                getLocalTipBtn: "உதவிக்குறிப்பு பெறுங்கள்",
                localTipOutputPlaceholder: "உள்ளூர் ஆரோக்கிய குறிப்புகள் இங்கு தோன்றும்.",

                mealPlanLabel: "உணவுத் திட்டப் பரிந்துரைகள்",
                mealPlanSectionTitle: "உணவுத் திட்டப் பரிந்துரைகள்",
                mealPlanDescription: "உங்கள் உணவு விருப்பங்கள், ஒவ்வாமைகள் மற்றும் ஆரோக்கிய இலக்கின் அடிப்படையில் தனிப்பயனாக்கப்பட்ட உணவுத் திட்டங்களைப் பெறுங்கள்.",
                generateMealPlanBtn: "உணவுத் திட்டத்தை உருவாக்கு",
                mealPlanOutputPlaceholder: "உணவுத் திட்டப் பரிந்துரைகள் இங்கு தோன்றும்.",

                moodAnalysisLabel: "உணர்வுப் பதிவேடு பகுப்பாய்வு", // This is redundant with journal, but keeping for distinct icon
                exerciseYogaLabel: "உடற்பயிற்சி & யோகா",
                exerciseYogaSectionTitle: "உடற்பயிற்சி & யோகா பரிந்துரைகள்",
                exerciseYogaDescription: "உங்கள் இலக்கு மற்றும் அனுபவ நிலைக்கு ஏற்ப உடற்பயிற்சி மற்றும் யோகா பரிந்துரைகளைப் பெறுங்கள்.",
                generateExerciseYogaBtn: "பரிந்துரைகளை உருவாக்கு",
                exerciseYogaOutputPlaceholder: "உடற்பயிற்சி மற்றும் யோகா பரிந்துரைகள் இங்கு தோன்றும்.",

                diseasePreventionLabel: "நோய் தடுப்பு",
                diseasePreventionSectionTitle: "நோய் தடுப்பு குறிப்புகள்",
                diseasePreventionDescription: "ஒரு குறிப்பிட்ட நோய் அல்லது நிலையைத் தடுப்பதற்கான குறிப்புகளைப் பெறுங்கள்.",
                getPreventionTipsBtn: "தடுப்பு குறிப்புகளைப் பெறுங்கள்",
                diseasePreventionOutputPlaceholder: "நோய் தடுப்பு குறிப்புகள் இங்கு தோன்றும்.",

                wellnessChallengeLabel: "ஆரோக்கிய சவால்கள்",
                wellnessChallengeSectionTitle: "ஆரோக்கிய சவால்கள்",
                wellnessChallengeDescription: "உங்களை ஊக்குவிக்க தனிப்பயனாக்கப்பட்ட ஆரோக்கிய சவால்களைப் பெறுங்கள்.",
                generateChallengeBtn: "சவாலை உருவாக்கு",
                wellnessChallengeOutputPlaceholder: "ஆரோக்கிய சவால்கள் இங்கு தோன்றும்.",

                medicationReminderLabel: "மருந்து நினைவூட்டல்",
                medicationReminderSectionTitle: "மருந்து நினைவூட்டல்",
                medicationReminderDescription: "உங்கள் மருந்து நேரங்களை அமைத்து, சரியான நேரத்தில் நினைவூட்டல்களைப் பெறுங்கள்.",
                addMedicationReminderBtn: "நினைவூட்டலைச் சேர்",
                currentReminders: "தற்போதைய நினைவூட்டல்கள்:",
                medicationReminderOutputPlaceholder: "உங்கள் மருந்து நினைவூட்டல்கள் இங்கு தோன்றும்.",
                alarmModalTitle: "மருந்து நேரம்!",
                alarmModalMessage: "உங்கள் மருந்தை எடுத்துக் கொள்ள வேண்டிய நேரம்: ",
                closeAlarmModalBtn: "சரி",
                daily: "தினசரி",
                monday: "திங்கள்",
                tuesday: "செவ்வாய்",
                wednesday: "புதன்",
                thursday: "வியாழன்",
                friday: "வெள்ளி",
                saturday: "சனி",
                sunday: "ஞாயிறு",

                bodyPainMappingLabel: "உடல் வலி மேப்பிங்",
                bodyPainMappingSectionTitle: "உடல் வலி மேப்பிங்",
                bodyPainMappingDescription: "உடல் வரைபடத்தில் உங்கள் வலி இருக்கும் இடத்தைக் கிளிக் செய்து, வலி விளக்கத்தை உள்ளிட்டு, ஆலோசனை பெறுங்கள்.",
                addPainPointBtn: "வலிப் புள்ளியைச் சேர்",
                getPainAdviceBtn: "வலி ஆலோசனை பெறுங்கள்",
                recordedPainPoints: "பதிவு செய்யப்பட்ட வலிப் புள்ளிகள்:",
                painPointsOutputPlaceholder: "பதிவு செய்யப்பட்ட வலிப் புள்ளிகள் இங்கு தோன்றும்.",
                painAdviceOutputPlaceholder: "உங்கள் வலிப் புள்ளிகளின் அடிப்படையில் ஆலோசனை இங்கு தோன்றும்.",

                firstAidEmergencyLabel: "முதலுதவி & அவசர உதவி",
                firstAidEmergencySectionTitle: "முதலுதவி & அவசர உதவி",
                firstAidEmergencyDescription: "அவசர காலங்களில் முதலுதவி படிகளைப் பெறுங்கள்.",
                getFirstAidStepsBtn: "முதலுதவி படிகளைப் பெறுங்கள்",
                firstAidOutputPlaceholder: "முதலுதவி படிகள் இங்கு தோன்றும்.",

                // General messages
                errorSpeechRecognition: "பேச்சு அங்கீகாரம் ஆதரிக்கப்படவில்லை அல்லது பிழை ஏற்பட்டது.",
                errorTTS: "Text-to-Speech ஆதரிக்கப்படவில்லை அல்லது பிழை ஏற்பட்டது.",
                errorGeneratingTip: "குறிப்பை உருவாக்குவதில் பிழை ஏற்பட்டது. மீண்டும் முயற்சிக்கவும்.",
                errorFetchingVoices: "குரல்களைப் பெறுவதில் பிழை ஏற்பட்டது.",
                errorSavingJournal: "ஜர்னல் பதிவைச் சேமிப்பதில் பிழை ஏற்பட்டது.",
                errorAnalyzingMood: "மனநிலையைப் பகுப்பாய்வு செய்வதில் பிழை ஏற்பட்டது.",
                errorFetchingLocalTip: "உள்ளூர் உதவிக்குறிப்பைப் பெறுவதில் பிழை ஏற்பட்டது.",
                errorGeneratingMealPlan: "உணவுத் திட்டத்தை உருவாக்குவதில் பிழை ஏற்பட்டது.",
                errorGeneratingExerciseYoga: "உடற்பயிற்சி/யோகா பரிந்துரைகளை உருவாக்குவதில் பிழை ஏற்பட்டது.",
                errorGettingPreventionTips: "தடுப்பு குறிப்புகளைப் பெறுவதில் பிழை ஏற்பட்டது.",
                errorGeneratingChallenge: "சவாலை உருவாக்குவதில் பிழை ஏற்பட்டது.",
                errorAddingReminder: "நினைவூட்டலைச் சேர்ப்பதில் பிழை ஏற்பட்டது.",
                errorGettingPainAdvice: "வலி ஆலோசனை பெறுவதில் பிழை ஏற்பட்டது.",
                errorGettingFirstAid: "முதலுதவி படிகளைப் பெறுவதில் பிழை ஏற்பட்டது.",
                noVoicesAvailable: "குரல்கள் எதுவும் கிடைக்கவில்லை.",
                noJournalEntries: "இன்னும் ஜர்னல் பதிவுகள் இல்லை.",
                noPainPoints: "இன்னும் வலிப் புள்ளிகள் பதிவு செய்யப்படவில்லை.",
                noReminders: "இன்னும் நினைவூட்டல்கள் இல்லை.",
                selectMoodAndGratitude: "உங்கள் மனநிலையையும் நன்றியுணர்வையும் உள்ளிடவும்.",
                enterCategoryForLocalTip: "உள்ளூர் உதவிக்குறிப்பிற்கான வகையை உள்ளிடவும்.",
                enterMealPlanDetails: "உணவுத் திட்ட விவரங்களை உள்ளிடவும்.",
                enterExerciseDetails: "உடற்பயிற்சி/யோகா விவரங்களை உள்ளிடவும்.",
                enterDiseaseName: "நோய் அல்லது நிலையின் பெயரை உள்ளிடவும்.",
                enterChallengeType: "சவாலின் வகையை உள்ளிடவும்.",
                enterMedicationDetails: "மருந்து விவரங்களை உள்ளிடவும்.",
                clickOnBodyMap: "உடல் வரைபடத்தில் வலி இருக்கும் இடத்தைக் கிளிக் செய்யவும்.",
                enterEmergencyType: "அவசர நிலை வகையை உள்ளிடவும்.",
                recording: "பதிவு செய்கிறது...",
                processing: "செயலாக்குகிறது...",
                playingAudio: "ஆடியோவை இயக்குகிறது...",
                stoppedPlayingAudio: "ஆடியோ நிறுத்தி வைக்கப்பட்டது.",
                audioPlaybackError: "ஆடியோ பிளேபேக்கில் பிழை.",
                stepTrackingStarted: "படி கண்காணிப்பு தொடங்கப்பட்டது.",
                stepTrackingStopped: "படி கண்காணிப்பு நிறுத்தப்பட்டது.",
                stepTrackingNotSupported: "உங்கள் சாதனத்தில் படி கண்காணிப்பு ஆதரிக்கப்படவில்லை.",
                stepTrackingError: "படி கண்காணிப்பில் பிழை.",
            },
            en: {
                mainTitle: "Health Buddy",
                descriptionText: "A comprehensive guide to help you achieve your health goals, get wellness tips, and access various health features.",
                tipSectionTitle: "Enter Your Health Goal",
                generateBtn: "Get Tip",
                loadingText: "Generating tips...",
                tipOutputPlaceholder: "Enter your health goal and press 'Get Tip'.",
                showFeaturesLabel: "Features",
                featuresPageTitle: "Health Buddy Features",
                backToMain: "Back to Main",
                backToFeatures: "Back to Features",

                // Feature specific translations
                steps: "steps", // Added for step tracker
                moodSelectPlaceholder: "Select your mood", // Added
                gratitudeInputPlaceholder: "Write something you are grateful for...", // Added
                localTipCategoryPlaceholder: "e.g. Turmeric, Moringa, Meditation...", // Added
                dietaryPreferencePlaceholder: "Dietary preference (e.g. Vegetarian, Vegan)", // Added
                allergiesPlaceholder: "Allergies (e.g. Dairy, Peanuts)", // Added
                healthGoalMealPlaceholder: "Health goal (e.g. Weight loss, Muscle gain)", // Added
                exerciseGoalPlaceholder: "Your exercise/yoga goal (e.g. Flexibility, Strength, Meditation)", // Added
                experienceLevelPlaceholder: "Experience level (e.g. Beginner, Intermediate, Advanced)", // Added
                diseaseNamePlaceholder: "Name of disease or condition (e.g. Diabetes, Heart disease)", // Added
                challengeTypePlaceholder: "Type of challenge (e.g. 30-day water challenge, 7-day meditation challenge)", // Added
                medicationNamePlaceholder: "Medication name", // Added
                painDescriptionPlaceholder: "Pain description (for selected point)...", // Added
                emergencyTypePlaceholder: "Emergency type (e.g. Injury, Choking, Fainting)", // Added

                stepTrackerLabel: "Step Tracker",
                stepSectionTitle: "Step Tracker",
                addOneStepBtn: "Add 100 Steps",
                addSingleStepBtn: "Add 1 Step",
                toggleTrackingBtn: "Start Auto Tracking",
                resetStepsBtn: "Reset Steps",
                stepResultOutputPlaceholder: "Track your steps. Press 'Start Auto Tracking' for automatic tracking.",
                stepTipOutputPlaceholder: "Health tips based on your step count will appear here.",

                heartRateTrackerLabel: "Heart Rate Tracker",
                heartRateSectionTitle: "Heart Rate Tracker",
                simulateHeartRateBtn: "Simulate Heart Rate",
                resetHeartRateBtn: "Reset Heart Rate",
                heartRateResultOutputPlaceholder: "Simulate and monitor your heart rate.",
                heartRateTipOutputPlaceholder: "Health tips based on your heart rate will appear here.",

                waterTrackerLabel: "Water Tracker",
                waterSectionTitle: "Water Tracker",
                addWaterBtn: "Add 250ml Water",
                resetWaterBtn: "Reset Water",
                waterResultOutputPlaceholder: "Track your daily water intake.",
                waterTipOutputPlaceholder: "Health tips based on your water intake will appear here.",

                journalLabel: "Mood & Gratitude Journal",
                journalSectionTitle: "Mood & Gratitude Journal",
                journalDescription: "Record your mood and things you're grateful for, and get insights into your emotional well-being.",
                saveJournalEntryBtn: "Save Entry",
                journalEntriesOutputPlaceholder: "Your journal entries will appear here.",
                analyzeMoodJournalBtn: "Analyze Mood",
                moodAnalysisOutputPlaceholder: "Mood analysis based on your journal entries will appear here.",

                localTipsLabel: "Local Health Tips",
                localTipsSectionTitle: "Local Health Tips",
                localTipsDescription: "Get traditional and local health tips. Enter or select a category.",
                getLocalTipBtn: "Get Local Tip",
                localTipOutputPlaceholder: "Local health tips will appear here.",

                mealPlanLabel: "Meal Plan Recommendations",
                mealPlanSectionTitle: "Meal Plan Recommendations",
                mealPlanDescription: "Get personalized meal plans based on your dietary preferences, allergies, and health goals.",
                generateMealPlanBtn: "Generate Meal Plan",
                mealPlanOutputPlaceholder: "Meal plan recommendations will appear here.",

                moodAnalysisLabel: "Mood Analysis", // Redundant, but keeping for distinct icon
                exerciseYogaLabel: "Exercise & Yoga",
                exerciseYogaSectionTitle: "Exercise & Yoga Recommendations",
                exerciseYogaDescription: "Get exercise and yoga recommendations tailored to your goals and experience level.",
                generateExerciseYogaBtn: "Generate Recommendations",
                exerciseYogaOutputPlaceholder: "Exercise and yoga recommendations will appear here.",

                diseasePreventionLabel: "Disease Prevention",
                diseasePreventionSectionTitle: "Disease Prevention Tips",
                diseasePreventionDescription: "Get tips for preventing specific diseases or conditions.",
                getPreventionTipsBtn: "Get Prevention Tips",
                diseasePreventionOutputPlaceholder: "Disease prevention tips will appear here.",

                wellnessChallengeLabel: "Wellness Challenges",
                wellnessChallengeSectionTitle: "Wellness Challenges",
                wellnessChallengeDescription: "Get personalized wellness challenges to keep you motivated.",
                generateChallengeBtn: "Generate Challenge",
                wellnessChallengeOutputPlaceholder: "Wellness challenges will appear here.",

                medicationReminderLabel: "Medication Reminder",
                medicationReminderSectionTitle: "Medication Reminder",
                medicationReminderDescription: "Set your medication times and get timely reminders.",
                addMedicationReminderBtn: "Add Reminder",
                currentReminders: "Current Reminders:",
                medicationReminderOutputPlaceholder: "Your medication reminders will appear here.",
                alarmModalTitle: "Time for Medication!",
                alarmModalMessage: "It's time to take your medication: ",
                closeAlarmModalBtn: "OK",
                daily: "Daily",
                monday: "Monday",
                tuesday: "Tuesday",
                wednesday: "Wednesday",
                thursday: "Thursday",
                friday: "Friday",
                saturday: "Saturday",
                sunday: "Sunday",

                bodyPainMappingLabel: "Body Pain Mapping",
                bodyPainMappingSectionTitle: "Body Pain Mapping",
                bodyPainMappingDescription: "Click on the body map to mark your pain points, enter a description, and get advice.",
                addPainPointBtn: "Add Pain Point",
                getPainAdviceBtn: "Get Pain Advice",
                recordedPainPoints: "Recorded Pain Points:",
                painPointsOutputPlaceholder: "Recorded pain points will appear here.",
                painAdviceOutputPlaceholder: "Advice based on your pain points will appear here.",

                firstAidEmergencyLabel: "First Aid & Emergency",
                firstAidEmergencySectionTitle: "First Aid & Emergency",
                firstAidEmergencyDescription: "Get first aid steps for various emergencies.",
                getFirstAidStepsBtn: "Get First Aid Steps",
                firstAidOutputPlaceholder: "First aid steps will appear here.",

                // General messages
                errorSpeechRecognition: "Speech recognition not supported or an error occurred.",
                errorTTS: "Text-to-Speech not supported or an error occurred.",
                errorGeneratingTip: "Error generating tip. Please try again.",
                errorFetchingVoices: "Error fetching voices.",
                errorSavingJournal: "Error saving journal entry.",
                errorAnalyzingMood: "Error analyzing mood.",
                errorFetchingLocalTip: "Error fetching local tip.",
                errorGeneratingMealPlan: "Error generating meal plan.",
                errorGeneratingExerciseYoga: "Error generating exercise/yoga recommendations.",
                errorGettingPreventionTips: "Error getting prevention tips.",
                errorGeneratingChallenge: "Error generating challenge.",
                errorAddingReminder: "Error adding reminder.",
                errorGettingPainAdvice: "Error getting pain advice.",
                errorGettingFirstAid: "Error getting first aid steps.",
                noVoicesAvailable: "No voices available.",
                noJournalEntries: "No journal entries yet.",
                noPainPoints: "No pain points recorded yet.",
                noReminders: "No reminders set yet.",
                selectMoodAndGratitude: "Please select your mood and enter gratitude.",
                enterCategoryForLocalTip: "Please enter a category for local tip.",
                enterMealPlanDetails: "Please enter meal plan details.",
                enterExerciseDetails: "Please enter exercise/yoga details.",
                enterDiseaseName: "Please enter the disease or condition name.",
                enterChallengeType: "Please enter the challenge type.",
                enterMedicationDetails: "Please enter medication details.",
                clickOnBodyMap: "Please click on the body map to add a pain point.",
                enterEmergencyType: "Please enter the emergency type.",
                recording: "Recording...",
                processing: "Processing...",
                playingAudio: "Playing audio...",
                stoppedPlayingAudio: "Audio playback stopped.",
                audioPlaybackError: "Audio playback error.",
                stepTrackingStarted: "Step tracking started.",
                stepTrackingStopped: "Step tracking stopped.",
                stepTrackingNotSupported: "Step tracking not supported on your device.",
                stepTrackingError: "Error in step tracking.",
            }
        };

        // DOM Elements
        const splashScreen = document.getElementById('splashScreen');
        const mainContent = document.getElementById('mainContent');
        const languageSelect = document.getElementById('languageSelect');
        const mainTitle = document.getElementById('mainTitle');
        const descriptionText = document.getElementById('descriptionText');
        const tipSectionTitle = document.getElementById('tipSectionTitle');
        const goalInput = document.getElementById('goalInput');
        const micBtn = document.getElementById('micBtn');
        const generateBtn = document.getElementById('generateBtn');
        const aiVoiceBtn = document.getElementById('aiVoiceBtn');
        const ttsVoiceSelect = document.getElementById('ttsVoiceSelect');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const tipOutput = document.getElementById('tipOutput');
        const featuresTitle = document.getElementById('featuresTitle');
        const toggleFeaturesBtn = document.getElementById('toggleFeaturesBtn');
        const featuresContainer = document.getElementById('featuresContainer');
        const backToMainFromFeaturesContainer = document.getElementById('backToMainFromFeaturesContainer');
        const featuresPageTitle = document.getElementById('featuresPageTitle');
        const allFeatureIconsContainer = document.getElementById('allFeatureIconsContainer');

        // Feature Sections
        const stepTrackerSection = document.getElementById('stepTrackerSection');
        const currentStepsDisplay = document.getElementById('currentStepsDisplay');
        const addOneStepBtn = document.getElementById('addOneStepBtn');
        const addSingleStepBtn = document.getElementById('addSingleStepBtn'); // New button
        const toggleTrackingBtn = document.getElementById('toggleTrackingBtn');
        const resetStepsBtn = document.getElementById('resetStepsBtn');
        const stepResultOutput = document.getElementById('stepResultOutput');
        const stepTipOutput = document.getElementById('stepTipOutput');
        const stepTipAiVoiceBtn = document.getElementById('stepTipAiVoiceBtn');
        const stepTipTtsVoiceSelect = document.getElementById('stepTipTtsVoiceSelect');

        const heartRateTrackerSection = document.getElementById('heartRateTrackerSection');
        const currentHeartRateDisplay = document.getElementById('currentHeartRateDisplay');
        const simulateHeartRateBtn = document.getElementById('simulateHeartRateBtn');
        const resetHeartRateBtn = document.getElementById('resetHeartRateBtn');
        const heartRateResultOutput = document.getElementById('heartRateResultOutput');
        const heartRateTipOutput = document.getElementById('heartRateTipOutput');

        const waterTrackerSection = document.getElementById('waterTrackerSection');
        const waterIntakeDisplay = document.getElementById('waterIntakeDisplay');
        const addWaterBtn = document.getElementById('addWaterBtn');
        const resetWaterBtn = document.getElementById('resetWaterBtn');
        const waterResultOutput = document.getElementById('waterResultOutput');
        const waterTipOutput = document.getElementById('waterTipOutput');

        const journalSection = document.getElementById('journalSection');
        const moodSelect = document.getElementById('moodSelect');
        const gratitudeInput = document.getElementById('gratitudeInput');
        const saveJournalEntryBtn = document.getElementById('saveJournalEntryBtn');
        const journalEntriesOutput = document.getElementById('journalEntriesOutput');
        const analyzeMoodJournalBtn = document.getElementById('analyzeMoodJournalBtn');
        const moodAnalysisOutput = document.getElementById('moodAnalysisOutput');
        const moodAnalysisAiVoiceBtn = document.getElementById('moodAnalysisAiVoiceBtn');
        const moodAnalysisTtsVoiceSelect = document.getElementById('moodAnalysisTtsVoiceSelect');

        const localTipsSection = document.getElementById('localTipsSection');
        const localTipCategory = document.getElementById('localTipCategory');
        const localTipMicBtn = document.getElementById('localTipMicBtn');
        const localTipCategoryDropdown = document.getElementById('localTipCategoryDropdown');
        const getLocalTipBtn = document.getElementById('getLocalTipBtn');
        const localTipOutput = document.getElementById('localTipOutput');
        const localTipAiVoiceBtn = document.getElementById('localTipAiVoiceBtn');
        const localTipTtsVoiceSelect = document.getElementById('localTipTtsVoiceSelect');

        const mealPlanSection = document.getElementById('mealPlanSection');
        const dietaryPreference = document.getElementById('dietaryPreference');
        const allergies = document.getElementById('allergies');
        const healthGoalMeal = document.getElementById('healthGoalMeal');
        const generateMealPlanBtn = document.getElementById('generateMealPlanBtn');
        const mealPlanOutput = document.getElementById('mealPlanOutput');
        const mealPlanAiVoiceBtn = document.getElementById('mealPlanAiVoiceBtn');
        const mealPlanTtsVoiceSelect = document.getElementById('mealPlanTtsVoiceSelect');

        const exerciseYogaSection = document.getElementById('exerciseYogaSection');
        const exerciseGoal = document.getElementById('exerciseGoal');
        const experienceLevel = document.getElementById('experienceLevel');
        const generateExerciseYogaBtn = document.getElementById('generateExerciseYogaBtn');
        const exerciseYogaOutput = document.getElementById('exerciseYogaOutput');
        const exerciseYogaAiVoiceBtn = document.getElementById('exerciseYogaAiVoiceBtn');
        const exerciseYogaTtsVoiceSelect = document.getElementById('exerciseYogaTtsVoiceSelect');

        const diseasePreventionSection = document.getElementById('diseasePreventionSection');
        const diseaseName = document.getElementById('diseaseName');
        const getPreventionTipsBtn = document.getElementById('getPreventionTipsBtn');
        const diseasePreventionOutput = document.getElementById('diseasePreventionOutput');
        const diseasePreventionAiVoiceBtn = document.getElementById('diseasePreventionAiVoiceBtn');
        const diseasePreventionTtsVoiceSelect = document.getElementById('diseasePreventionTtsVoiceSelect');

        const wellnessChallengeSection = document.getElementById('wellnessChallengeSection');
        const challengeType = document.getElementById('challengeType');
        const generateChallengeBtn = document.getElementById('generateChallengeBtn');
        const wellnessChallengeOutput = document.getElementById('wellnessChallengeOutput');
        const wellnessChallengeAiVoiceBtn = document.getElementById('wellnessChallengeAiVoiceBtn');
        const wellnessChallengeTtsVoiceSelect = document.getElementById('wellnessChallengeTtsVoiceSelect');

        const medicationReminderSection = document.getElementById('medicationReminderSection');
        const medicationName = document.getElementById('medicationName');
        const medicationTime = document.getElementById('medicationTime');
        const medicationFrequency = document.getElementById('medicationFrequency');
        const addMedicationReminderBtn = document.getElementById('addMedicationReminderBtn');
        const remindersList = document.getElementById('remindersList');
        const medicationReminderOutput = document.getElementById('medicationReminderOutput');
        const medicationReminderAiVoiceBtn = document.getElementById('medicationReminderAiVoiceBtn');
        const medicationReminderTtsVoiceSelect = document.getElementById('medicationReminderTtsVoiceSelect');
        const alarmModal = document.getElementById('alarmModal');
        const alarmModalTitle = document.getElementById('alarmModalTitle');
        const alarmModalMessage = document.getElementById('alarmModalMessage');
        const closeAlarmModalBtn = document.getElementById('closeAlarmModalBtn');

        const bodyPainMappingSection = document.getElementById('bodyPainMappingSection');
        const bodyMapContainer = document.getElementById('bodyMapContainer');
        const bodyMapImage = document.getElementById('bodyMapImage');
        const painDescription = document.getElementById('painDescription');
        const addPainPointBtn = document.getElementById('addPainPointBtn');
        const getPainAdviceBtn = document.getElementById('getPainAdviceBtn');
        const painPointsList = document.getElementById('painPointsList');
        const painAdviceOutput = document.getElementById('painAdviceOutput');
        const bodyPainAiVoiceBtn = document.getElementById('bodyPainAiVoiceBtn');
        const bodyPainTtsVoiceSelect = document.getElementById('bodyPainTtsVoiceSelect');
        let painPoints = []; // To store pain points

        const firstAidEmergencySection = document.getElementById('firstAidEmergencySection');
        const emergencyType = document.getElementById('emergencyType');
        const getFirstAidStepsBtn = document.getElementById('getFirstAidStepsBtn');
        const firstAidOutput = document.getElementById('firstAidOutput');
        const firstAidAiVoiceBtn = document.getElementById('firstAidAiVoiceBtn');
        const firstAidTtsVoiceSelect = document.getElementById('firstAidTtsVoiceSelect');


        // Initial setup and event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in anonymously or with custom token
                if (typeof __initial_auth_token !== 'undefined') {
                    signInWithCustomToken(auth, __initial_auth_token)
                        .then(() => {
                            console.log("Signed in with custom token.");
                        })
                        .catch((error) => {
                            console.error("Error signing in with custom token:", error);
                            signInAnonymously(auth).then(() => console.log("Signed in anonymously due to custom token error.")).catch(e => console.error("Anonymous sign-in error:", e));
                        });
                } else {
                    signInAnonymously(auth)
                        .then(() => {
                            console.log("Signed in anonymously.");
                        })
                        .catch((error) => {
                            console.error("Error signing in anonymously:", error);
                        });
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        isAuthReady = true;
                        // Load persistent data here after auth is ready
                        loadSteps();
                        loadWaterIntake();
                        loadJournalEntries();
                        loadMedicationReminders();
                        loadPainPoints();
                    } else {
                        console.log("No user signed in.");
                        userId = crypto.randomUUID(); // Use a random ID for unauthenticated users for public data
                        isAuthReady = true;
                        // Load data for anonymous user if applicable, or show empty state
                        loadSteps();
                        loadWaterIntake();
                        loadJournalEntries();
                        loadMedicationReminders();
                        loadPainPoints();
                    }
                });
            } else {
                console.warn("Firebase config not found. Data persistence will not work.");
                isAuthReady = true; // Still allow app to run without persistence
                userId = crypto.randomUUID(); // Generate a local ID
                // Initialize with default empty states if no Firebase
                currentStepsDisplay.value = '0';
                waterIntakeDisplay.value = '0 ml';
                journalEntriesOutput.innerHTML = `<p>${getTranslation('noJournalEntries')}</p>`;
                remindersList.innerHTML = `<p>${getTranslation('noReminders')}</p>`;
                painPointsList.innerHTML = `<p>${getTranslation('noPainPoints')}</p>`;
            }

            // Initial language setup
            updateContent();
            populateVoices();

            // Hide splash screen after a delay
            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                splashScreen.addEventListener('transitionend', () => {
                    splashScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    document.body.classList.add('main-content-active'); // Adjust body styling for main content
                });
            }, 2000); // 2 second delay

            // Event Listeners
            languageSelect.addEventListener('change', (event) => {
                currentLanguage = event.target.value;
                updateContent();
                populateVoices();
                stopSpeechRecognition(); // Stop any ongoing recognition
                stopTTS(); // Stop any ongoing TTS
            });

            micBtn.addEventListener('click', toggleSpeechRecognition);
            generateBtn.addEventListener('click', generateTip);
            aiVoiceBtn.addEventListener('click', toggleTTS);
            ttsVoiceSelect.addEventListener('change', stopTTS); // Stop current TTS if voice changes

            toggleFeaturesBtn.addEventListener('click', () => {
                showSection('featuresContainer');
                allFeatureIconsContainer.classList.add('active'); // Ensure icons are visible
                backToMainFromFeaturesContainer.style.display = 'inline-flex'; // Show back button
            });

            // Back button from features container to main view
            backToMainFromFeaturesContainer.addEventListener('click', () => {
                showSection('initialView');
                backToMainFromFeaturesContainer.style.display = 'none'; // Hide back button
            });

            // Event listeners for feature icons
            document.querySelectorAll('.feature-icon').forEach(icon => {
                icon.addEventListener('click', (event) => {
                    const targetSectionId = event.currentTarget.dataset.section;
                    showSection(targetSectionId);
                    // Hide the main feature icons container when a specific feature is selected
                    allFeatureIconsContainer.classList.remove('active');
                });
            });

            // Event listeners for back buttons within feature sections
            document.querySelectorAll('.feature-section .back-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const targetContainerId = event.currentTarget.dataset.target;
                    showSection(targetContainerId);
                    if (targetContainerId === 'allFeatureIconsContainer') {
                        allFeatureIconsContainer.classList.add('active'); // Show icons again
                    }
                });
            });

            // Step Tracker Logic
            let steps = 0;
            let stepTrackingInterval = null;
            addOneStepBtn.addEventListener('click', () => {
                steps += 100;
                updateStepsDisplay();
                generateStepTip();
                saveSteps();
            });
            addSingleStepBtn.addEventListener('click', () => { // New button for single step
                steps += 1;
                updateStepsDisplay();
                generateStepTip();
                saveSteps();
            });
            toggleTrackingBtn.addEventListener('click', () => {
                if (stepTrackingInterval) {
                    clearInterval(stepTrackingInterval);
                    stepTrackingInterval = null;
                    toggleTrackingBtn.textContent = getTranslation('toggleTrackingBtn'); // "Start Auto Tracking"
                    stepResultOutput.innerHTML = `<p class="text-red-600">${getTranslation('stepTrackingStopped')}</p>`;
                } else {
                    // Simulate step tracking
                    stepTrackingInterval = setInterval(() => {
                        steps += Math.floor(Math.random() * 10) + 1; // Add random steps
                        updateStepsDisplay();
                        generateStepTip();
                        saveSteps();
                    }, 1000); // Add steps every second
                    toggleTrackingBtn.textContent = getTranslation('stepTrackingStopped'); // "Stop Auto Tracking"
                    stepResultOutput.innerHTML = `<p>${getTranslation('stepTrackingStarted')}</p>`;
                }
            });
            resetStepsBtn.addEventListener('click', () => {
                steps = 0;
                updateStepsDisplay();
                stepTipOutput.innerHTML = `<p>${getTranslation('stepTipOutputPlaceholder')}</p>`;
                saveSteps();
            });
            stepTipAiVoiceBtn.addEventListener('click', () => toggleTTS(stepTipOutput.textContent, stepTipTtsVoiceSelect));
            // Heart Rate Tracker Logic (Simulated)
            let heartRate = 0;
            let heartRateInterval = null;
            simulateHeartRateBtn.addEventListener('click', () => {
                if (heartRateInterval) {
                    clearInterval(heartRateInterval);
                    heartRateInterval = null;
                    simulateHeartRateBtn.textContent = getTranslation('simulateHeartRateBtn');
                    heartRateResultOutput.innerHTML = `<p class="text-red-600">${getTranslation('heartRateResultOutputPlaceholder')}</p>`;
                } else {
                    heartRateInterval = setInterval(() => {
                        heartRate = Math.floor(Math.random() * (120 - 60 + 1)) + 60; // Simulate 60-120 bpm
                        currentHeartRateDisplay.value = `${heartRate} bpm`;
                        generateHeartRateTip(heartRate);
                    }, 3000); // Update every 3 seconds
                    simulateHeartRateBtn.textContent = "Stop Simulation"; // Hardcoded for now, will be translated
                    heartRateResultOutput.innerHTML = `<p>${getTranslation('heartRateResultOutputPlaceholder')}</p>`;
                }
            });
            resetHeartRateBtn.addEventListener('click', () => {
                if (heartRateInterval) {
                    clearInterval(heartRateInterval);
                    heartRateInterval = null;
                    simulateHeartRateBtn.textContent = getTranslation('simulateHeartRateBtn');
                }
                heartRate = 0;
                currentHeartRateDisplay.value = `${heartRate} bpm`;
                heartRateTipOutput.innerHTML = `<p>${getTranslation('heartRateTipOutputPlaceholder')}</p>`;
            });

            // Water Tracker Logic
            let waterIntake = 0; // in ml
            addWaterBtn.addEventListener('click', () => {
                waterIntake += 250; // Add 250ml
                updateWaterIntakeDisplay();
                generateWaterTip();
                saveWaterIntake();
            });
            resetWaterBtn.addEventListener('click', () => {
                waterIntake = 0;
                updateWaterIntakeDisplay();
                waterTipOutput.innerHTML = `<p>${getTranslation('waterTipOutputPlaceholder')}</p>`;
                saveWaterIntake();
            });

            // Journal Logic
            let journalEntries = [];
            saveJournalEntryBtn.addEventListener('click', saveJournalEntry);
            analyzeMoodJournalBtn.addEventListener('click', analyzeMood);
            moodAnalysisAiVoiceBtn.addEventListener('click', () => toggleTTS(moodAnalysisOutput.textContent, moodAnalysisTtsVoiceSelect));

            // Local Tips Logic
            const localTipCategories = ["மஞ்சள்", "முருங்கை", "தியானம்", "யோகா", "பாரம்பரிய உணவு", "மூலிகை மருத்துவம்"];
            localTipCategory.addEventListener('input', () => {
                const query = localTipCategory.value.toLowerCase();
                const filteredCategories = localTipCategories.filter(cat => cat.toLowerCase().includes(query));
                displayDropdown(filteredCategories, localTipCategoryDropdown, localTipCategory);
            });
            localTipCategory.addEventListener('focus', () => {
                if (localTipCategory.value === "") {
                    displayDropdown(localTipCategories, localTipCategoryDropdown, localTipCategory);
                }
            });
            localTipCategory.addEventListener('blur', () => {
                setTimeout(() => {
                    localTipCategoryDropdown.classList.add('hidden');
                }, 200); // Small delay to allow click on dropdown item
            });

            localTipMicBtn.addEventListener('click', () => toggleSpeechRecognition(localTipCategory));
            getLocalTipBtn.addEventListener('click', getLocalTip);
            localTipAiVoiceBtn.addEventListener('click', () => toggleTTS(localTipOutput.textContent, localTipTtsVoiceSelect));

            // Meal Plan Logic
            generateMealPlanBtn.addEventListener('click', generateMealPlan);
            mealPlanAiVoiceBtn.addEventListener('click', () => toggleTTS(mealPlanOutput.textContent, mealPlanTtsVoiceSelect));

            // Exercise & Yoga Logic
            generateExerciseYogaBtn.addEventListener('click', generateExerciseYoga);
            exerciseYogaAiVoiceBtn.addEventListener('click', () => toggleTTS(exerciseYogaOutput.textContent, exerciseYogaTtsVoiceSelect));

            // Disease Prevention Logic
            getPreventionTipsBtn.addEventListener('click', getDiseasePreventionTips);
            diseasePreventionAiVoiceBtn.addEventListener('click', () => toggleTTS(diseasePreventionOutput.textContent, diseasePreventionTtsVoiceSelect));

            // Wellness Challenge Logic
            generateChallengeBtn.addEventListener('click', generateWellnessChallenge);
            wellnessChallengeAiVoiceBtn.addEventListener('click', () => toggleTTS(wellnessChallengeOutput.textContent, wellnessChallengeTtsVoiceSelect));

            // Medication Reminder Logic
            let medicationReminders = [];
            addMedicationReminderBtn.addEventListener('click', addMedicationReminder);
            closeAlarmModalBtn.addEventListener('click', () => {
                alarmModal.classList.remove('show');
                synthAlarm.triggerRelease(); // Stop alarm sound
            });
            medicationReminderAiVoiceBtn.addEventListener('click', () => toggleTTS(medicationReminderOutput.textContent, medicationReminderTtsVoiceSelect));
            // Set up interval to check reminders
            setInterval(checkMedicationReminders, 1000 * 60); // Check every minute

            // Body Pain Mapping Logic
            bodyMapImage.addEventListener('click', addPainPoint);
            addPainPointBtn.addEventListener('click', () => {
                const description = painDescription.value.trim();
                if (painPoints.length > 0 && description) {
                    const lastPainPoint = painPoints[painPoints.length - 1];
                    lastPainPoint.description = description;
                    renderPainPoints();
                    savePainPoints();
                    painDescription.value = ''; // Clear description after saving
                    painAdviceOutput.innerHTML = `<p>${getTranslation('painAdviceOutputPlaceholder')}</p>`;
                } else {
                    painAdviceOutput.innerHTML = `<p class="text-red-600">${getTranslation('clickOnBodyMap')}</p>`;
                }
            });
            getPainAdviceBtn.addEventListener('click', getPainAdvice);
            bodyPainAiVoiceBtn.addEventListener('click', () => toggleTTS(painAdviceOutput.textContent, bodyPainTtsVoiceSelect));

            // First Aid & Emergency Logic
            getFirstAidStepsBtn.addEventListener('click', getFirstAidSteps);
            firstAidAiVoiceBtn.addEventListener('click', () => toggleTTS(firstAidOutput.textContent, firstAidTtsVoiceSelect));

            // Initialize placeholders
            tipOutput.innerHTML = `<p>${getTranslation('tipOutputPlaceholder')}</p>`;
            stepResultOutput.innerHTML = `<p>${getTranslation('stepResultOutputPlaceholder')}</p>`;
            stepTipOutput.innerHTML = `<p>${getTranslation('stepTipOutputPlaceholder')}</p>`;
            heartRateResultOutput.innerHTML = `<p>${getTranslation('heartRateResultOutputPlaceholder')}</p>`;
            heartRateTipOutput.innerHTML = `<p>${getTranslation('heartRateTipOutputPlaceholder')}</p>`;
            waterResultOutput.innerHTML = `<p>${getTranslation('waterResultOutputPlaceholder')}</p>`;
            waterTipOutput.innerHTML = `<p>${getTranslation('waterTipOutputPlaceholder')}</p>`;
            journalEntriesOutput.innerHTML = `<p>${getTranslation('noJournalEntries')}</p>`;
            moodAnalysisOutput.innerHTML = `<p>${getTranslation('moodAnalysisOutputPlaceholder')}</p>`;
            localTipOutput.innerHTML = `<p>${getTranslation('localTipOutputPlaceholder')}</p>`;
            mealPlanOutput.innerHTML = `<p>${getTranslation('mealPlanOutputPlaceholder')}</p>`;
            exerciseYogaOutput.innerHTML = `<p>${getTranslation('exerciseYogaOutputPlaceholder')}</p>`;
            diseasePreventionOutput.innerHTML = `<p>${getTranslation('diseasePreventionOutputPlaceholder')}</p>`;
            wellnessChallengeOutput.innerHTML = `<p>${getTranslation('wellnessChallengeOutputPlaceholder')}</p>`;
            medicationReminderOutput.innerHTML = `<p>${getTranslation('medicationReminderOutputPlaceholder')}</p>`;
            painPointsList.innerHTML = `<p>${getTranslation('noPainPoints')}</p>`;
            painAdviceOutput.innerHTML = `<p>${getTranslation('painAdviceOutputPlaceholder')}</p>`;
            firstAidOutput.innerHTML = `<p>${getTranslation('firstAidOutputPlaceholder')}</p>`;
        });

        // Helper function to get translation
        function getTranslation(key) {
            return translations[currentLanguage][key] || key;
        }

        // Function to update all text content based on selected language
        function updateContent() {
            document.title = getTranslation('mainTitle') + " - " + getTranslation('descriptionText').split(' - ')[0]; // Adjust title
            mainTitle.textContent = getTranslation('mainTitle');
            descriptionText.textContent = getTranslation('descriptionText');
            tipSectionTitle.textContent = getTranslation('tipSectionTitle');
            document.querySelector('#generateBtn span').textContent = getTranslation('generateBtn');
            loadingText.textContent = getTranslation('loadingText');
            featuresTitle.textContent = getTranslation('featuresTitle');
            document.querySelector('#toggleFeaturesBtn span').textContent = getTranslation('showFeaturesLabel');
            featuresPageTitle.textContent = getTranslation('featuresPageTitle');
            document.querySelector('#backToMainFromFeaturesContainer span').textContent = getTranslation('backToMain');

            // Update feature icon labels
            document.getElementById('iconStepTracker').querySelector('.label').textContent = getTranslation('stepTrackerLabel');
            document.getElementById('iconHeartRateTracker').querySelector('.label').textContent = getTranslation('heartRateTrackerLabel');
            document.getElementById('iconWaterTracker').querySelector('.label').textContent = getTranslation('waterTrackerLabel');
            document.getElementById('iconJournal').querySelector('.label').textContent = getTranslation('journalLabel');
            document.getElementById('iconLocalTips').querySelector('.label').textContent = getTranslation('localTipsLabel');
            document.getElementById('iconMealPlan').querySelector('.label').textContent = getTranslation('mealPlanLabel');
            document.getElementById('iconMoodAnalysis').querySelector('.label').textContent = getTranslation('moodAnalysisLabel');
            document.getElementById('iconExerciseYoga').querySelector('.label').textContent = getTranslation('exerciseYogaLabel');
            document.getElementById('iconDiseasePrevention').querySelector('.label').textContent = getTranslation('diseasePreventionLabel');
            document.getElementById('iconWellnessChallenge').querySelector('.label').textContent = getTranslation('wellnessChallengeLabel');
            document.getElementById('iconMedicationReminder').querySelector('.label').textContent = getTranslation('medicationReminderLabel');
            document.getElementById('iconBodyPainMapping').querySelector('.label').textContent = getTranslation('bodyPainMappingLabel');
            document.getElementById('iconFirstAidEmergency').querySelector('.label').textContent = getTranslation('firstAidEmergencyLabel');

            // Update feature section specific texts
            document.querySelectorAll('.feature-section .back-button span').forEach(span => {
                span.textContent = getTranslation('backToFeatures');
            });

            // Step Tracker
            document.getElementById('stepSectionTitle').textContent = getTranslation('stepSectionTitle');
            addOneStepBtn.textContent = getTranslation('addOneStepBtn');
            addSingleStepBtn.textContent = getTranslation('addSingleStepBtn'); // New button
            toggleTrackingBtn.textContent = stepTrackingInterval ? getTranslation('stepTrackingStopped') : getTranslation('toggleTrackingBtn');
            resetStepsBtn.textContent = getTranslation('resetStepsBtn');
            stepResultOutput.innerHTML = `<p>${getTranslation('stepResultOutputPlaceholder')}</p>`;
            stepTipOutput.innerHTML = `<p>${getTranslation('stepTipOutputPlaceholder')}</p>`;
            // Update step display with translated 'steps'
            currentStepsDisplay.value = `${currentSteps} ${getTranslation('steps')}`;


            // Heart Rate Tracker
            document.getElementById('heartRateSectionTitle').textContent = getTranslation('heartRateSectionTitle');
            simulateHeartRateBtn.textContent = heartRateInterval ? "Stop Simulation" : getTranslation('simulateHeartRateBtn');
            resetHeartRateBtn.textContent = getTranslation('resetHeartRateBtn');
            heartRateResultOutput.innerHTML = `<p>${getTranslation('heartRateResultOutputPlaceholder')}</p>`;
            heartRateTipOutput.innerHTML = `<p>${getTranslation('heartRateTipOutputPlaceholder')}</p>`;

            // Water Tracker
            document.getElementById('waterSectionTitle').textContent = getTranslation('waterSectionTitle');
            addWaterBtn.textContent = getTranslation('addWaterBtn');
            resetWaterBtn.textContent = getTranslation('resetWaterBtn');
            waterResultOutput.innerHTML = `<p>${getTranslation('waterResultOutputPlaceholder')}</p>`;
            waterTipOutput.innerHTML = `<p>${getTranslation('waterTipOutputPlaceholder')}</p>`;

            // Journal
            document.getElementById('journalSectionTitle').textContent = getTranslation('journalSectionTitle');
            document.getElementById('journalDescription').textContent = getTranslation('journalDescription');
            saveJournalEntryBtn.textContent = getTranslation('saveJournalEntryBtn');
            journalEntriesOutput.innerHTML = `<p>${getTranslation('noJournalEntries')}</p>`;
            analyzeMoodJournalBtn.querySelector('span').textContent = getTranslation('analyzeMoodJournalBtn');
            moodAnalysisOutput.innerHTML = `<p>${getTranslation('moodAnalysisOutputPlaceholder')}</p>`;
            // Update mood select options
            moodSelect.options[0].textContent = getTranslation('moodSelectPlaceholder');
            moodSelect.options[1].textContent = getTranslation('happy');
            moodSelect.options[2].textContent = getTranslation('neutral');
            moodSelect.options[3].textContent = getTranslation('sad');
            moodSelect.options[4].textContent = getTranslation('stressed');
            moodSelect.options[5].textContent = getTranslation('energetic');
            gratitudeInput.placeholder = getTranslation('gratitudeInputPlaceholder');

            // Local Tips
            document.getElementById('localTipsSectionTitle').textContent = getTranslation('localTipsSectionTitle');
            document.getElementById('localTipsDescription').textContent = getTranslation('localTipsDescription');
            localTipCategory.placeholder = getTranslation('localTipCategoryPlaceholder');
            document.querySelector('#getLocalTipBtn span').textContent = getTranslation('getLocalTipBtn');
            localTipOutput.innerHTML = `<p>${getTranslation('localTipOutputPlaceholder')}</p>`;

            // Meal Plan
            document.getElementById('mealPlanSectionTitle').textContent = getTranslation('mealPlanSectionTitle');
            document.getElementById('mealPlanDescription').textContent = getTranslation('mealPlanDescription');
            dietaryPreference.placeholder = getTranslation('dietaryPreferencePlaceholder');
            allergies.placeholder = getTranslation('allergiesPlaceholder');
            healthGoalMeal.placeholder = getTranslation('healthGoalMealPlaceholder');
            document.querySelector('#generateMealPlanBtn span').textContent = getTranslation('generateMealPlanBtn');
            mealPlanOutput.innerHTML = `<p>${getTranslation('mealPlanOutputPlaceholder')}</p>`;

            // Exercise & Yoga
            document.getElementById('exerciseYogaSectionTitle').textContent = getTranslation('exerciseYogaSectionTitle');
            document.getElementById('exerciseYogaDescription').textContent = getTranslation('exerciseYogaDescription');
            exerciseGoal.placeholder = getTranslation('exerciseGoalPlaceholder');
            experienceLevel.placeholder = getTranslation('experienceLevelPlaceholder');
            document.querySelector('#generateExerciseYogaBtn span').textContent = getTranslation('generateExerciseYogaBtn');
            exerciseYogaOutput.innerHTML = `<p>${getTranslation('exerciseYogaOutputPlaceholder')}</p>`;

            // Disease Prevention
            document.getElementById('diseasePreventionSectionTitle').textContent = getTranslation('diseasePreventionSectionTitle');
            document.getElementById('diseasePreventionDescription').textContent = getTranslation('diseasePreventionDescription');
            diseaseName.placeholder = getTranslation('diseaseNamePlaceholder');
            document.querySelector('#getPreventionTipsBtn span').textContent = getTranslation('getPreventionTipsBtn');
            diseasePreventionOutput.innerHTML = `<p>${getTranslation('diseasePreventionOutputPlaceholder')}</p>`;

            // Wellness Challenge
            document.getElementById('wellnessChallengeSectionTitle').textContent = getTranslation('wellnessChallengeSectionTitle');
            document.getElementById('wellnessChallengeDescription').textContent = getTranslation('wellnessChallengeDescription');
            challengeType.placeholder = getTranslation('challengeTypePlaceholder');
            document.querySelector('#generateChallengeBtn span').textContent = getTranslation('generateChallengeBtn');
            wellnessChallengeOutput.innerHTML = `<p>${getTranslation('wellnessChallengeOutputPlaceholder')}</p>`;

            // Medication Reminder
            document.getElementById('medicationReminderSectionTitle').textContent = getTranslation('medicationReminderSectionTitle');
            document.getElementById('medicationReminderDescription').textContent = getTranslation('medicationReminderDescription');
            medicationName.placeholder = getTranslation('medicationNamePlaceholder');
            document.querySelector('#addMedicationReminderBtn').textContent = getTranslation('addMedicationReminderBtn');
            document.querySelector('#medicationRemindersList h3').textContent = getTranslation('currentReminders');
            medicationReminderOutput.innerHTML = `<p>${getTranslation('medicationReminderOutputPlaceholder')}</p>`;
            alarmModalTitle.textContent = getTranslation('alarmModalTitle');
            closeAlarmModalBtn.textContent = getTranslation('closeAlarmModalBtn');
            // Update frequency options
            const freqOptions = medicationFrequency.options;
            freqOptions[0].textContent = getTranslation('daily');
            freqOptions[1].textContent = getTranslation('monday');
            freqOptions[2].textContent = getTranslation('tuesday');
            freqOptions[3].textContent = getTranslation('wednesday');
            freqOptions[4].textContent = getTranslation('thursday');
            freqOptions[5].textContent = getTranslation('friday');
            freqOptions[6].textContent = getTranslation('saturday');
            freqOptions[7].textContent = getTranslation('sunday');


            // Body Pain Mapping
            document.getElementById('bodyPainMappingSectionTitle').textContent = getTranslation('bodyPainMappingSectionTitle');
            document.getElementById('bodyPainMappingDescription').textContent = getTranslation('bodyPainMappingDescription');
            painDescription.placeholder = getTranslation('painDescriptionPlaceholder');
            document.querySelector('#addPainPointBtn').textContent = getTranslation('addPainPointBtn');
            document.querySelector('#getPainAdviceBtn span').textContent = getTranslation('getPainAdviceBtn');
            document.querySelector('#painPointsOutput h3').textContent = getTranslation('recordedPainPoints');
            painPointsList.innerHTML = `<p>${getTranslation('noPainPoints')}</p>`;
            painAdviceOutput.innerHTML = `<p>${getTranslation('painAdviceOutputPlaceholder')}</p>`;

            // First Aid & Emergency
            document.getElementById('firstAidEmergencySectionTitle').textContent = getTranslation('firstAidEmergencySectionTitle');
            document.getElementById('firstAidEmergencyDescription').textContent = getTranslation('firstAidEmergencyDescription');
            emergencyType.placeholder = getTranslation('emergencyTypePlaceholder');
            document.querySelector('#getFirstAidStepsBtn span').textContent = getTranslation('getFirstAidStepsBtn');
            firstAidOutput.innerHTML = `<p>${getTranslation('firstAidOutputPlaceholder')}</p>`;

            // Re-render dynamic content (like journal entries, reminders, pain points) to apply new language
            renderJournalEntries();
            renderMedicationReminders();
            renderPainPoints();
        }

        // Function to show a specific section and hide others
        function showSection(sectionId) {
            const sections = document.querySelectorAll('#featuresContainer > div, #initialView');
            sections.forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });

            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
                currentActiveSection = sectionId;
                // Adjust body class for scrolling if not initial view
                if (sectionId !== 'initialView') {
                    document.body.classList.add('main-content-active');
                } else {
                    document.body.classList.remove('main-content-active');
                }

                // Manage back buttons visibility
                if (sectionId === 'allFeatureIconsContainer') {
                    backToMainFromFeaturesContainer.style.display = 'inline-flex';
                } else if (sectionId === 'initialView') {
                    backToMainFromFeaturesContainer.style.display = 'none';
                } else {
                    // For individual feature sections, show their specific back button
                    const backButton = targetSection.querySelector('.back-button');
                    if (backButton) {
                        backButton.style.display = 'inline-flex';
                    }
                    backToMainFromFeaturesContainer.style.display = 'none'; // Hide the main features back button
                }
            }
        }


        // Speech Recognition Functions
        function toggleSpeechRecognition(inputElement = goalInput) {
            if (!('webkitSpeechRecognition' in window)) {
                console.error(getTranslation('errorSpeechRecognition'));
                alert(getTranslation('errorSpeechRecognition'));
                return;
            }

            if (isRecording) {
                stopSpeechRecognition();
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = currentLanguage === 'ta' ? 'ta-IN' : 'en-US';

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('recording');
                showLoading(getTranslation('recording'));
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                inputElement.value = transcript;
                hideLoading();
                stopSpeechRecognition();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                hideLoading();
                alert(`${getTranslation('errorSpeechRecognition')}: ${event.error}`);
                stopSpeechRecognition();
            };

            recognition.onend = () => {
                isRecording = false;
                micBtn.classList.remove('recording');
                hideLoading();
            };

            recognition.start();
        }

        function stopSpeechRecognition() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
            isRecording = false;
            micBtn.classList.remove('recording');
            hideLoading();
        }

        // Text-to-Speech Functions
        function populateVoices() {
            const voices = synth.getVoices();
            ttsVoiceSelect.innerHTML = '';
            stepTipTtsVoiceSelect.innerHTML = '';
            moodAnalysisTtsVoiceSelect.innerHTML = '';
            localTipTtsVoiceSelect.innerHTML = '';
            mealPlanTtsVoiceSelect.innerHTML = '';
            exerciseYogaTtsVoiceSelect.innerHTML = '';
            diseasePreventionTtsVoiceSelect.innerHTML = '';
            wellnessChallengeTtsVoiceSelect.innerHTML = '';
            medicationReminderTtsVoiceSelect.innerHTML = '';
            bodyPainTtsVoiceSelect.innerHTML = '';
            firstAidTtsVoiceSelect.innerHTML = '';

            const filteredVoices = voices.filter(voice => voice.lang.startsWith(currentLanguage));

            if (filteredVoices.length === 0) {
                console.warn(getTranslation('noVoicesAvailable'));
                aiVoiceBtn.style.display = 'none';
                ttsVoiceSelect.style.display = 'none';
                // Hide all other TTS buttons and selects
                document.querySelectorAll('.ai-voice-button, .tts-voice-selector').forEach(el => el.style.display = 'none');
                return;
            } else {
                aiVoiceBtn.style.display = 'inline-flex';
                ttsVoiceSelect.style.display = 'inline-block';
                document.querySelectorAll('.ai-voice-button, .tts-voice-selector').forEach(el => el.style.display = 'inline-flex'); // Show them if voices are available
            }

            filteredVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.name;
                ttsVoiceSelect.appendChild(option);

                // Clone options for other TTS selectors
                stepTipTtsVoiceSelect.appendChild(option.cloneNode(true));
                moodAnalysisTtsVoiceSelect.appendChild(option.cloneNode(true));
                localTipTtsVoiceSelect.appendChild(option.cloneNode(true));
                mealPlanTtsVoiceSelect.appendChild(option.cloneNode(true));
                exerciseYogaTtsVoiceSelect.appendChild(option.cloneNode(true));
                diseasePreventionTtsVoiceSelect.appendChild(option.cloneNode(true));
                wellnessChallengeTtsVoiceSelect.appendChild(option.cloneNode(true));
                medicationReminderTtsVoiceSelect.appendChild(option.cloneNode(true));
                bodyPainTtsVoiceSelect.appendChild(option.cloneNode(true));
                firstAidTtsVoiceSelect.appendChild(option.cloneNode(true));
            });
        }

        function toggleTTS(textToSpeak, voiceSelectElement = ttsVoiceSelect) {
            if (!synth) {
                console.error(getTranslation('errorTTS'));
                alert(getTranslation('errorTTS'));
                return;
            }

            if (synth.speaking && currentUtterance) {
                synth.cancel(); // Stop current speech
                currentUtterance = null;
                console.log(getTranslation('stoppedPlayingAudio'));
                return;
            }

            if (!textToSpeak) {
                console.warn("No text to speak.");
                return;
            }

            currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
            const selectedVoiceName = voiceSelectElement.value;
            const voices = synth.getVoices();
            currentUtterance.voice = voices.find(voice => voice.name === selectedVoiceName) || voices.find(voice => voice.lang.startsWith(currentLanguage));

            currentUtterance.onerror = (event) => {
                console.error('SpeechSynthesisUtterance.onerror', event);
                alert(getTranslation('audioPlaybackError'));
            };

            currentUtterance.onstart = () => {
                console.log(getTranslation('playingAudio'));
            };

            currentUtterance.onend = () => {
                currentUtterance = null;
                console.log(getTranslation('stoppedPlayingAudio'));
            };

            synth.speak(currentUtterance);
        }

        function stopTTS() {
            if (synth.speaking) {
                synth.cancel();
                currentUtterance = null;
            }
        }

        // Loading indicator functions
        function showLoading(message) {
            loading.style.display = 'flex';
            loadingText.textContent = message;
        }

        function hideLoading() {
            loading.style.display = 'none';
            loadingText.textContent = '';
        }

        // AI Model Call (Gemini API)
        async function callGeminiAPI(prompt, outputElement, loadingMsg) {
            showLoading(loadingMsg);
            outputElement.innerHTML = ''; // Clear previous output
            
            // Get the specific TTS button and select for this output element
            const currentTTSBtn = outputElement.closest('.feature-section')?.querySelector('.ai-voice-button') || aiVoiceBtn;
            const currentTTSSelect = outputElement.closest('.feature-section')?.querySelector('.tts-voice-selector') || ttsVoiceSelect;
            
            currentTTSBtn.style.display = 'none'; // Hide before generation
            currentTTSSelect.style.display = 'none';
            stopTTS(); // Stop any ongoing TTS

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this in runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                hideLoading();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    outputElement.innerHTML = `<p>${text}</p>`;
                    // Show TTS options for the generated text if voices are available
                    if (synth.getVoices().filter(voice => voice.lang.startsWith(currentLanguage)).length > 0) {
                        currentTTSBtn.style.display = 'inline-flex';
                        currentTTSSelect.style.display = 'inline-block';
                        currentTTSBtn.onclick = () => toggleTTS(text, currentTTSSelect);
                    }
                } else {
                    outputElement.innerHTML = `<p class="text-red-600">${getTranslation('errorGeneratingTip')}</p>`;
                    console.error("Unexpected API response structure:", result);
                }
            } catch (error) {
                hideLoading();
                outputElement.innerHTML = `<p class="text-red-600">${getTranslation('errorGeneratingTip')}</p>`;
                console.error("Error calling Gemini API:", error);
            }
        }

        // Main Tip Generation
        async function generateTip() {
            const goal = goalInput.value.trim();
            if (!goal) {
                tipOutput.innerHTML = `<p class="text-red-600">${getTranslation('tipOutputPlaceholder')}</p>`;
                return;
            }
            const prompt = `Provide a health tip in ${currentLanguage === 'ta' ? 'Tamil' : 'English'} for the goal: "${goal}". Make it concise and actionable.`;
            await callGeminiAPI(prompt, tipOutput, getTranslation('loadingText'));
        }

        // Step Tracker Functions (with Firebase Persistence)
        let currentSteps = 0;
        function updateStepsDisplay() {
            currentStepsDisplay.value = `${currentSteps} ${getTranslation('steps')}`;
        }

        async function generateStepTip() {
            const prompt = `Based on a step count of ${currentSteps} steps, provide a short, encouraging health tip in ${currentLanguage === 'ta' ? 'Tamil' : 'English'}. If the steps are low (e.g., < 2000), encourage more movement. If moderate (e.g., 2000-5000), suggest increasing. If high (e.g., > 5000), praise and suggest consistency.`;
            await callGeminiAPI(prompt, stepTipOutput, getTranslation('loadingText'));
        }

        async function saveSteps() {
            if (!isAuthReady) return; // Wait for auth to be ready
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/health_data`, 'steps');
                await setDoc(docRef, { count: currentSteps, timestamp: new Date() }, { merge: true });
                console.log("Steps saved successfully!");
            } catch (e) {
                console.error("Error saving steps: ", e);
            }
        }

        async function loadSteps() {
            if (!isAuthReady) return; // Wait for auth to be ready
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/health_data`, 'steps');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    currentSteps = docSnap.data().count || 0;
                    updateStepsDisplay();
                    console.log("Steps loaded successfully:", currentSteps);
                } else {
                    console.log("No steps data found for this user.");
                    currentSteps = 0;
                    updateStepsDisplay();
                }
            } catch (e) {
                console.error("Error loading steps: ", e);
            }
        }

        // Heart Rate Tracker Functions (Simulated)
        async function generateHeartRateTip(hr) {
            let tip = "";
            if (hr === 0) {
                tip = getTranslation('heartRateTipOutputPlaceholder');
            } else if (hr < 60) {
                tip = `உங்கள் இதயத் துடிப்பு ${hr} bpm ஆக உள்ளது. இது சாதாரணமாக இருப்பதை விட குறைவாக இருக்கலாம். மருத்துவரை அணுகவும்.`; // Tamil
                if (currentLanguage === 'en') tip = `Your heart rate is ${hr} bpm, which might be lower than normal. Consult a doctor.`;
            } else if (hr >= 60 && hr <= 100) {
                tip = `உங்கள் இதயத் துடிப்பு ${hr} bpm ஆக உள்ளது. இது ஆரோக்கியமான வரம்பில் உள்ளது. வாழ்த்துக்கள்!`; // Tamil
                if (currentLanguage === 'en') tip = `Your heart rate is ${hr} bpm, which is in a healthy range. Great!`;
            } else {
                tip = `உங்கள் இதயத் துடிப்பு ${hr} bpm ஆக உள்ளது. இது சாதாரணமாக இருப்பதை விட அதிகமாக இருக்கலாம். ஓய்வெடுத்து, தேவைப்பட்டால் மருத்துவரை அணுகவும்.`; // Tamil
                if (currentLanguage === 'en') tip = `Your heart rate is ${hr} bpm, which might be higher than normal. Rest and consult a doctor if needed.`;
            }
            heartRateTipOutput.innerHTML = `<p>${tip}</p>`;
        }

        // Water Tracker Functions (with Firebase Persistence)
        let currentWaterIntake = 0; // in ml
        function updateWaterIntakeDisplay() {
            waterIntakeDisplay.value = `${currentWaterIntake} ml`;
        }

        async function generateWaterTip() {
            const prompt = `Based on a water intake of ${currentWaterIntake} ml, provide a short health tip in ${currentLanguage === 'ta' ? 'Tamil' : 'English'}. If intake is low (e.g., < 1500ml), encourage more. If moderate (e.g., 1500-2500ml), suggest consistency. If high (e.g., > 2500ml), praise and remind not to overdo it.`;
            await callGeminiAPI(prompt, waterTipOutput, getTranslation('loadingText'));
        }

        async function saveWaterIntake() {
            if (!isAuthReady) return;
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/health_data`, 'water_intake');
                await setDoc(docRef, { amount: currentWaterIntake, timestamp: new Date() }, { merge: true });
                console.log("Water intake saved successfully!");
            } catch (e) {
                console.error("Error saving water intake: ", e);
            }
        }

        async function loadWaterIntake() {
            if (!isAuthReady) return;
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/health_data`, 'water_intake');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    currentWaterIntake = docSnap.data().amount || 0;
                    updateWaterIntakeDisplay();
                    console.log("Water intake loaded successfully:", currentWaterIntake);
                } else {
                    console.log("No water intake data found for this user.");
                    currentWaterIntake = 0;
                    updateWaterIntakeDisplay();
                }
            } catch (e) {
                console.error("Error loading water intake: ", e);
            }
        }

        // Journal Functions (with Firebase Persistence)
        async function saveJournalEntry() {
            if (!isAuthReady) return;
            const mood = moodSelect.value;
            const gratitude = gratitudeInput.value.trim();

            if (!mood || !gratitude) {
                journalEntriesOutput.innerHTML = `<p class="text-red-600">${getTranslation('selectMoodAndGratitude')}</p>`;
                return;
            }

            showLoading(getTranslation('processing'));
            try {
                await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/journal_entries`), {
                    mood: mood,
                    gratitude: gratitude,
                    timestamp: new Date()
                });
                console.log("Journal entry saved!");
                moodSelect.value = '';
                gratitudeInput.value = '';
                await loadJournalEntries(); // Reload entries after saving
                hideLoading();
            } catch (e) {
                console.error("Error adding document: ", e);
                journalEntriesOutput.innerHTML = `<p class="text-red-600">${getTranslation('errorSavingJournal')}</p>`;
                hideLoading();
            }
        }

        async function loadJournalEntries() {
            if (!isAuthReady) return;
            journalEntries = []; // Clear current entries
            try {
                const q = query(collection(db, `artifacts/${__app_id}/users/${userId}/journal_entries`));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    journalEntries.push({ id: doc.id, ...doc.data() });
                });
                renderJournalEntries();
                console.log("Journal entries loaded.");
            } catch (e) {
                console.error("Error loading journal entries: ", e);
                journalEntriesOutput.innerHTML = `<p class="text-red-600">${getTranslation('errorLoadingJournalEntries') || 'Error loading journal entries.'}</p>`;
            }
        }

        function renderJournalEntries() {
            if (journalEntries.length === 0) {
                journalEntriesOutput.innerHTML = `<p>${getTranslation('noJournalEntries')}</p>`;
                return;
            }
            let html = `<h3 class="text-xl font-semibold text-gray-700 mb-2">${getTranslation('journalEntriesOutputPlaceholder') || 'Your Journal Entries:'}</h3><ul class="list-disc pl-5">`;
            journalEntries.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate()); // Sort by newest first
            journalEntries.forEach(entry => {
                const date = entry.timestamp.toDate().toLocaleString(currentLanguage === 'ta' ? 'ta-IN' : 'en-US', { dateStyle: 'medium', timeStyle: 'short' });
                html += `<li class="mb-2"><strong>${date}</strong> - ${getTranslation(entry.mood)}: ${entry.gratitude}</li>`;
            });
            html += `</ul>`;
            journalEntriesOutput.innerHTML = html;
        }

        async function analyzeMood() {
            if (journalEntries.length === 0) {
                moodAnalysisOutput.innerHTML = `<p class="text-red-600">${getTranslation('noJournalEntries')}</p>`;
                return;
            }

            const journalText = journalEntries.map(entry => `${getTranslation(entry.mood)}: ${entry.gratitude}`).join("\n");
            const prompt = `Analyze the following journal entries for overall mood and provide a concise summary and a positive, actionable suggestion in ${currentLanguage === 'ta' ? 'Tamil' : 'English'}. Focus on trends and encouragement.\n\nJournal Entries:\n${journalText}`;
            await callGeminiAPI(prompt, moodAnalysisOutput, getTranslation('processing'));
        }

        // Local Tips Functions
        function displayDropdown(items, dropdownElement, inputElement) {
            dropdownElement.innerHTML = '';
            if (items.length === 0) {
                dropdownElement.classList.add('hidden');
                return;
            }
            items.forEach(item => {
                const div = document.createElement('div');
                div.textContent = item;
                div.addEventListener('mousedown', (e) => { // Use mousedown to prevent blur
                    e.preventDefault();
                    inputElement.value = item;
                    dropdownElement.classList.add('hidden');
                });
                dropdownElement.appendChild(div);
            });
            dropdownElement.classList.remove('hidden');
        }

        async function getLocalTip() {
            const category = localTipCategory.value.trim();
            if (!category) {
                localTipOutput.innerHTML = `<p class="text-red-600">${getTranslation('enterCategoryForLocalTip')}</p>`;
                return;
            }
            const prompt = `Provide a traditional or local health tip related to "${category}" in ${currentLanguage === 'ta' ? 'Tamil' : 'English'}. Explain its benefits briefly.`;
            await callGeminiAPI(prompt, localTipOutput, getTranslation('loadingText'));
        }

        // Meal Plan Functions
        async function generateMealPlan() {
            const dietaryPref = dietaryPreference.value.trim();
            const allergyInfo = allergies.value.trim();
            const healthGoal = healthGoalMeal.value.trim();

            if (!dietaryPref && !allergyInfo && !healthGoal) {
                mealPlanOutput.innerHTML = `<p class="text-red-600">${getTranslation('enterMealPlanDetails')}</p>`;
                return;
            }

            let prompt = `Generate a simple 3-day meal plan in ${currentLanguage === 'ta' ? 'Tamil' : 'English'}.`;
            if (dietaryPref) prompt += ` Dietary preference: ${dietaryPref}.`;
            if (allergyInfo) prompt += ` Allergies: ${allergyInfo}.`;
            if (healthGoal) prompt += ` Health goal: ${healthGoal}.`;
            prompt += ` Include breakfast, lunch, and dinner for each day.`;

            await callGeminiAPI(prompt, mealPlanOutput, getTranslation('loadingText'));
        }

        // Exercise & Yoga Functions
        async function generateExerciseYoga() {
            const goal = exerciseGoal.value.trim();
            const level = experienceLevel.value.trim();

            if (!goal && !level) {
                exerciseYogaOutput.innerHTML = `<p class="text-red-600">${getTranslation('enterExerciseDetails')}</p>`;
                return;
            }

            let prompt = `Provide 3-5 exercise or yoga recommendations in ${currentLanguage === 'ta' ? 'Tamil' : 'English'}.`;
            if (goal) prompt += ` Goal: ${goal}.`;
            if (level) prompt += ` Experience level: ${level}.`;
            prompt += ` Include brief instructions for each.`;

            await callGeminiAPI(prompt, exerciseYogaOutput, getTranslation('loadingText'));
        }

        // Disease Prevention Functions
        async function getDiseasePreventionTips() {
            const disease = diseaseName.value.trim();
            if (!disease) {
                diseasePreventionOutput.innerHTML = `<p class="text-red-600">${getTranslation('enterDiseaseName')}</p>`;
                return;
            }
            const prompt = `Provide practical tips for preventing "${disease}" in ${currentLanguage === 'ta' ? 'Tamil' : 'English'}. Focus on lifestyle, diet, and general health practices.`;
            await callGeminiAPI(prompt, diseasePreventionOutput, getTranslation('loadingText'));
        }

        // Wellness Challenge Functions
        async function generateWellnessChallenge() {
            const challenge = challengeType.value.trim();
            if (!challenge) {
                wellnessChallengeOutput.innerHTML = `<p class="text-red-600">${getTranslation('enterChallengeType')}</p>`;
                return;
            }
            const prompt = `Create a fun and motivating wellness challenge for "${challenge}" in ${currentLanguage === 'ta' ? 'Tamil' : 'English'}. Suggest duration and simple daily tasks.`;
            await callGeminiAPI(prompt, wellnessChallengeOutput, getTranslation('loadingText'));
        }

        // Medication Reminder Functions (with Firebase Persistence)
        let activeReminders = []; // Store reminder intervals/timeouts

        async function addMedicationReminder() {
            if (!isAuthReady) return;
            const name = medicationName.value.trim();
            const time = medicationTime.value;
            const frequency = medicationFrequency.value;

            if (!name || !time || !frequency) {
                medicationReminderOutput.innerHTML = `<p class="text-red-600">${getTranslation('enterMedicationDetails')}</p>`;
                return;
            }

            showLoading(getTranslation('processing'));
            try {
                const newReminder = {
                    name: name,
                    time: time,
                    frequency: frequency,
                    timestamp: new Date()
                };
                await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/medication_reminders`), newReminder);
                console.log("Medication reminder saved!");
                medicationName.value = '';
                medicationTime.value = '';
                medicationFrequency.value = 'daily';
                await loadMedicationReminders(); // Reload reminders
                hideLoading();
            } catch (e) {
                console.error("Error adding reminder: ", e);
                medicationReminderOutput.innerHTML = `<p class="text-red-600">${getTranslation('errorAddingReminder')}</p>`;
                hideLoading();
            }
        }

        async function loadMedicationReminders() {
            if (!isAuthReady) return;
            medicationReminders = []; // Clear current reminders
            try {
                const q = query(collection(db, `artifacts/${__app_id}/users/${userId}/medication_reminders`));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    medicationReminders.push({ id: doc.id, ...doc.data() });
                });
                renderMedicationReminders();
                console.log("Medication reminders loaded.");
            } catch (e) {
                console.error("Error loading medication reminders: ", e);
                remindersList.innerHTML = `<p class="text-red-600">${getTranslation('errorLoadingReminders') || 'Error loading reminders.'}</p>`;
            }
        }

        function renderMedicationReminders() {
            if (medicationReminders.length === 0) {
                remindersList.innerHTML = `<p>${getTranslation('noReminders')}</p>`;
                return;
            }
            let html = '';
            medicationReminders.forEach(reminder => {
                const freqText = getTranslation(reminder.frequency);
                html += `<li class="mb-1">${reminder.name} - ${reminder.time} (${freqText}) <button data-id="${reminder.id}" class="text-red-500 hover:text-red-700 ml-2 text-sm">X</button></li>`;
            });
            remindersList.innerHTML = html;

            document.querySelectorAll('#remindersList button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const reminderId = e.target.dataset.id;
                    // Replaced alert with console.log for silent operation as per instructions
                    // In a real app, you'd use a custom modal for confirmation
                    console.log(`Attempting to delete reminder with ID: ${reminderId}`);
                    await deleteMedicationReminder(reminderId);
                });
            });
        }

        async function deleteMedicationReminder(id) {
            if (!isAuthReady) return;
            try {
                await deleteDoc(doc(db, `artifacts/${__app_id}/users/${userId}/medication_reminders`, id));
                console.log("Reminder deleted!");
                await loadMedicationReminders(); // Reload reminders
            } catch (e) {
                console.error("Error deleting reminder: ", e);
                medicationReminderOutput.innerHTML = `<p class="text-red-600">${getTranslation('errorDeletingReminder') || 'Error deleting reminder.'}</p>`;
            }
        }

        function checkMedicationReminders() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentDay = now.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase(); // e.g., "monday"

            medicationReminders.forEach(reminder => {
                const [reminderHour, reminderMinute] = reminder.time.split(':').map(Number);
                const reminderFreq = reminder.frequency;

                const isTimeMatch = (currentHour === reminderHour && currentMinute === reminderMinute);
                const isDayMatch = (reminderFreq === 'daily' || reminderFreq === currentDay);

                if (isTimeMatch && isDayMatch) {
                    // Prevent multiple alarms for the same minute
                    const lastTriggered = reminder.lastTriggered || 0;
                    if (now.getTime() - lastTriggered > (60 * 1000)) { // If not triggered in the last minute
                        showAlarmModal(reminder.name);
                        reminder.lastTriggered = now.getTime(); // Update last triggered time
                        // Optionally, update in Firestore if you want persistent "last triggered"
                        // updateDoc(doc(db, `artifacts/${__app_id}/users/${userId}/medication_reminders`, reminder.id), { lastTriggered: new Date() });
                    }
                }
            });
        }

        function showAlarmModal(medicationName) {
            alarmModalMessage.textContent = `${getTranslation('alarmModalMessage')} ${medicationName}`;
            alarmModal.classList.add('show');
            synthAlarm.triggerAttackRelease("C4", "8n"); // Play a simple sound
        }


        // Body Pain Mapping Functions (with Firebase Persistence)
        let selectedPainPoint = null; // Stores the currently selected dot object

        function addPainPoint(event) {
            const rect = bodyMapImage.getBoundingClientRect();
            const x = (event.clientX - rect.left) / rect.width; // Normalized X (0-1)
            const y = (event.clientY - rect.top) / rect.height; // Normalized Y (0-1)

            // Remove 'selected' class from previous dots
            document.querySelectorAll('.pain-dot').forEach(dot => dot.classList.remove('selected'));

            const newDot = {
                id: Date.now().toString(), // Unique ID for the dot
                x: x,
                y: y,
                description: '', // Will be filled by painDescription input
                timestamp: new Date()
            };
            painPoints.push(newDot);
            selectedPainPoint = newDot; // Set the newly added dot as selected
            renderPainPoints();
            painDescription.value = ''; // Clear description for new entry
            painDescription.focus(); // Focus on description input
            painAdviceOutput.innerHTML = `<p>${getTranslation('painAdviceOutputPlaceholder')}</p>`;
        }

        function renderPainPoints() {
            // Remove existing dots
            document.querySelectorAll('.pain-dot').forEach(dot => dot.remove());

            if (painPoints.length === 0) {
                painPointsList.innerHTML = `<p>${getTranslation('noPainPoints')}</p>`;
                return;
            }

            let html = '';
            painPoints.forEach(point => {
                const dot = document.createElement('div');
                dot.classList.add('pain-dot');
                dot.style.left = `${point.x * 100}%`;
                dot.style.top = `${point.y * 100}%`;
                dot.dataset.id = point.id;
                dot.title = point.description || 'No description'; // Tooltip
                if (selectedPainPoint && selectedPainPoint.id === point.id) {
                    dot.classList.add('selected');
                }
                dot.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent re-triggering addPainPoint on image
                    document.querySelectorAll('.pain-dot').forEach(d => d.classList.remove('selected'));
                    dot.classList.add('selected');
                    selectedPainPoint = painPoints.find(p => p.id === dot.dataset.id);
                    painDescription.value = selectedPainPoint.description;
                    painDescription.focus();
                });
                bodyMapContainer.appendChild(dot);

                const date = point.timestamp.toDate().toLocaleString(currentLanguage === 'ta' ? 'ta-IN' : 'en-US', { dateStyle: 'medium', timeStyle: 'short' });
                html += `<li class="mb-1"><strong>${date}</strong> - ${point.description || 'விளக்கம் இல்லை'} (X: ${point.x.toFixed(2)}, Y: ${point.y.toFixed(2)}) <button data-id="${point.id}" class="text-red-500 hover:text-red-700 ml-2 text-sm">X</button></li>`;
            });
            painPointsList.innerHTML = html;

            document.querySelectorAll('#painPointsList button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const pointId = e.target.dataset.id;
                    // Replaced alert with console.log for silent operation as per instructions
                    console.log(`Attempting to delete pain point with ID: ${pointId}`);
                    await deletePainPoint(pointId);
                });
            });
        }

        async function savePainPoints() {
            if (!isAuthReady) return;
            try {
                // Store as a single document containing an array of pain points
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/health_data`, 'pain_points');
                await setDoc(docRef, { points: JSON.stringify(painPoints), timestamp: new Date() }, { merge: true });
                console.log("Pain points saved successfully!");
            } catch (e) {
                console.error("Error saving pain points: ", e);
            }
        }

        async function loadPainPoints() {
            if (!isAuthReady) return;
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/health_data`, 'pain_points');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    painPoints = data.points ? JSON.parse(data.points) : [];
                    renderPainPoints();
                    console.log("Pain points loaded successfully!");
                } else {
                    console.log("No pain points data found for this user.");
                    painPoints = [];
                    renderPainPoints();
                }
            } catch (e) {
                console.error("Error loading pain points: ", e);
            }
        }

        async function deletePainPoint(id) {
            if (!isAuthReady) return;
            painPoints = painPoints.filter(p => p.id !== id);
            selectedPainPoint = null; // Deselect if deleted
            painDescription.value = ''; // Clear description
            await savePainPoints(); // Save updated array
            renderPainPoints(); // Re-render UI
        }

        async function getPainAdvice() {
            if (painPoints.length === 0) {
                painAdviceOutput.innerHTML = `<p class="text-red-600">${getTranslation('noPainPoints')}</p>`;
                return;
            }

            const painSummary = painPoints.map(p => p.description || `Point at X:${p.x.toFixed(2)}, Y:${p.y.toFixed(2)}`).join("; ");
            const prompt = `Based on the following pain points: "${painSummary}", provide general advice for relief and when to consult a doctor in ${currentLanguage === 'ta' ? 'Tamil' : 'English'}.`;
            await callGeminiAPI(prompt, painAdviceOutput, getTranslation('loadingText'));
        }

        // First Aid & Emergency Functions
        async function getFirstAidSteps() {
            const emergency = emergencyType.value.trim();
            if (!emergency) {
                firstAidOutput.innerHTML = `<p class="text-red-600">${getTranslation('enterEmergencyType')}</p>`;
                return;
            }
            const prompt = `Provide concise first aid steps for "${emergency}" in ${currentLanguage === 'ta' ? 'Tamil' : 'English'}. Include immediate actions and when to seek professional help.`;
            await callGeminiAPI(prompt, firstAidOutput, getTranslation('loadingText'));
        }
    </script>
</body>
</html>
