<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ஆரோக்கிய நண்பன் - உங்கள் ஆரோக்கிய வழிகாட்டி</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Tone.js for sound generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #E6F7FF; /* Light Blue */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1.5rem;
            color: #333333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
            transition: all 0.5s ease-in-out;
            overflow-y: auto; /* Allow scrolling for features */
        }

        body.main-content-active {
            min-height: auto;
            align-items: flex-start;
            padding-top: 2rem;
            padding-bottom: 2rem;
            overflow-y: auto;
        }

        .container {
            max-width: 640px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 1.75rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
            padding: 2.5rem;
            text-align: center;
            position: relative;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .language-selector-wrapper {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
        }
        .input-wrapper {
            position: relative;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }
        .input-field {
            flex-grow: 1;
            padding: 1rem 1.25rem;
            padding-right: 3.5rem; /* Space for mic icon */
            border: 1px solid #D1D5DB;
            border-radius: 0.875rem;
            font-size: 1.05rem;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus {
            border-color: #87CEEB;
            box-shadow: 0 0 0 3px rgba(135, 206, 235, 0.4);
        }
        .mic-button {
            position: absolute;
            right: 1rem;
            background: none;
            border: none;
            color: #0000FF;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: color 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .mic-button:hover {
            color: #DC2626; /* Red */
            background-color: rgba(220, 38, 38, 0.1);
        }
        .mic-button.recording {
            color: #DC2626; /* Red */
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0.7); }
        }

        .generate-button, .action-button, .open-tracker-button, .ai-voice-button {
            background-color: #6A0DAD; /* Dark Violet */
            color: #ffffff;
            padding: 1rem 2rem;
            border-radius: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(106, 13, 173, 0.4);
            letter-spacing: 0.025em;
            margin-top: 1rem;
            border: none;
            display: inline-flex; /* Ensure flex behavior for centering icon/text */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
        }
        .generate-button:hover, .action-button:hover, .open-tracker-button:hover, .ai-voice-button:hover {
            background-color: #4B0A7B; /* Darker Violet */
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(106, 13, 173, 0.5);
        }
        .generate-button:active, .action-button:active, .open-tracker-button:active, .ai-voice-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(106, 13, 173, 0.3);
        }
        .loading-indicator {
            display: none;
            margin-top: 2rem;
            font-size: 1.15rem;
            color: #6B7280;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6A0DAD;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tip-box, .result-box { /* Unified style for all output boxes */
            background-color: #FFFFAA; /* Light Yellow */
            border: 1px solid #CCCC88; /* Darker Yellow */
            border-radius: 1.25rem;
            padding: 2rem;
            margin-top: 2rem;
            text-align: left;
            color: #333333;
            line-height: 1.7;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            font-size: 1.05rem;
            transition: all 0.5s ease-in-out;
            word-break: break-word; /* Ensure long words break */
        }
        .tip-box p, .result-box p {
            margin: 0;
        }
        .text-red-600 {
            color: #DC2626; /* Red */
        }
        /* Responsive adjustments */
        @media (max-width: 640px) {
            body {
                padding: 1rem;
            }
            .container {
                padding: 1.5rem;
                border-radius: 1.25rem;
            }
            .generate-button, .action-button, .open-tracker-button, .ai-voice-button {
                width: 100%;
                padding: 0.9rem 1.5rem;
            }
            .flex.flex-wrap.justify-center.gap-4 {
                flex-direction: column;
                gap: 0.75rem;
            }
            .language-selector-wrapper {
                top: 0.75rem;
                right: 0.75rem;
            }
            .input-wrapper {
                flex-direction: row;
                justify-content: center;
            }
            .mic-button {
                position: absolute;
                right: 0.5rem;
            }
        }
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #E6F7FF;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease-out;
            overflow: hidden;
        }
        .splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .splash-screen img {
            max-width: 25%;
            max-height: 25%;
            object-fit: contain;
        }

        /* Feature Button for Main Page */
        .features-toggle-button {
            font-size: 4rem; /* Even larger emoji size for the main toggle */
            cursor: pointer;
            padding: 1rem;
            border-radius: 1rem;
            transition: transform 0.3s ease, background-color 0.3s ease;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            line-height: 1;
            margin-top: 2rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            background-color: #e0f2fe; /* Light blue background */
        }
        .features-toggle-button:hover {
            transform: scale(1.05);
            background-color: #bee3f8; /* Slightly darker blue hover */
        }
        .features-toggle-button span.label {
            font-size: 1rem;
            margin-top: 0.75rem;
            color: #333;
            font-weight: 600;
        }

        /* Feature Icons and Sections */
        .feature-icon-container {
            display: flex;
            justify-content: center;
            gap: 1.5rem; /* Space between icons */
            margin-top: 2rem;
            flex-wrap: wrap; /* Allow icons to wrap on smaller screens */
        }
        .feature-icon {
            font-size: 3rem; /* Larger emoji size */
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.75rem;
            transition: transform 0.2s ease, background-color 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            line-height: 1;
        }
        .feature-icon:hover {
            transform: translateY(-5px);
            background-color: rgba(135, 206, 235, 0.1); /* Light blue hover */
        }
        .feature-icon span.label {
            font-size: 0.8rem; /* Smaller text label */
            margin-top: 0.5rem;
            color: #555;
            font-weight: 500;
        }

        /* Feature sections (initially hidden, shown by JS) */
        .feature-section {
            display: none;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb; /* Subtle separator */
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Specific feature section styles */
        .dropdown-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #D1D5DB;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            padding: 0.5rem 0;
            top: calc(100% + 5px); /* Position below input */
            left: 0;
        }
        .dropdown-menu div {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
        }
        .dropdown-menu div:hover {
            background-color: #F3F4F6;
        }
        .dropdown-menu div.selected {
            background-color: #e0f2fe; /* light blue */
            font-weight: 500;
        }
        
        .tts-voice-selector {
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.875rem;
            font-size: 0.95rem;
            background-color: white;
            margin-left: 1rem;
            flex-grow: 1;
        }
        .body-map-container {
            position: relative;
            width: 100%;
            max-width: 300px; /* Adjust as needed */
            margin: 0 auto;
            border: 1px solid #ccc;
            border-radius: 10px;
            overflow: hidden;
        }
        .body-map-image {
            width: 100%;
            height: auto;
            display: block;
        }
        .pain-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: red;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%); /* Center the dot on the click */
        }
        .pain-dot.selected {
            background-color: darkred;
            border: 2px solid yellow;
        }
        /* Hide all feature sections by default */
        .feature-section {
            display: none;
        }
        /* Show the main view or a specific section */
        #initialView, #allFeatureIconsContainer.active, .feature-section.active {
            display: block;
        }
        .back-button {
            background: none;
            border: none;
            color: #6A0DAD;
            font-weight: 600;
            cursor: pointer;
            padding: 0.5rem 0;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            transition: color 0.3s ease;
        }
        .back-button:hover {
            color: #4B0A7B;
        }

        /* Alarm Modal Styles */
        .alarm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .alarm-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .alarm-modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .alarm-modal.show .alarm-modal-content {
            transform: translateY(0);
        }
        .alarm-modal-content h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #6A0DAD;
            margin-bottom: 1rem;
        }
        .alarm-modal-content p {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 1.5rem;
        }
        .alarm-modal-content button {
            background-color: #6A0DAD;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .alarm-modal-content button:hover {
            background-color: #4B0A7B;
        }
    </style>
</head>
<body>
    <div id="splashScreen" class="splash-screen">
        <img src="https://placehold.co/150x150/E6F7FF/000000?text=Healthcare+Logo" alt="Healthcare related image">
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div class="language-selector-wrapper">
            <select id="languageSelect" aria-label="Select Language" class="p-2 border border-gray-300 rounded-md text-sm bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300">
                <option value="ta">தமிழ்</option>
                <option value="en">English</option>
            </select>
        </div>

        <div id="initialView">
            <h1 id="mainTitle" class="text-3xl font-bold text-gray-800 mb-4 lg:text-4xl"></h1>
            <p id="descriptionText" class="text-gray-600 mb-8 text-lg"></p>

            <h2 id="tipSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4"></h2>
            <div class="input-wrapper">
                <input type="text" id="goalInput" class="input-field" aria-label="உங்கள் ஆரோக்கிய இலக்கை உள்ளிடவும்">
                <button id="micBtn" class="mic-button" title="உங்கள் இலக்கைப் பேசுங்கள்" aria-label="உங்கள் ஆரோக்கிய இலக்கைப் பதிவு செய்யவும்">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                </button>
            </div>
            <div class="flex flex-wrap justify-center gap-4 mt-4">
                <button id="generateBtn" class="generate-button">✨ <span data-label-key="generateBtn"></span></button>
                <button id="aiVoiceBtn" class="ai-voice-button" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                    </svg>
                </button>
                <select id="ttsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
            </div>
            <div id="loading" class="loading-indicator" aria-live="polite">
                <div class="loading-spinner"></div>
                <p id="loadingText"></p>
            </div>
            <div id="tipOutput" class="tip-box" aria-live="polite"></div>

            <hr class="border-t border-gray-300 my-8">

            <h2 id="featuresTitle" class="text-2xl font-semibold text-gray-700 mb-4"></h2>
            <button id="toggleFeaturesBtn" class="features-toggle-button" title="அனைத்து அம்சங்களையும் காண்க">
                ✨<span class="label" data-label-key="showFeaturesLabel"></span>
            </button>
        </div>

        <!-- This div will now contain both the list of icons and the individual feature sections -->
        <div id="featuresContainer" style="display: none;">
            <!-- This button takes you back to the initial view from the features section -->
            <button class="back-button" id="backToMainFromFeaturesContainer" style="display: none;">← <span data-label-key="backToMain"></span></button>
            <h1 id="featuresPageTitle" class="text-3xl font-bold text-gray-800 mb-6 mt-4 lg:text-4xl"></h1>

            <!-- All feature icons container -->
            <div id="allFeatureIconsContainer" class="feature-icon-container">
                <div id="iconStepTracker" class="feature-icon" data-section="stepTrackerSection" title="படி டிராக்கர்">👟<span class="label" data-label-key="stepTrackerLabel"></span></div>
                <div id="iconHeartRateTracker" class="feature-icon" data-section="heartRateTrackerSection" title="இதயத் துடிப்பு டிராக்கர்">💓<span class="label" data-label-key="heartRateTrackerLabel"></span></div>
                <div id="iconWaterTracker" class="feature-icon" data-section="waterTrackerSection" title="தண்ணீர் டிராக்கர்">💧<span class="label" data-label-key="waterTrackerLabel"></span></div>
                <div id="iconJournal" class="feature-icon" data-section="journalSection" title="மனநிலை & நன்றியுணர்வு ஜர்னல்">📝<span class="label" data-label-key="journalLabel"></span></div>
                <div id="iconLocalTips" class="feature-icon" data-section="localTipsSection" title="உள்ளூர் ஆரோக்கிய குறிப்புகள்">🌱<span class="label" data-label-key="localTipsLabel"></span></div>
                <div id="iconMealPlan" class="feature-icon" data-section="mealPlanSection" title="உணவுத் திட்டப் பரிந்துரைகள்">🍽️<span class="label" data-label-key="mealPlanLabel"></span></div>
                <div id="iconMoodAnalysis" class="feature-icon" data-section="moodAnalysisSection" title="உணர்வுப் பதிவேடு பகுப்பாய்வு">🧠<span class="label" data-label-key="moodAnalysisLabel"></span></div>
                <div id="iconExerciseYoga" class="feature-icon" data-section="exerciseYogaSection" title="உடற்பயிற்சி & யோகா">🤸‍♀️<span class="label" data-label-key="exerciseYogaLabel"></span></div>
                <div id="iconDiseasePrevention" class="feature-icon" data-section="diseasePreventionSection" title="நோய் தடுப்பு">🛡️<span class="label" data-label-key="diseasePreventionLabel"></span></div>
                <div id="iconWellnessChallenge" class="feature-icon" data-section="wellnessChallengeSection" title="ஆரோக்கிய சவால்கள்">🏅<span class="label" data-label-key="wellnessChallengeLabel"></span></div>
                <div id="iconMedicationReminder" class="feature-icon" data-section="medicationReminderSection" title="மருந்து நினைவூட்டல்">⏰<span class="label" data-label-key="medicationReminderLabel"></span></div>
                <div id="iconBodyPainMapping" class="feature-icon" data-section="bodyPainMappingSection" title="உடல் வலி மேப்பிங்">📍<span class="label" data-label-key="bodyPainMappingLabel"></span></div>
                <div id="iconFirstAidEmergency" class="feature-icon" data-section="firstAidEmergencySection" title="முதலுதவி & அவசர உதவி">🆘<span class="label" data-label-key="firstAidEmergencyLabel"></span></div>
            </div>

            <!-- All feature sections are now children of featuresContainer -->
            <div id="stepTrackerSection" class="feature-section">
                <!-- Data target for back button now points to the icons container -->
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="stepSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <div class="input-wrapper">
                    <label for="currentStepsDisplay" class="sr-only">தற்போதைய படிகள்</label>
                    <input type="text" id="currentStepsDisplay" class="input-field" value="0" readonly aria-atomic="true">
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="addOneStepBtn" class="action-button"></button>
                    <button id="addSingleStepBtn" class="action-button"></button> <!-- New button for single step -->
                    <button id="toggleTrackingBtn" class="action-button"></button>
                    <button id="resetStepsBtn" class="action-button"></button>
                </div>
                <div id="stepResultOutput" class="result-box" aria-live="polite"></div>
                <div id="stepTipOutput" class="tip-box" aria-live="polite"></div> <!-- Dedicated tip output -->
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="stepTipAiVoiceBtn" class="ai-voice-button" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                        </svg>
                    </button>
                    <select id="stepTipTtsVoiceSelect" class="tts-voice-selector" style="display: none;" aria-label="Select Voice"></select>
                </div>
            </div>

            <div id="heartRateTrackerSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="heartRateSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <div class="input-wrapper">
                    <label for="currentHeartRateDisplay" class="sr-only">தற்போதைய இதயத் துடிப்பு</label>
                    <input type="text" id="currentHeartRateDisplay" class="input-field" value="0" readonly aria-atomic="true">
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="simulateHeartRateBtn" class="action-button"></button>
                    <button id="resetHeartRateBtn" class="action-button"></button>
                </div>
                <div id="heartRateResultOutput" class="result-box" aria-live="polite"></div>
                <div id="heartRateTipOutput" class="tip-box" aria-live="polite"></div> <!-- Dedicated tip output -->
            </div>

            <div id="waterTrackerSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="waterSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <div class="input-wrapper">
                    <label for="waterIntakeDisplay" class="sr-only">தற்போதைய தண்ணீர் உட்கொள்ளல்</label>
                    <input type="text" id="waterIntakeDisplay" class="input-field" value="0 ml" readonly aria-atomic="true">
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-4">
                    <button id="addWaterBtn" class="action-button"></button>
                    <button id="resetWaterBtn" class="action-button"></button>
                </div>
                <div id="waterResultOutput" class="result-box" aria-live="polite"></div>
                <div id="waterTipOutput" class="tip-box" aria-live="polite"></div> <!-- Dedicated tip output -->
            </div>

            <div id="journalSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="journalSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="journalDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper flex-col items-stretch">
                    <label for="moodSelect" class="sr-only">உங்கள் மனநிலையைத் தேர்ந்தெடுக்கவும்</label>
                    <select id="moodSelect" class="input-field mb-4" aria-label="உங்கள் மனநிலையைத் தேர்ந்தெடுக்கவும்">
                        <option value="">உங்கள் மனநிலையைத் தேர்ந்தெடுக்கவும்</option>
                        <option value="happy">மகிழ்ச்சி 😄</option>
                        <option value="neutral">சாதாரணம் 😐</option>
                        <option value="sad">சோகம் 😔</option>
                        <option value="stressed">மன அழுத்தம் 😩</option>
                        <option value="energetic">ஆற்றல் 💪</option>
                    </select>
                    <label for="gratitudeInput" class="sr-only">நீங்கள் நன்றியுள்ள ஒரு விஷயத்தை எழுதுங்கள்</label>
                    <textarea id="gratitudeInput" class="input-field min-h-[100px]" placeholder="நீங்கள் நன்றியுள்ள ஒரு விஷயத்தை எழுதுங்கள்..." aria-label="நீங்கள் நன்றியுள்ள ஒரு விஷயத்தை எழுதுங்கள்"></textarea>
                </div>
                <button id="saveJournalEntryBtn" class="action-button mt-4"></button>
                <div id="journalEntriesOutput" class="result-box mt-4 text-left"></div>
                <button id="analyzeMoodJournalBtn" class="action-button mt-4">✨ <span data-label-key="analyzeMoodJournalBtn"></span></button>
                <div id="moodAnalysisOutput" class="result-box mt-4 text-left" aria-live="polite"></div>
            </div>

            <div id="localTipsSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="localTipsSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="localTipsDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper mb-4"> <!-- Nested input-wrapper for mic -->
                    <input type="text" id="localTipCategory" class="input-field" aria-label="உதவிக்குறிப்பு வகையை உள்ளிடவும்" placeholder="எ.கா. மஞ்சள், முருங்கை, தியானம்...">
                    <button id="localTipMicBtn" class="mic-button" title="உதவிக்குறிப்பு வகையை பேசவும்" aria-label="உதவிக்குறிப்பு வகையைப் பதிவு செய்யவும்">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    </button>
                    <div id="localTipCategoryDropdown" class="dropdown-menu hidden mt-2 top-full left-0"></div>
                </div>
                <button id="getLocalTipBtn" class="generate-button">✨ <span data-label-key="getLocalTipBtn"></span></button>
                <div id="localTipOutput" class="tip-box" aria-live="polite"></div>
                <button id="localTipAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                    </svg>
                </button>
            </div>

            <div id="mealPlanSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="mealPlanSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="mealPlanDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper flex-col items-stretch">
                    <label for="dietGoalInput" class="sr-only">உணவு இலக்கு</label>
                    <div class="input-wrapper mb-4"> <!-- Nested input-wrapper for mic -->
                        <input type="text" id="dietGoalInput" class="input-field" placeholder="எ.கா. எடை குறைப்பு, தசை வளர்ச்சி..." aria-label="உணவு இலக்கு">
                        <button id="dietGoalMicBtn" class="mic-button" title="உணவு இலக்கைப் பேசவும்" aria-label="உணவு இலக்கைப் பதிவு செய்யவும்">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                    </div>

                    <label for="dietPreferenceSelect" class="sr-only">உணவு விருப்பம்</label>
                    <select id="dietPreferenceSelect" class="input-field mb-4" aria-label="உணவு விருப்பம்">
                        <option value="">உணவு விருப்பத்தைத் தேர்ந்தெடுக்கவும்</option>
                        <option value="vegetarian">சைவம்</option>
                        <option value="non-vegetarian">அசைவம்</option>
                        <option value="vegan">முழு சைவம்</option>
                    </select>

                    <label for="allergiesInput" class="sr-only">ஒவ்வாமைகள் (இருப்பின்)</label>
                    <div class="input-wrapper mb-4"> <!-- Nested input-wrapper for mic -->
                        <input type="text" id="allergiesInput" class="input-field" placeholder="எ.கா. நிலக்கடலை, பால்..." aria-label="ஒவ்வாமைகள்">
                        <button id="allergiesMicBtn" class="mic-button" title="ஒவ்வாமைகளைப் பேசவும்" aria-label="ஒவ்வாமைகளைப் பதிவு செய்யவும்">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <button id="generateMealPlanBtn" class="generate-button">✨ <span data-label-key="generateMealPlanBtn"></span></button>
                <div id="mealPlanOutput" class="tip-box" aria-live="polite"></div>
                <button id="mealPlanAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                    </svg>
                </button>
            </div>

            <div id="moodAnalysisSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="moodAnalysisSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="moodAnalysisDescription" class="text-gray-600 mb-4 text-lg"></p>
                <button id="triggerMoodAnalysisBtn" class="action-button mt-4">✨ <span data-label-key="triggerMoodAnalysisBtn"></span></button>
                <div id="moodAnalysisResultOutput" class="result-box mt-4 text-left" aria-live="polite"></div>
                <button id="moodAnalysisAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                    </svg>
                </button>
            </div>

            <div id="exerciseYogaSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="exerciseYogaSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="exerciseYogaDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper flex-col items-stretch">
                    <label for="exerciseTypeSelect" class="sr-only">உடற்பயிற்சி வகை</label>
                    <select id="exerciseTypeSelect" class="input-field mb-4" aria-label="உடற்பயிற்சி வகை">
                        <option value="">உடற்பயிற்சி வகையைத் தேர்ந்தெடுக்கவும்</option>
                        <option value="strength">வலிமை பயிற்சி 💪</option>
                        <option value="cardio">கார்டியோ 🏃‍♀️</option>
                        <option value="yoga">யோகா 🧘‍♀️</option>
                        <option value="flexibility">நெகிழ்வுத்தன்மை 🤸</option>
                    </select>
                    <label for="exerciseDurationInput" class="sr-only">கால அளவு (நிமிடங்கள்)</label>
                    <input type="number" id="exerciseDurationInput" class="input-field" placeholder="கால அளவு (நிமிடங்கள்)" aria-label="கால அளவு (நிமிடங்கள்)">
                </div>
                <button id="getExercisePlanBtn" class="generate-button">✨ <span data-label-key="getExercisePlanBtn"></span></button>
                <div id="exercisePlanOutput" class="tip-box" aria-live="polite"></div>
                <button id="exercisePlanAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                    </svg>
                </button>
            </div>

            <div id="diseasePreventionSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="diseasePreventionSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="diseasePreventionDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper mb-4">
                    <input type="text" id="diseasePreventionInput" class="input-field" placeholder="எ.கா. சர்க்கரை நோய், இதய நோய்..." aria-label="நோய் தடுப்பு தகவல்">
                </div>
                <button id="getPreventionInfoBtn" class="generate-button">✨ <span data-label-key="getPreventionInfoBtn"></span></button>
                <div id="preventionInfoOutput" class="tip-box" aria-live="polite"></div>
                <button id="preventionInfoAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                    </svg>
                </button>
            </div>

            <div id="wellnessChallengeSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="wellnessChallengeSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="wellnessChallengeDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="input-wrapper mb-4">
                    <input type="text" id="challengeTopicInput" class="input-field" placeholder="எ.கா. 30 நாள் உடற்பயிற்சி, நீர் அருந்துதல்..." aria-label="சவால் தலைப்பு">
                </div>
                <button id="generateChallengeBtn" class="generate-button">✨ <span data-label-key="generateChallengeBtn"></span></button>
                <div id="challengeOutput" class="tip-box" aria-live="polite"></div>
                <button id="challengeAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                    </svg>
                </button>
            </div>

            <div id="medicationReminderSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="medicationReminderSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="medicationReminderDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div id="medicationList" class="space-y-4 mb-6">
                    <!-- Medication items will be added here by JS -->
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <div class="input-wrapper">
                        <input type="text" id="medicationNameInput" class="input-field" placeholder="மருந்து பெயர்" aria-label="மருந்து பெயர்">
                        <button id="medicationNameMicBtn" class="mic-button" title="மருந்து பெயரை பேசவும்" aria-label="மருந்து பெயரை பதிவு செய்யவும்">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                    </div>
                    <input type="time" id="medicationTimeInput" class="input-field" aria-label="நேரம்">
                    <input type="text" id="medicationRingtoneInput" class="input-field" placeholder="ரிங்டோன் (எ.கா., அலாரம்)" aria-label="ரிங்டோன்">
                </div>
                <button id="addMedicationBtn" class="action-button"></button>
            </div>

            <div id="bodyPainMappingSection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="bodyPainMappingSectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="bodyPainMappingDescription" class="text-gray-600 mb-4 text-lg"></p>
                <div class="body-map-container relative mx-auto my-4">
                    <!-- Placeholder for body map image -->
                    <img id="bodyMapImage" src="https://placehold.co/300x500/E6F7FF/000000?text=Human+Body+Map" alt="Human Body Map" class="body-map-image">
                    <div id="painDotsContainer" class="absolute inset-0">
                        <!-- Pain dots will be appended here by JS -->
                    </div>
                </div>
                <div class="input-wrapper mb-4">
                    <input type="text" id="painDescriptionInput" class="input-field" placeholder="வலி விளக்கம் (எ.கா. தலைவலி, தோள்பட்டை வலி)" aria-label="வலி விளக்கம்">
                </div>
                <button id="savePainPointBtn" class="action-button"></button>
                <div id="painPointsList" class="result-box mt-4 text-left">
                    <h3 class="font-semibold mb-2" data-label-key="recordedPainPoints"></h3>
                    <ul id="painPointsUl" class="list-disc pl-5"></ul>
                </div>
            </div>

            <div id="firstAidEmergencySection" class="feature-section">
                <button class="back-button" data-target="allFeatureIconsContainer">← <span data-label-key="backToFeatures"></span></button>
                <h2 id="firstAidEmergencySectionTitle" class="text-2xl font-semibold text-gray-700 mb-4 mt-4"></h2>
                <p id="firstAidEmergencyDescription" class="text-gray-600 mb-4 text-lg"></p>

                <h3 id="firstAidSearchTitle" class="text-xl font-semibold text-gray-700 mb-3"></h3>
                <div class="input-wrapper mb-4">
                    <input type="text" id="firstAidSearchInput" class="input-field" placeholder="எ.கா. வெட்டு, தீக்காயம், மூச்சுத்திணறல்..." aria-label="முதலுதவி தேடல்">
                    <button id="firstAidSearchMicBtn" class="mic-button" title="முதலுதவி தேடலை பேசவும்" aria-label="முதலுதவி தேடலை பதிவு செய்யவும்">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    </button>
                </div>
                <button id="getFirstAidInfoBtn" class="generate-button">✨ <span data-label-key="getFirstAidInfoBtn"></span></button>
                <div id="firstAidOutput" class="tip-box" aria-live="polite"></div>
                <button id="firstAidAiVoiceBtn" class="ai-voice-button mt-4" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path>
                    </svg>
                </button>

                <h3 id="emergencyContactsTitle" class="text-xl font-semibold text-gray-700 mb-3 mt-6"></h3>
                <div id="emergencyContactList" class="space-y-3 mb-4">
                    <!-- Emergency contacts will be added here by JS -->
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div class="input-wrapper">
                        <input type="text" id="emergencyContactNameInput" class="input-field" placeholder="பெயர்" aria-label="அவசர தொடர்பு பெயர்">
                        <button id="emergencyContactNameMicBtn" class="mic-button" title="பெயரை பேசவும்" aria-label="பெயரை பதிவு செய்யவும்">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="input-wrapper">
                        <input type="text" id="emergencyContactNumberInput" class="input-field" placeholder="தொலைபேசி எண்" aria-label="அவசர தொடர்பு எண்">
                        <button id="emergencyContactNumberMicBtn" class="mic-button" title="தொலைபேசி எண்ணை பேசவும்" aria-label="தொலைபேசி எண்ணை பதிவு செய்யவும்">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <button id="addEmergencyContactBtn" class="action-button"></button>
            </div>
        </div>

        <!-- Custom Modal for Alerts -->
        <div id="customModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="modalMessage" class="text-lg font-semibold mb-4"></p>
                <button id="modalCloseBtn" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
            </div>
        </div>

        <!-- Alarm Modal -->
        <div id="alarmModal" class="alarm-modal">
            <div class="alarm-modal-content">
                <h3 id="alarmModalTitle"></h3>
                <p id="alarmModalMessage"></p>
                <button id="alarmModalDismissBtn"></button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase config and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Localization dictionary
        const translations = {
            en: {
                mainTitle: 'Health Friend - Your Health Guide',
                descriptionText: 'Enter your health goal and get personalized tips!',
                tipSectionTitle: 'Get a Health Tip',
                generateBtn: 'Get Tip',
                loadingText: 'Generating tip...',
                featuresTitle: 'Explore More Features',
                showFeaturesLabel: 'Features',
                backToMain: 'Back to Main',
                backToFeatures: 'Back to Features',
                featuresPageTitle: 'All Health Features',
                stepTrackerLabel: 'Step Tracker',
                heartRateTrackerLabel: 'Heart Rate',
                waterTrackerLabel: 'Water Intake',
                journalLabel: 'Mood Journal',
                localTipsLabel: 'Local Tips',
                mealPlanLabel: 'Meal Plan',
                moodAnalysisLabel: 'Mood Analysis',
                exerciseYogaLabel: 'Exercise & Yoga',
                diseasePreventionLabel: 'Disease Prevention',
                wellnessChallengeLabel: 'Wellness Challenges',
                medicationReminderLabel: 'Medication',
                bodyPainMappingLabel: 'Body Pain Map',
                firstAidEmergencyLabel: 'First Aid & Emergency',

                // Step Tracker
                stepSectionTitle: 'Step Tracker',
                addOneStepBtn: 'Add 100 Steps',
                addSingleStepBtn: 'Add 1 Step', // New translation
                toggleTrackingBtn: 'Start Tracking',
                resetStepsBtn: 'Reset Steps',
                stepResultOutputDefault: 'Track your daily steps here!',
                stepTipOutputDefault: 'Walking 10,000 steps a day can significantly improve your health.',

                // Heart Rate Tracker
                heartRateSectionTitle: 'Heart Rate Tracker',
                simulateHeartRateBtn: 'Simulate Heart Rate',
                resetHeartRateBtn: 'Reset Heart Rate',
                heartRateResultOutputDefault: 'Monitor your heart rate for better health.',
                heartRateTipOutputDefault: 'A resting heart rate between 60-100 BPM is generally considered normal for adults.',

                // Water Tracker
                waterSectionTitle: 'Water Intake Tracker',
                addWaterBtn: 'Add 250 ml',
                resetWaterBtn: 'Reset Water',
                waterResultOutputDefault: 'Track your daily water intake.',
                waterTipOutputDefault: 'Drink at least 8 glasses of water a day for optimal hydration.',

                // Journal
                journalSectionTitle: 'Mood & Gratitude Journal',
                journalDescription: 'Record your mood and what you are grateful for each day.',
                saveJournalEntryBtn: 'Save Entry',
                journalEntriesOutputDefault: 'Your journal entries will appear here.',
                analyzeMoodJournalBtn: 'Analyze Mood',
                moodAnalysisOutputDefault: 'Your mood analysis will appear here.',

                // Local Tips
                localTipsSectionTitle: 'Local Health Tips',
                localTipsDescription: 'Get health tips based on local remedies and practices.',
                getLocalTipBtn: 'Get Tip',

                // Meal Plan
                mealPlanSectionTitle: 'Meal Plan Recommendations',
                mealPlanDescription: 'Get personalized meal plans based on your goals and preferences.',
                generateMealPlanBtn: 'Generate Plan',

                // Mood Analysis
                moodAnalysisSectionTitle: 'Mood Journal Analysis',
                moodAnalysisDescription: 'Analyze your mood patterns from your journal entries.',
                triggerMoodAnalysisBtn: 'Analyze Journal',

                // Exercise & Yoga
                exerciseYogaSectionTitle: 'Exercise & Yoga Plans',
                exerciseYogaDescription: 'Get personalized exercise and yoga routines.',
                getExercisePlanBtn: 'Get Plan',

                // Disease Prevention
                diseasePreventionSectionTitle: 'Disease Prevention Information',
                diseasePreventionDescription: 'Learn about preventing common diseases.',
                getPreventionInfoBtn: 'Get Info',

                // Wellness Challenges
                wellnessChallengeSectionTitle: 'Wellness Challenges',
                wellnessChallengeDescription: 'Join or create health and wellness challenges.',
                generateChallengeBtn: 'Generate Challenge',

                // Medication Reminder
                medicationReminderSectionTitle: 'Medication Reminders',
                medicationReminderDescription: 'Set reminders for your medications.',
                addMedicationBtn: 'Add Medication',

                // Body Pain Mapping
                bodyPainMappingSectionTitle: 'Body Pain Mapping',
                bodyPainMappingDescription: 'Click on the body map to mark and describe your pain points.',
                savePainPointBtn: 'Save Pain Point',
                recordedPainPoints: 'Recorded Pain Points:',

                // First Aid & Emergency
                firstAidEmergencySectionTitle: 'First Aid & Emergency',
                firstAidEmergencyDescription: 'Find first aid information and manage emergency contacts.',
                firstAidSearchTitle: 'First Aid Information',
                getFirstAidInfoBtn: 'Get First Aid Info',
                emergencyContactsTitle: 'Emergency Contacts',
                addEmergencyContactBtn: 'Add Contact',

                // Modals & Alerts
                modalSuccessTitle: 'Success!',
                modalErrorTitle: 'Error!',
                modalSaveSuccess: 'Your data has been saved successfully!',
                modalSaveError: 'Failed to save data. Please try again.',
                modalMedicineAdded: 'Medication added successfully!',
                modalMedicineRemoved: 'Medication removed successfully!',
                modalMedicineError: 'Failed to add medication. Please fill all fields.',
                modalAuthError: 'Authentication failed. Please refresh the page.',
                modalJournalSaved: 'Journal entry saved!',
                modalJournalError: 'Failed to save journal entry.',
                modalPainPointSaved: 'Pain point saved!',
                modalPainPointRemoved: 'Pain point removed!',
                modalPainPointError: 'Failed to save pain point. Please provide a description.',
                modalContactAdded: 'Emergency contact added!',
                modalContactRemoved: 'Emergency contact removed!',
                modalContactError: 'Failed to add contact. Please fill all fields.',
                alarmModalTitle: 'Medication Reminder!',
                alarmModalMessage: 'Time to take your medication: ',
                alarmModalDismissBtn: 'Dismiss',
                speechRecognitionError: 'Speech recognition not supported or permission denied.',
                speechRecognitionNoMatch: 'Could not understand audio. Please try again.',
                speechRecognitionListening: 'Listening...',
                speechRecognitionProcessing: 'Processing audio...',
                ttsError: 'Text-to-speech not supported or voices not available.',
                ttsSpeaking: 'Speaking...',
                ttsLoadingVoices: 'Loading voices...',
                ttsNoVoices: 'No voices available for this language.',
            },
            ta: {
                mainTitle: 'ஆரோக்கிய நண்பன் - உங்கள் ஆரோக்கிய வழிகாட்டி',
                descriptionText: 'உங்கள் ஆரோக்கிய இலக்கை உள்ளிட்டு தனிப்பயனாக்கப்பட்ட குறிப்புகளைப் பெறுங்கள்!',
                tipSectionTitle: 'ஆரோக்கிய குறிப்பு பெறுங்கள்',
                generateBtn: 'குறிப்பு பெறு',
                loadingText: 'குறிப்பு உருவாக்கப்படுகிறது...',
                featuresTitle: 'மேலும் அம்சங்களை ஆராயுங்கள்',
                showFeaturesLabel: 'அம்சங்கள்',
                backToMain: 'முக்கிய பக்கத்திற்கு திரும்பு',
                backToFeatures: 'அம்சங்களுக்கு திரும்பு',
                featuresPageTitle: 'அனைத்து ஆரோக்கிய அம்சங்கள்',
                stepTrackerLabel: 'படி கண்காணிப்பு',
                heartRateTrackerLabel: 'இதயத் துடிப்பு',
                waterTrackerLabel: 'நீர் உட்கொள்ளல்',
                journalLabel: 'மனநிலை நாட்குறிப்பு',
                localTipsLabel: 'உள்ளூர் குறிப்புகள்',
                mealPlanLabel: 'உணவுத் திட்டம்',
                moodAnalysisLabel: 'மனநிலை பகுப்பாய்வு',
                exerciseYogaLabel: 'உடற்பயிற்சி & யோகா',
                diseasePreventionLabel: 'நோய் தடுப்பு',
                wellnessChallengeLabel: 'ஆரோக்கிய சவால்கள்',
                medicationReminderLabel: 'மருந்து நினைவூட்டல்',
                bodyPainMappingLabel: 'உடல் வலி வரைபடம்',
                firstAidEmergencyLabel: 'முதலுதவி & அவசரம்',

                // Step Tracker
                stepSectionTitle: 'படி கண்காணிப்பு',
                addOneStepBtn: '100 படிகள் சேர்',
                addSingleStepBtn: '1 படி சேர்', // New translation
                toggleTrackingBtn: 'கண்காணிப்பை தொடங்கு',
                resetStepsBtn: 'படிகளை மீட்டமை',
                stepResultOutputDefault: 'உங்கள் தினசரி படிகளை இங்கே கண்காணிக்கவும்!',
                stepTipOutputDefault: 'ஒரு நாளைக்கு 10,000 படிகள் நடப்பது உங்கள் ஆரோக்கியத்தை கணிசமாக மேம்படுத்தும்.',

                // Heart Rate Tracker
                heartRateSectionTitle: 'இதயத் துடிப்பு கண்காணிப்பு',
                simulateHeartRateBtn: 'இதயத் துடிப்பை உருவகப்படுத்து',
                resetHeartRateBtn: 'இதயத் துடிப்பை மீட்டமை',
                heartRateResultOutputDefault: 'சிறந்த ஆரோக்கியத்திற்காக உங்கள் இதயத் துடிப்பை கண்காணிக்கவும்.',
                heartRateTipOutputDefault: 'ஓய்வு நேரத்தில் இதயத் துடிப்பு 60-100 BPM பொதுவாக பெரியவர்களுக்கு சாதாரணமாகக் கருதப்படுகிறது.',

                // Water Tracker
                waterSectionTitle: 'நீர் உட்கொள்ளல் கண்காணிப்பு',
                addWaterBtn: '250 மிலி சேர்',
                resetWaterBtn: 'நீரை மீட்டமை',
                waterResultOutputDefault: 'உங்கள் தினசரி நீர் உட்கொள்ளலை கண்காணிக்கவும்.',
                waterTipOutputDefault: 'சரியான நீரேற்றத்திற்கு ஒரு நாளைக்கு குறைந்தது 8 கிளாஸ் தண்ணீர் குடிக்கவும்.',

                // Journal
                journalSectionTitle: 'மனநிலை & நன்றியுணர்வு நாட்குறிப்பு',
                journalDescription: 'உங்கள் மனநிலையையும், நீங்கள் நன்றியுள்ள விஷயங்களையும் தினமும் பதிவு செய்யுங்கள்.',
                saveJournalEntryBtn: 'பதிவை சேமி',
                journalEntriesOutputDefault: 'உங்கள் நாட்குறிப்பு பதிவுகள் இங்கே தோன்றும்.',
                analyzeMoodJournalBtn: 'மனநிலையை பகுப்பாய்வு செய்',
                moodAnalysisOutputDefault: 'உங்கள் மனநிலை பகுப்பாய்வு இங்கே தோன்றும்.',

                // Local Tips
                localTipsSectionTitle: 'உள்ளூர் ஆரோக்கிய குறிப்புகள்',
                localTipsDescription: 'உள்ளூர் வைத்தியம் மற்றும் நடைமுறைகளின் அடிப்படையில் ஆரோக்கிய குறிப்புகளைப் பெறுங்கள்.',
                getLocalTipBtn: 'குறிப்பு பெறு',

                // Meal Plan
                mealPlanSectionTitle: 'உணவுத் திட்ட பரிந்துரைகள்',
                mealPlanDescription: 'உங்கள் இலக்குகள் மற்றும் விருப்பங்களின் அடிப்படையில் தனிப்பயனாக்கப்பட்ட உணவுத் திட்டங்களைப் பெறுங்கள்.',
                generateMealPlanBtn: 'திட்டத்தை உருவாக்கு',

                // Mood Analysis
                moodAnalysisSectionTitle: 'மனநிலை நாட்குறிப்பு பகுப்பாய்வு',
                moodAnalysisDescription: 'உங்கள் நாட்குறிப்பு பதிவுகளிலிருந்து உங்கள் மனநிலை வடிவங்களை பகுப்பாய்வு செய்யுங்கள்.',
                triggerMoodAnalysisBtn: 'நாட்குறிப்பை பகுப்பாய்வு செய்',

                // Exercise & Yoga
                exerciseYogaSectionTitle: 'உடற்பயிற்சி & யோகா திட்டங்கள்',
                exerciseYogaDescription: 'தனிப்பயனாக்கப்பட்ட உடற்பயிற்சி மற்றும் யோகா நடைமுறைகளைப் பெறுங்கள்.',
                getExercisePlanBtn: 'திட்டத்தை பெறு',

                // Disease Prevention
                diseasePreventionSectionTitle: 'நோய் தடுப்பு தகவல்',
                diseasePreventionDescription: 'பொதுவான நோய்களைத் தடுப்பது பற்றி அறியவும்.',
                getPreventionInfoBtn: 'தகவல் பெறு',

                // Wellness Challenges
                wellnessChallengeSectionTitle: 'ஆரோக்கிய சவால்கள்',
                wellnessChallengeDescription: 'ஆரோக்கிய மற்றும் நல்வாழ்வு சவால்களில் சேரவும் அல்லது உருவாக்கவும்.',
                generateChallengeBtn: 'சவாலை உருவாக்கு',

                // Medication Reminder
                medicationReminderSectionTitle: 'மருந்து நினைவூட்டல்கள்',
                medicationReminderDescription: 'உங்கள் மருந்துகளுக்கான நினைவூட்டல்களை அமைக்கவும்.',
                addMedicationBtn: 'மருந்து சேர்',

                // Body Pain Mapping
                bodyPainMappingSectionTitle: 'உடல் வலி வரைபடம்',
                bodyPainMappingDescription: 'உங்கள் வலி புள்ளிகளைக் குறிக்க உடல் வரைபடத்தில் கிளிக் செய்து விவரிக்கவும்.',
                savePainPointBtn: 'வலி புள்ளியை சேமி',
                recordedPainPoints: 'பதிவு செய்யப்பட்ட வலி புள்ளிகள்:',

                // First Aid & Emergency
                firstAidEmergencySectionTitle: 'முதலுதவி & அவசரம்',
                firstAidEmergencyDescription: 'முதலுதவி தகவல்களைக் கண்டறிந்து அவசர தொடர்புகளை நிர்வகிக்கவும்.',
                firstAidSearchTitle: 'முதலுதவி தகவல்',
                getFirstAidInfoBtn: 'முதலுதவி தகவல் பெறு',
                emergencyContactsTitle: 'அவசர தொடர்புகள்',
                addEmergencyContactBtn: 'தொடர்பு சேர்',

                // Modals & Alerts
                modalSuccessTitle: 'வெற்றி!',
                modalErrorTitle: 'பிழை!',
                modalSaveSuccess: 'உங்கள் தரவு வெற்றிகரமாக சேமிக்கப்பட்டது!',
                modalSaveError: 'தரவைச் சேமிக்க முடியவில்லை. மீண்டும் முயற்சிக்கவும்.',
                modalMedicineAdded: 'மருந்து வெற்றிகரமாக சேர்க்கப்பட்டது!',
                modalMedicineRemoved: 'மருந்து வெற்றிகரமாக அகற்றப்பட்டது!',
                modalMedicineError: 'மருந்து சேர்க்க முடியவில்லை. அனைத்து புலங்களையும் நிரப்பவும்.',
                modalAuthError: 'அங்கீகாரம் தோல்வியடைந்தது. பக்கத்தை புதுப்பிக்கவும்.',
                modalJournalSaved: 'நாட்குறிப்பு பதிவு சேமிக்கப்பட்டது!',
                modalJournalError: 'நாட்குறிப்பு பதிவைச் சேமிக்க முடியவில்லை.',
                modalPainPointSaved: 'வலி புள்ளி சேமிக்கப்பட்டது!',
                modalPainPointRemoved: 'வலி புள்ளி அகற்றப்பட்டது!',
                modalPainPointError: 'வலி புள்ளியைச் சேமிக்க முடியவில்லை. தயவுசெய்து ஒரு விளக்கத்தை வழங்கவும்.',
                modalContactAdded: 'அவசர தொடர்பு சேர்க்கப்பட்டது!',
                modalContactRemoved: 'அவசர தொடர்பு அகற்றப்பட்டது!',
                modalContactError: 'தொடர்பைச் சேர்க்க முடியவில்லை. அனைத்து புலங்களையும் நிரப்பவும்.',
                alarmModalTitle: 'மருந்து நினைவூட்டல்!',
                alarmModalMessage: 'உங்கள் மருந்தை எடுத்துக்கொள்ள வேண்டிய நேரம்: ',
                alarmModalDismissBtn: 'நீக்கு',
                speechRecognitionError: 'பேச்சு அங்கீகாரம் ஆதரிக்கப்படவில்லை அல்லது அனுமதி மறுக்கப்பட்டது.',
                speechRecognitionNoMatch: 'ஆடியோவை புரிந்து கொள்ள முடியவில்லை. மீண்டும் முயற்சிக்கவும்.',
                speechRecognitionListening: 'கேட்கிறது...',
                speechRecognitionProcessing: 'ஆடியோ செயலாக்கப்படுகிறது...',
                ttsError: 'உரை-பேச்சு ஆதரிக்கப்படவில்லை அல்லது குரல்கள் கிடைக்கவில்லை.',
                ttsSpeaking: 'பேசுகிறது...',
                ttsLoadingVoices: 'குரல்கள் ஏற்றப்படுகிறது...',
                ttsNoVoices: 'இந்த மொழிக்கு குரல்கள் கிடைக்கவில்லை.',
            }
        };

        let currentLang = 'ta'; // Default to Tamil as per user's HTML
        let recognition; // Web Speech Recognition API instance
        let synth; // Web Speech Synthesis API instance
        let voices = []; // Available TTS voices
        let speaking = false; // Flag to track if TTS is speaking

        // Tone.js Synth for alarm sound
        const alarmSynth = new Tone.Synth().toDestination();

        // Function to update UI text based on selected language
        function updateUI(lang) {
            currentLang = lang;
            const t = translations[lang];

            // Update elements with data-label-key
            document.querySelectorAll('[data-label-key]').forEach(element => {
                const key = element.dataset.labelKey;
                if (t[key]) {
                    element.textContent = t[key];
                }
            });

            // Update specific elements
            document.getElementById('mainTitle').textContent = t.mainTitle;
            document.getElementById('descriptionText').textContent = t.descriptionText;
            document.getElementById('tipSectionTitle').textContent = t.tipSectionTitle;
            document.getElementById('loadingText').textContent = t.loadingText;
            document.getElementById('featuresTitle').textContent = t.featuresTitle;
            document.getElementById('featuresPageTitle').textContent = t.featuresPageTitle;

            // Update placeholder texts
            document.getElementById('goalInput').placeholder = lang === 'en' ? 'Enter your health goal' : 'உங்கள் ஆரோக்கிய இலக்கை உள்ளிடவும்';
            document.getElementById('localTipCategory').placeholder = lang === 'en' ? 'e.g. Turmeric, Moringa, Meditation...' : 'எ.கா. மஞ்சள், முருங்கை, தியானம்...';
            document.getElementById('dietGoalInput').placeholder = lang === 'en' ? 'e.g. Weight loss, Muscle gain...' : 'எ.கா. எடை குறைப்பு, தசை வளர்ச்சி...';
            document.getElementById('allergiesInput').placeholder = lang === 'en' ? 'e.g. Peanuts, Dairy...' : 'எ.கா. நிலக்கடலை, பால்...';
            document.getElementById('exerciseDurationInput').placeholder = lang === 'en' ? 'Duration (minutes)' : 'கால அளவு (நிமிடங்கள்)';
            document.getElementById('diseasePreventionInput').placeholder = lang === 'en' ? 'e.g. Diabetes, Heart disease...' : 'எ.கா. சர்க்கரை நோய், இதய நோய்...';
            document.getElementById('challengeTopicInput').placeholder = lang === 'en' ? 'e.g. 30-day exercise, Hydration...' : 'எ.கா. 30 நாள் உடற்பயிற்சி, நீர் அருந்துதல்...';
            document.getElementById('medicationNameInput').placeholder = lang === 'en' ? 'Medicine Name' : 'மருந்து பெயர்';
            document.getElementById('medicationRingtoneInput').placeholder = lang === 'en' ? 'Ringtone (e.g., Alarm)' : 'ரிங்டோன் (எ.கா., அலாரம்)';
            document.getElementById('painDescriptionInput').placeholder = lang === 'en' ? 'Pain description (e.g., headache, shoulder pain)' : 'வலி விளக்கம் (எ.கா. தலைவலி, தோள்பட்டை வலி)';
            document.getElementById('firstAidSearchInput').placeholder = lang === 'en' ? 'e.g. Cut, Burn, Choking...' : 'எ.கா. வெட்டு, தீக்காயம், மூச்சுத்திணறல்...';
            document.getElementById('emergencyContactNameInput').placeholder = lang === 'en' ? 'Name' : 'பெயர்';
            document.getElementById('emergencyContactNumberInput').placeholder = lang === 'en' ? 'Phone Number' : 'தொலைபேசி எண்';

            // Update select options
            document.getElementById('moodSelect').querySelector('option[value=""]').textContent = lang === 'en' ? 'Select your mood' : 'உங்கள் மனநிலையைத் தேர்ந்தெடுக்கவும்';
            document.getElementById('moodSelect').querySelector('option[value="happy"]').textContent = lang === 'en' ? 'Happy 😄' : 'மகிழ்ச்சி 😄';
            document.getElementById('moodSelect').querySelector('option[value="neutral"]').textContent = lang === 'en' ? 'Neutral 😐' : 'சாதாரணம் 😐';
            document.getElementById('moodSelect').querySelector('option[value="sad"]').textContent = lang === 'en' ? 'Sad 😔' : 'சோகம் 😔';
            document.getElementById('moodSelect').querySelector('option[value="stressed"]').textContent = lang === 'en' ? 'Stressed 😩' : 'மன அழுத்தம் 😩';
            document.getElementById('moodSelect').querySelector('option[value="energetic"]').textContent = lang === 'en' ? 'Energetic 💪' : 'ஆற்றல் 💪';

            document.getElementById('dietPreferenceSelect').querySelector('option[value=""]').textContent = lang === 'en' ? 'Select food preference' : 'உணவு விருப்பத்தைத் தேர்ந்தெடுக்கவும்';
            document.getElementById('dietPreferenceSelect').querySelector('option[value="vegetarian"]').textContent = lang === 'en' ? 'Vegetarian' : 'சைவம்';
            document.getElementById('dietPreferenceSelect').querySelector('option[value="non-vegetarian"]').textContent = lang === 'en' ? 'Non-Vegetarian' : 'அசைவம்';
            document.getElementById('dietPreferenceSelect').querySelector('option[value="vegan"]').textContent = lang === 'en' ? 'Vegan' : 'முழு சைவம்';

            document.getElementById('exerciseTypeSelect').querySelector('option[value=""]').textContent = lang === 'en' ? 'Select exercise type' : 'உடற்பயிற்சி வகையைத் தேர்ந்தெடுக்கவும்';
            document.getElementById('exerciseTypeSelect').querySelector('option[value="strength"]').textContent = lang === 'en' ? 'Strength Training 💪' : 'வலிமை பயிற்சி 💪';
            document.getElementById('exerciseTypeSelect').querySelector('option[value="cardio"]').textContent = lang === 'en' ? 'Cardio 🏃‍♀️' : 'கார்டியோ 🏃‍♀️';
            document.getElementById('exerciseTypeSelect').querySelector('option[value="yoga"]').textContent = lang === 'en' ? 'Yoga 🧘‍♀️' : 'யோகா 🧘‍♀️';
            document.getElementById('exerciseTypeSelect').querySelector('option[value="flexibility"]').textContent = lang === 'en' ? 'Flexibility 🤸' : 'நெகிழ்வுத்தன்மை 🤸';

            // Update default output texts
            document.getElementById('stepResultOutput').textContent = t.stepResultOutputDefault;
            document.getElementById('stepTipOutput').textContent = t.stepTipOutputDefault;
            document.getElementById('heartRateResultOutput').textContent = t.heartRateResultOutputDefault;
            document.getElementById('heartRateTipOutput').textContent = t.heartRateTipOutputDefault;
            document.getElementById('waterResultOutput').textContent = t.waterResultOutputDefault;
            document.getElementById('waterTipOutput').textContent = t.waterTipOutputDefault;
            document.getElementById('journalEntriesOutput').textContent = t.journalEntriesOutputDefault;
            document.getElementById('moodAnalysisOutput').textContent = t.moodAnalysisOutputDefault;

            // Update alarm modal content
            document.getElementById('alarmModalTitle').textContent = t.alarmModalTitle;
            document.getElementById('alarmModalDismissBtn').textContent = t.alarmModalDismissBtn;

            // Update selected mood display if applicable
            const selectedMood = document.getElementById('moodSelect').value;
            if (selectedMood && selectedMood !== "") {
                const moodOption = document.getElementById('moodSelect').querySelector(`option[value="${selectedMood}"]`);
                if (moodOption) {
                    // Remove emoji from text for translation and then re-add
                    const originalText = moodOption.textContent;
                    const emojiMatch = originalText.match(/(\p{Emoji_Presentation}|\p{Emoji}\uFE0F|\p{Emoji_Modifier_Base})/u);
                    const emoji = emojiMatch ? emojiMatch[0] : '';
                    const textWithoutEmoji = originalText.replace(emoji, '').trim();

                    const translatedText = translations[lang][`mood${selectedMood.charAt(0).toUpperCase() + selectedMood.slice(1)}`];
                    moodOption.textContent = `${translatedText} ${emoji}`.trim();
                }
            }
        }

        // Function to show custom modal
        function showCustomModal(message, isSuccess = true) {
            const modal = document.getElementById('customModal');
            const modalMessage = document.getElementById('modalMessage');
            modalMessage.textContent = message;
            modalMessage.style.color = isSuccess ? '#16a34a' : '#dc2626'; // Green for success, red for error
            modal.querySelector('div').style.borderColor = isSuccess ? '#22c55e' : '#ef4444'; // Border color
            modal.classList.remove('hidden');
        }

        // Function to hide custom modal
        function hideCustomModal() {
            document.getElementById('customModal').classList.add('hidden');
        }

        // Event listener for language selection
        document.getElementById('languageSelect').addEventListener('change', (event) => {
            updateUI(event.target.value);
            loadVoices(); // Reload voices for new language
        });

        // Event listener for modal close button
        document.getElementById('modalCloseBtn').addEventListener('click', hideCustomModal);

        // Firebase Initialization and Authentication
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Cannot initialize Firebase.");
                    showCustomModal(translations[currentLang].modalAuthError, false);
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token if available, otherwise anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // document.getElementById('displayUserId').textContent = userId; // Removed displayUserId
                        isAuthReady = true;
                        console.log("Firebase authenticated. User ID:", userId);
                        // Fetch user data after successful authentication
                        fetchUserData();
                        setupMedicationListener();
                        setupJournalListener();
                        setupPainPointsListener();
                        setupEmergencyContactsListener();
                    } else {
                        userId = null;
                        // document.getElementById('displayUserId').textContent = 'Not Authenticated'; // Removed displayUserId
                        isAuthReady = false;
                        console.log("Firebase not authenticated.");
                        showCustomModal(translations[currentLang].modalAuthError, false);
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showCustomModal(translations[currentLang].modalAuthError, false);
            }
        }

        // --- Speech Recognition (STT) ---
        function setupSpeechRecognition(inputField, micButton) {
            if (!('webkitSpeechRecognition' in window)) {
                micButton.style.display = 'none';
                console.warn(translations[currentLang].speechRecognitionError);
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = currentLang === 'ta' ? 'ta-IN' : 'en-US'; // Set language dynamically

            micButton.addEventListener('click', () => {
                if (micButton.classList.contains('recording')) {
                    recognition.stop();
                    micButton.classList.remove('recording');
                    console.log("Speech recognition stopped.");
                } else {
                    recognition.start();
                    micButton.classList.add('recording');
                    inputField.placeholder = translations[currentLang].speechRecognitionListening;
                    console.log("Speech recognition started.");
                }
            });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                inputField.value = transcript;
                inputField.placeholder = ''; // Clear listening message
                micButton.classList.remove('recording');
                console.log('Speech result:', transcript);
                // Trigger action if needed, e.g., for dropdowns
                if (inputField.id === 'localTipCategory') {
                    filterDropdown(transcript, document.getElementById('localTipCategoryDropdown'), localTipCategories);
                }
            };

            recognition.onerror = (event) => {
                micButton.classList.remove('recording');
                inputField.placeholder = ''; // Clear listening message
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    showCustomModal(translations[currentLang].speechRecognitionNoMatch, false);
                } else if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    showCustomModal(translations[currentLang].speechRecognitionError, false);
                }
            };

            recognition.onend = () => {
                micButton.classList.remove('recording');
                if (inputField.placeholder === translations[currentLang].speechRecognitionListening) {
                    inputField.placeholder = ''; // Clear listening message if no result
                }
                console.log("Speech recognition ended.");
            };
        }

        // --- Text-to-Speech (TTS) ---
        function setupTextToSpeech(voiceSelectElement, aiVoiceButton, outputElementId) {
            if (!('speechSynthesis' in window)) {
                aiVoiceButton.style.display = 'none';
                voiceSelectElement.style.display = 'none';
                console.warn(translations[currentLang].ttsError);
                return;
            }

            synth = window.speechSynthesis;
            synth.onvoiceschanged = loadVoices; // Load voices when they are ready

            function loadVoices() {
                voices = synth.getVoices();
                voiceSelectElement.innerHTML = ''; // Clear existing options
                const langCode = currentLang === 'ta' ? 'ta-IN' : 'en-US';
                const filteredVoices = voices.filter(voice => voice.lang.startsWith(langCode));

                if (filteredVoices.length === 0) {
                    console.warn(translations[currentLang].ttsNoVoices);
                    const option = document.createElement('option');
                    option.textContent = translations[currentLang].ttsNoVoices;
                    voiceSelectElement.appendChild(option);
                    aiVoiceButton.style.display = 'none'; // Hide button if no voices
                    return;
                }
                aiVoiceButton.style.display = 'inline-flex'; // Show button if voices are found

                filteredVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelectElement.appendChild(option);
                });
            }

            // Initial load of voices (if already available)
            loadVoices();

            aiVoiceButton.addEventListener('click', () => {
                const textToSpeak = document.getElementById(outputElementId).textContent;
                if (!textToSpeak || textToSpeak.trim() === '') {
                    return; // No text to speak
                }

                if (speaking) {
                    synth.cancel(); // Stop current speech
                    speaking = false;
                    aiVoiceButton.classList.remove('recording');
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                const selectedVoiceName = voiceSelectElement.value;
                const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                } else {
                    // Fallback to a default voice for the language if selected not found
                    const langCode = currentLang === 'ta' ? 'ta-IN' : 'en-US';
                    const defaultVoice = voices.find(voice => voice.lang.startsWith(langCode));
                    if (defaultVoice) {
                        utterance.voice = defaultVoice;
                    } else {
                        console.warn(translations[currentLang].ttsNoVoices);
                        showCustomModal(translations[currentLang].ttsNoVoices, false);
                        return;
                    }
                }

                utterance.lang = currentLang === 'ta' ? 'ta-IN' : 'en-US';

                utterance.onstart = () => {
                    speaking = true;
                    aiVoiceButton.classList.add('recording');
                    console.log(translations[currentLang].ttsSpeaking);
                };

                utterance.onend = () => {
                    speaking = false;
                    aiVoiceButton.classList.remove('recording');
                    console.log("Speech ended.");
                };

                utterance.onerror = (event) => {
                    speaking = false;
                    aiVoiceButton.classList.remove('recording');
                    console.error('Speech synthesis error:', event);
                    showCustomModal(translations[currentLang].ttsError, false);
                };

                synth.speak(utterance);
            });
        }

        // --- LLM Integration (Gemini API) ---
        async function callGeminiAPI(prompt, outputElementId, loadingElementId, aiVoiceButtonId = null, ttsVoiceSelectId = null, schema = null) {
            const loadingIndicator = document.getElementById(loadingElementId);
            const outputElement = document.getElementById(outputElementId);
            const aiVoiceBtn = aiVoiceButtonId ? document.getElementById(aiVoiceButtonId) : null;
            const ttsVoiceSelect = ttsVoiceSelectId ? document.getElementById(ttsVoiceSelectId) : null;

            outputElement.textContent = ''; // Clear previous output
            if (aiVoiceBtn) aiVoiceBtn.style.display = 'none';
            if (ttsVoiceSelect) ttsVoiceSelect.style.display = 'none';
            loadingIndicator.style.display = 'flex';

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }

            const apiKey = ""; // Canvas will provide this at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let text = result.candidates[0].content.parts[0].text;
                    if (schema) {
                        // If schema was used, parse the JSON
                        try {
                            text = JSON.parse(text);
                            // Convert JSON object back to a readable string for display
                            text = JSON.stringify(text, null, 2);
                        } catch (e) {
                            console.error("Failed to parse JSON from LLM response:", e);
                            text = translations[currentLang].modalErrorTitle + ": Invalid response format.";
                        }
                    }
                    outputElement.textContent = text;
                    if (aiVoiceBtn) aiVoiceBtn.style.display = 'inline-flex';
                    if (ttsVoiceSelect) ttsVoiceSelect.style.display = 'inline-flex';
                } else {
                    outputElement.textContent = translations[currentLang].modalErrorTitle + ": No response from AI.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                outputElement.textContent = translations[currentLang].modalErrorTitle + ": " + error.message;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // --- Navigation Logic ---
        function showSection(sectionId) {
            document.querySelectorAll('.feature-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            document.getElementById('allFeatureIconsContainer').style.display = 'none';
            document.getElementById('allFeatureIconsContainer').classList.remove('active');
            document.getElementById('initialView').style.display = 'none';
            document.getElementById('featuresContainer').style.display = 'block';
            document.getElementById('backToMainFromFeaturesContainer').style.display = 'inline-flex'; // Show back to main button

            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
                document.getElementById('featuresPageTitle').textContent = translations[currentLang][`${sectionId.replace('Section', '')}SectionTitle`];
                document.body.classList.add('main-content-active'); // Adjust body styling for scrolling
            }
        }

        function showFeatureIcons() {
            document.querySelectorAll('.feature-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            document.getElementById('allFeatureIconsContainer').style.display = 'flex';
            document.getElementById('allFeatureIconsContainer').classList.add('active');
            document.getElementById('initialView').style.display = 'none';
            document.getElementById('featuresContainer').style.display = 'block';
            document.getElementById('backToMainFromFeaturesContainer').style.display = 'inline-flex'; // Show back to main button
            document.getElementById('featuresPageTitle').textContent = translations[currentLang].featuresPageTitle;
            document.body.classList.add('main-content-active'); // Adjust body styling for scrolling
        }

        function showInitialView() {
            document.querySelectorAll('.feature-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            document.getElementById('allFeatureIconsContainer').style.display = 'none';
            document.getElementById('allFeatureIconsContainer').classList.remove('active');
            document.getElementById('featuresContainer').style.display = 'none';
            document.getElementById('initialView').style.display = 'block';
            document.getElementById('backToMainFromFeaturesContainer').style.display = 'none'; // Hide back to main button
            document.body.classList.remove('main-content-active'); // Reset body styling
        }

        // Event listeners for feature icons
        document.querySelectorAll('.feature-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                const sectionId = icon.dataset.section;
                showSection(sectionId);
            });
        });

        // Event listeners for back buttons within feature sections
        document.querySelectorAll('.feature-section .back-button').forEach(button => {
            button.addEventListener('click', () => {
                showFeatureIcons();
            });
        });

        // Back to main from features container
        document.getElementById('backToMainFromFeaturesContainer').addEventListener('click', showInitialView);

        // Toggle features button on initial view
        document.getElementById('toggleFeaturesBtn').addEventListener('click', showFeatureIcons);

        // --- Feature Implementations ---

        // 1. Step Tracker
        let currentSteps = 0;
        let stepTrackingInterval = null;
        function updateStepDisplay() {
            document.getElementById('currentStepsDisplay').value = currentSteps;
            if (currentSteps >= 10000) {
                document.getElementById('stepResultOutput').textContent = "Excellent! You've reached your daily 10,000 steps goal!";
            } else {
                document.getElementById('stepResultOutput').textContent = translations[currentLang].stepResultOutputDefault;
            }
        }

        document.getElementById('addOneStepBtn').addEventListener('click', () => {
            currentSteps += 100;
            updateStepDisplay();
            saveTrackerData('steps', currentSteps);
        });

        // New button for adding a single step
        document.getElementById('addSingleStepBtn').addEventListener('click', () => {
            currentSteps += 1;
            updateStepDisplay();
            saveTrackerData('steps', currentSteps);
        });

        document.getElementById('toggleTrackingBtn').addEventListener('click', () => {
            if (stepTrackingInterval) {
                clearInterval(stepTrackingInterval);
                stepTrackingInterval = null;
                document.getElementById('toggleTrackingBtn').textContent = translations[currentLang].toggleTrackingBtn.replace('Start', 'Resume');
                document.getElementById('stepResultOutput').textContent = "Step tracking paused.";
            } else {
                stepTrackingInterval = setInterval(() => {
                    currentSteps += Math.floor(Math.random() * 50) + 1; // Simulate random steps
                    updateStepDisplay();
                    saveTrackerData('steps', currentSteps);
                }, 2000); // Add steps every 2 seconds
                document.getElementById('toggleTrackingBtn').textContent = translations[currentLang].toggleTrackingBtn.replace('Start', 'Pause');
                document.getElementById('stepResultOutput').textContent = "Step tracking started!";
            }
        });

        document.getElementById('resetStepsBtn').addEventListener('click', () => {
            currentSteps = 0;
            updateStepDisplay();
            saveTrackerData('steps', currentSteps);
            if (stepTrackingInterval) {
                clearInterval(stepTrackingInterval);
                stepTrackingInterval = null;
                document.getElementById('toggleTrackingBtn').textContent = translations[currentLang].toggleTrackingBtn.replace('Start', 'Start');
            }
            document.getElementById('stepResultOutput').textContent = translations[currentLang].stepResultOutputDefault;
        });

        // 2. Heart Rate Tracker
        let currentHeartRate = 0;
        function updateHeartRateDisplay() {
            document.getElementById('currentHeartRateDisplay').value = currentHeartRate;
            if (currentHeartRate > 100) {
                document.getElementById('heartRateResultOutput').textContent = "Your heart rate is a bit high. Consider relaxing or consulting a doctor.";
            } else if (currentHeartRate < 60 && currentHeartRate !== 0) {
                document.getElementById('heartRateResultOutput').textContent = "Your heart rate is a bit low. If you feel unwell, consult a doctor.";
            } else if (currentHeartRate === 0) {
                document.getElementById('heartRateResultOutput').textContent = translations[currentLang].heartRateResultOutputDefault;
            } else {
                document.getElementById('heartRateResultOutput').textContent = "Your heart rate is within a healthy range.";
            }
        }

        document.getElementById('simulateHeartRateBtn').addEventListener('click', () => {
            currentHeartRate = Math.floor(Math.random() * (120 - 50 + 1)) + 50; // Simulate 50-120 BPM
            updateHeartRateDisplay();
            saveTrackerData('heartRate', currentHeartRate);
        });

        document.getElementById('resetHeartRateBtn').addEventListener('click', () => {
            currentHeartRate = 0;
            updateHeartRateDisplay();
            saveTrackerData('heartRate', currentHeartRate);
        });

        // 3. Water Tracker
        let currentWaterIntake = 0;
        function updateWaterDisplay() {
            document.getElementById('waterIntakeDisplay').value = `${currentWaterIntake} ml`;
            if (currentWaterIntake >= 2000) {
                document.getElementById('waterResultOutput').textContent = "Great! You've met your daily water intake goal.";
            } else {
                document.getElementById('waterResultOutput').textContent = translations[currentLang].waterResultOutputDefault;
            }
        }

        document.getElementById('addWaterBtn').addEventListener('click', () => {
            currentWaterIntake += 250;
            updateWaterDisplay();
            saveTrackerData('waterIntake', currentWaterIntake);
        });

        document.getElementById('resetWaterBtn').addEventListener('click', () => {
            currentWaterIntake = 0;
            updateWaterDisplay();
            saveTrackerData('waterIntake', currentWaterIntake);
        });

        // Save general tracker data (steps, heart rate, water)
        async function saveTrackerData(key, value) {
            if (!isAuthReady || !userId) {
                console.warn("Auth not ready or userId not available for saving tracker data.");
                return;
            }
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'tracker_data');
                await setDoc(userDocRef, { [key]: value, lastUpdated: new Date().toISOString() }, { merge: true });
                console.log(`Tracker data for ${key} saved.`);
            } catch (error) {
                console.error(`Error saving ${key} tracker data:`, error);
            }
        }

        // Fetch general tracker data
        async function fetchTrackerData() {
            if (!isAuthReady || !userId) {
                console.log("Auth not ready or userId not available for fetching tracker data.");
                return;
            }
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'tracker_data');
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentSteps = data.steps || 0;
                    currentHeartRate = data.heartRate || 0;
                    currentWaterIntake = data.waterIntake || 0;
                    updateStepDisplay();
                    updateHeartRateDisplay();
                    updateWaterDisplay();
                }
            } catch (error) {
                console.error("Error fetching tracker data:", error);
            }
        }

        // 4. Mood & Gratitude Journal
        async function saveJournalEntry() {
            if (!isAuthReady || !userId) {
                showCustomModal(translations[currentLang].modalAuthError, false);
                return;
            }
            const mood = document.getElementById('moodSelect').value;
            const gratitude = document.getElementById('gratitudeInput').value.trim();

            if (!mood || !gratitude) {
                showCustomModal(translations[currentLang].modalJournalError + " Please select a mood and write something.", false);
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/journal_entries`), {
                    mood,
                    gratitude,
                    timestamp: new Date().toISOString()
                });
                document.getElementById('moodSelect').value = '';
                document.getElementById('gratitudeInput').value = '';
                showCustomModal(translations[currentLang].modalJournalSaved, true);
            } catch (error) {
                console.error("Error saving journal entry:", error);
                showCustomModal(translations[currentLang].modalJournalError + ": " + error.message, false);
            }
        }

        function setupJournalListener() {
            if (!isAuthReady || !userId) return;
            const q = collection(db, `artifacts/${appId}/users/${userId}/journal_entries`);
            onSnapshot(q, (snapshot) => {
                const journalEntriesOutput = document.getElementById('journalEntriesOutput');
                journalEntriesOutput.innerHTML = `<h3 class="font-semibold mb-2">${translations[currentLang].journalEntriesOutputDefault}</h3><ul class="list-disc pl-5"></ul>`;
                const ul = journalEntriesOutput.querySelector('ul');
                if (snapshot.empty) {
                    ul.innerHTML = `<li>${translations[currentLang].journalEntriesOutputDefault}</li>`;
                } else {
                    snapshot.forEach((doc) => {
                        const entry = doc.data();
                        const li = document.createElement('li');
                        li.className = 'mb-2';
                        const date = new Date(entry.timestamp).toLocaleDateString(currentLang, { year: 'numeric', month: 'short', day: 'numeric' });
                        li.innerHTML = `<strong>${date} - ${translations[currentLang][`mood${entry.mood.charAt(0).toUpperCase() + entry.mood.slice(1)}`]}</strong>: ${entry.gratitude} 
                                        <button class="text-red-500 hover:text-red-700 ml-2 text-sm delete-journal-btn" data-id="${doc.id}">Delete</button>`;
                        ul.appendChild(li);
                    });
                }
                document.querySelectorAll('.delete-journal-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const entryId = e.target.dataset.id;
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/journal_entries`, entryId));
                            showCustomModal('Journal entry deleted successfully!', true);
                        } catch (error) {
                            console.error("Error deleting journal entry:", error);
                            showCustomModal('Failed to delete journal entry.', false);
                        }
                    });
                });
            }, (error) => {
                console.error("Error listening to journal entries:", error);
            });
        }

        document.getElementById('saveJournalEntryBtn').addEventListener('click', saveJournalEntry);

        document.getElementById('analyzeMoodJournalBtn').addEventListener('click', async () => {
            if (!isAuthReady || !userId) {
                showCustomModal(translations[currentLang].modalAuthError, false);
                return;
            }
            const journalData = [];
            const snapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/journal_entries`));
            snapshot.forEach(doc => journalData.push(doc.data()));

            if (journalData.length === 0) {
                document.getElementById('moodAnalysisOutput').textContent = translations[currentLang].moodAnalysisOutputDefault;
                showCustomModal("No journal entries to analyze.", false);
                return;
            }

            const prompt = `Analyze the following mood journal entries and provide a summary of the user's emotional patterns, potential trends, and general well-being. Suggest actionable insights or tips based on the analysis. Provide the response in ${currentLang === 'ta' ? 'Tamil' : 'English'}.
            Journal Entries: ${JSON.stringify(journalData)}`;

            await callGeminiAPI(prompt, 'moodAnalysisOutput', 'loading', 'moodAnalysisAiVoiceBtn', 'ttsVoiceSelect');
        });

        // 5. Local Health Tips
        const localTipCategories = [
            'Turmeric benefits', 'Moringa uses', 'Neem benefits', 'Ayurvedic remedies for cold',
            'Yoga for stress relief', 'Meditation techniques', 'Traditional Indian diet',
            'Herbal teas for digestion', 'Benefits of Giloy', 'Natural remedies for skin',
            'Benefits of Ashwagandha', 'Home remedies for cough', 'Healthy breakfast ideas',
            'Importance of sleep', 'Mindfulness exercises', 'Benefits of sunlight',
            'Seasonal fruit benefits', 'Benefits of spices', 'Water purification methods',
            'Benefits of walking', 'Healthy cooking oils', 'Benefits of fasting',
            'Importance of fresh air', 'Benefits of gardening', 'Natural pain relief'
        ];

        function filterDropdown(query, dropdownElement, optionsArray) {
            dropdownElement.innerHTML = '';
            const filtered = optionsArray.filter(option =>
                option.toLowerCase().includes(query.toLowerCase())
            );
            if (filtered.length > 0 && query.length > 0) {
                filtered.forEach(option => {
                    const div = document.createElement('div');
                    div.textContent = option;
                    div.addEventListener('click', () => {
                        document.getElementById('localTipCategory').value = option;
                        dropdownElement.classList.add('hidden');
                    });
                    dropdownElement.appendChild(div);
                });
                dropdownElement.classList.remove('hidden');
            } else {
                dropdownElement.classList.add('hidden');
            }
        }

        document.getElementById('localTipCategory').addEventListener('input', (e) => {
            filterDropdown(e.target.value, document.getElementById('localTipCategoryDropdown'), localTipCategories);
        });

        document.getElementById('localTipCategory').addEventListener('focus', (e) => {
            filterDropdown(e.target.value, document.getElementById('localTipCategoryDropdown'), localTipCategories);
        });

        document.addEventListener('click', (e) => {
            if (!document.getElementById('localTipCategory').contains(e.target) &&
                !document.getElementById('localTipCategoryDropdown').contains(e.target)) {
                document.getElementById('localTipCategoryDropdown').classList.add('hidden');
            }
        });

        document.getElementById('getLocalTipBtn').addEventListener('click', async () => {
            const category = document.getElementById('localTipCategory').value.trim();
            const prompt = `Provide a detailed health tip about "${category}" focusing on its benefits and how to incorporate it into daily life, especially from a traditional or local perspective if applicable. Provide the response in ${currentLang === 'ta' ? 'Tamil' : 'English'}.`;
            await callGeminiAPI(prompt, 'localTipOutput', 'loading', 'localTipAiVoiceBtn', 'ttsVoiceSelect');
        });

        // 6. Meal Plan Recommendations
        document.getElementById('generateMealPlanBtn').addEventListener('click', async () => {
            const dietGoal = document.getElementById('dietGoalInput').value.trim();
            const dietPreference = document.getElementById('dietPreferenceSelect').value;
            const allergies = document.getElementById('allergiesInput').value.trim();

            if (!dietGoal || !dietPreference) {
                showCustomModal("Please enter your diet goal and select a food preference.", false);
                return;
            }

            const prompt = `Generate a 3-day meal plan (breakfast, lunch, dinner, and 2 snacks per day) for a person with the following preferences:
            Goal: ${dietGoal}
            Food Preference: ${dietPreference}
            Allergies: ${allergies || 'None'}
            Ensure the plan is healthy, balanced, and suitable for the specified goal. Provide the response in ${currentLang === 'ta' ? 'Tamil' : 'English'}.`;

            await callGeminiAPI(prompt, 'mealPlanOutput', 'loading', 'mealPlanAiVoiceBtn', 'ttsVoiceSelect');
        });

        // 7. Exercise & Yoga Plans
        document.getElementById('getExercisePlanBtn').addEventListener('click', async () => {
            const exerciseType = document.getElementById('exerciseTypeSelect').value;
            const duration = document.getElementById('exerciseDurationInput').value.trim();

            if (!exerciseType || !duration) {
                showCustomModal("Please select an exercise type and enter a duration.", false);
                return;
            }

            const prompt = `Generate a ${duration}-minute ${exerciseType} routine, suitable for a beginner. Include warm-up, main exercises, and cool-down. Provide the response in ${currentLang === 'ta' ? 'Tamil' : 'English'}.`;
            await callGeminiAPI(prompt, 'exercisePlanOutput', 'loading', 'exercisePlanAiVoiceBtn', 'ttsVoiceSelect');
        });

        // 8. Disease Prevention Information
        document.getElementById('getPreventionInfoBtn').addEventListener('click', async () => {
            const disease = document.getElementById('diseasePreventionInput').value.trim();
            if (!disease) {
                showCustomModal("Please enter a disease to get prevention information.", false);
                return;
            }
            const prompt = `Provide detailed information on how to prevent "${disease}", including lifestyle changes, dietary recommendations, and any other relevant tips. Provide the response in ${currentLang === 'ta' ? 'Tamil' : 'English'}.`;
            await callGeminiAPI(prompt, 'preventionInfoOutput', 'loading', 'preventionInfoAiVoiceBtn', 'ttsVoiceSelect');
        });

        // 9. Wellness Challenges
        document.getElementById('generateChallengeBtn').addEventListener('click', async () => {
            const topic = document.getElementById('challengeTopicInput').value.trim();
            if (!topic) {
                showCustomModal("Please enter a topic for the wellness challenge.", false);
                return;
            }
            const prompt = `Create a 7-day wellness challenge focused on "${topic}". Outline daily tasks or goals for each day. Provide the response in ${currentLang === 'ta' ? 'Tamil' : 'English'}.`;
            await callGeminiAPI(prompt, 'challengeOutput', 'loading', 'challengeAiVoiceBtn', 'ttsVoiceSelect');
        });

        // 10. Medication Reminders
        const medicationTimers = {}; // Stores setInterval IDs for clearing

        async function addMedication() {
            if (!isAuthReady || !userId) {
                showCustomModal(translations[currentLang].modalAuthError, false);
                return;
            }

            const name = document.getElementById('medicationNameInput').value.trim();
            const time = document.getElementById('medicationTimeInput').value.trim();
            const ringtone = document.getElementById('medicationRingtoneInput').value.trim();

            if (!name || !time) {
                showCustomModal(translations[currentLang].modalMedicineError, false);
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/medications`), {
                    name,
                    time,
                    ringtone,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('medicationNameInput').value = '';
                document.getElementById('medicationTimeInput').value = '';
                document.getElementById('medicationRingtoneInput').value = '';
                showCustomModal(translations[currentLang].modalMedicineAdded, true);
            } catch (error) {
                console.error("Error adding medication:", error);
                showCustomModal(translations[currentLang].modalSaveError, false);
            }
        }

        async function deleteMedication(docId) {
            if (!isAuthReady || !userId) {
                showCustomModal(translations[currentLang].modalAuthError, false);
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/medications`, docId));
                showCustomModal(translations[currentLang].modalMedicineRemoved, true);
            } catch (error) {
                console.error("Error deleting medication:", error);
                showCustomModal(translations[currentLang].modalSaveError, false);
            }
        }

        function setupMedicationListener() {
            if (!isAuthReady || !userId) {
                console.log("Auth not ready or userId not available for medication listener.");
                return;
            }
            // Clear existing timers before setting new ones
            for (const timerId in medicationTimers) {
                clearInterval(medicationTimers[timerId]);
            }
            Object.keys(medicationTimers).forEach(key => delete medicationTimers[key]);


            const q = collection(db, `artifacts/${appId}/users/${userId}/medications`);
            onSnapshot(q, (snapshot) => {
                const medicationListDiv = document.getElementById('medicationList');
                medicationListDiv.innerHTML = ''; // Clear existing list
                snapshot.forEach((doc) => {
                    const med = doc.data();
                    const medItem = document.createElement('div');
                    medItem.className = 'flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200';
                    medItem.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${med.name}</p>
                            <p class="text-sm text-gray-600">${med.time} ${med.ringtone ? `(${med.ringtone})` : ''}</p>
                        </div>
                        <button class="delete-med-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition-colors" data-id="${doc.id}">
                            Delete
                        </button>
                    `;
                    medicationListDiv.appendChild(medItem);

                    // Set up alarm for each medication
                    setMedicationAlarm(med.name, med.time);
                });

                // Attach event listeners to new delete buttons
                document.querySelectorAll('.delete-med-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const docId = event.target.dataset.id;
                        deleteMedication(docId);
                    });
                });
            }, (error) => {
                console.error("Error listening to medications:", error);
            });
        }

        function setMedicationAlarm(medName, medTime) {
            const [hours, minutes] = medTime.split(':').map(Number);
            const now = new Date();
            const alarmTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0, 0);

            // If alarm time is in the past for today, set it for tomorrow
            if (alarmTime.getTime() < now.getTime()) {
                alarmTime.setDate(alarmTime.getDate() + 1);
            }

            const timeToAlarm = alarmTime.getTime() - now.getTime();

            if (timeToAlarm > 0) {
                // Clear any existing timer for this medication name to prevent duplicates
                if (medicationTimers[medName]) {
                    clearInterval(medicationTimers[medName]);
                }

                medicationTimers[medName] = setInterval(() => {
                    const currentTime = new Date();
                    if (currentTime.getHours() === hours && currentTime.getMinutes() === minutes) {
                        showAlarmModal(medName);
                        // To make it ring daily at the same time, we don't clear the interval here.
                        // Instead, the interval will keep checking.
                        // For a more robust solution, you might calculate the exact time until the next day's alarm.
                    }
                }, 60 * 1000); // Check every minute
                console.log(`Alarm set for ${medName} at ${medTime}. Next ring in ${timeToAlarm / 1000 / 60} minutes.`);
            }
        }

        function showAlarmModal(medName) {
            const alarmModal = document.getElementById('alarmModal');
            document.getElementById('alarmModalMessage').textContent = translations[currentLang].alarmModalMessage + medName;
            alarmModal.classList.add('show');
            alarmSynth.triggerAttackRelease("C4", "8n"); // Play a simple sound
            setTimeout(() => alarmSynth.triggerAttackRelease("E4", "8n"), 200);
            setTimeout(() => alarmSynth.triggerAttackRelease("G4", "8n"), 400);
        }

        document.getElementById('alarmModalDismissBtn').addEventListener('click', () => {
            document.getElementById('alarmModal').classList.remove('show');
            alarmSynth.triggerRelease(); // Stop sound if playing
        });

        document.getElementById('addMedicationBtn').addEventListener('click', addMedication);


        // 11. Body Pain Mapping
        let selectedPainPoint = null; // To store the currently selected pain dot element

        async function savePainPoint(x, y, description) {
            if (!isAuthReady || !userId) {
                showCustomModal(translations[currentLang].modalAuthError, false);
                return;
            }
            if (!description.trim()) {
                showCustomModal(translations[currentLang].modalPainPointError, false);
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/pain_points`), {
                    x,
                    y,
                    description,
                    timestamp: new Date().toISOString()
                });
                document.getElementById('painDescriptionInput').value = '';
                showCustomModal(translations[currentLang].modalPainPointSaved, true);
            } catch (error) {
                console.error("Error saving pain point:", error);
                showCustomModal(translations[currentLang].modalSaveError, false);
            }
        }

        async function deletePainPoint(docId) {
            if (!isAuthReady || !userId) {
                showCustomModal(translations[currentLang].modalAuthError, false);
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/pain_points`, docId));
                showCustomModal(translations[currentLang].modalPainPointRemoved, true);
            } catch (error) {
                console.error("Error deleting pain point:", error);
                showCustomModal(translations[currentLang].modalSaveError, false);
            }
        }

        function setupPainPointsListener() {
            if (!isAuthReady || !userId) return;
            const q = collection(db, `artifacts/${appId}/users/${userId}/pain_points`);
            onSnapshot(q, (snapshot) => {
                const painDotsContainer = document.getElementById('painDotsContainer');
                painDotsContainer.innerHTML = ''; // Clear existing dots
                const painPointsUl = document.getElementById('painPointsUl');
                painPointsUl.innerHTML = ''; // Clear existing list items

                if (snapshot.empty) {
                    painPointsUl.innerHTML = `<li>${translations[currentLang].recordedPainPoints} ${translations[currentLang].moodAnalysisOutputDefault}</li>`; // Reusing default empty message
                } else {
                    snapshot.forEach((doc) => {
                        const pain = doc.data();
                        // Add dot to map
                        const dot = document.createElement('div');
                        dot.className = 'pain-dot';
                        dot.style.left = `${pain.x}%`;
                        dot.style.top = `${pain.y}%`;
                        dot.title = pain.description;
                        dot.dataset.id = doc.id;
                        painDotsContainer.appendChild(dot);

                        // Add to list
                        const li = document.createElement('li');
                        li.className = 'mb-1';
                        const date = new Date(pain.timestamp).toLocaleDateString(currentLang, { year: 'numeric', month: 'short', day: 'numeric' });
                        li.innerHTML = `<strong>${date}</strong>: ${pain.description} 
                                        <button class="text-red-500 hover:text-red-700 ml-2 text-sm delete-pain-btn" data-id="${doc.id}">Delete</button>`;
                        painPointsUl.appendChild(li);
                    });
                }

                // Attach event listeners to new delete buttons
                document.querySelectorAll('.delete-pain-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const docId = event.target.dataset.id;
                        deletePainPoint(docId);
                    });
                });
            }, (error) => {
                console.error("Error listening to pain points:", error);
            });
        }

        document.getElementById('bodyMapImage').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            // Remove 'selected' class from previously selected dot
            if (selectedPainPoint) {
                selectedPainPoint.classList.remove('selected');
            }

            // Create a temporary dot to show where the user clicked
            const tempDot = document.createElement('div');
            tempDot.className = 'pain-dot selected'; // Mark as selected
            tempDot.style.left = `${x}%`;
            tempDot.style.top = `${y}%`;
            document.getElementById('painDotsContainer').appendChild(tempDot);
            selectedPainPoint = tempDot; // Set as currently selected

            // Store coordinates in data attributes for saving
            tempDot.dataset.x = x;
            tempDot.dataset.y = y;

            document.getElementById('painDescriptionInput').focus(); // Focus input for description
        });

        document.getElementById('savePainPointBtn').addEventListener('click', () => {
            if (selectedPainPoint) {
                const x = parseFloat(selectedPainPoint.dataset.x);
                const y = parseFloat(selectedPainPoint.dataset.y);
                const description = document.getElementById('painDescriptionInput').value.trim();
                savePainPoint(x, y, description);
                selectedPainPoint.remove(); // Remove temporary dot after saving
                selectedPainPoint = null;
            } else {
                showCustomModal("Please click on the body map to mark a pain point first.", false);
            }
        });

        // 12. First Aid & Emergency
        async function addEmergencyContact() {
            if (!isAuthReady || !userId) {
                showCustomModal(translations[currentLang].modalAuthError, false);
                return;
            }

            const name = document.getElementById('emergencyContactNameInput').value.trim();
            const number = document.getElementById('emergencyContactNumberInput').value.trim();

            if (!name || !number) {
                showCustomModal(translations[currentLang].modalContactError, false);
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/emergency_contacts`), {
                    name,
                    number,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('emergencyContactNameInput').value = '';
                document.getElementById('emergencyContactNumberInput').value = '';
                showCustomModal(translations[currentLang].modalContactAdded, true);
            } catch (error) {
                console.error("Error adding emergency contact:", error);
                showCustomModal(translations[currentLang].modalSaveError, false);
            }
        }

        async function deleteEmergencyContact(docId) {
            if (!isAuthReady || !userId) {
                showCustomModal(translations[currentLang].modalAuthError, false);
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/emergency_contacts`, docId));
                showCustomModal(translations[currentLang].modalContactRemoved, true);
            } catch (error) {
                console.error("Error deleting emergency contact:", error);
                showCustomModal(translations[currentLang].modalSaveError, false);
            }
        }

        function setupEmergencyContactsListener() {
            if (!isAuthReady || !userId) return;
            const q = collection(db, `artifacts/${appId}/users/${userId}/emergency_contacts`);
            onSnapshot(q, (snapshot) => {
                const contactListDiv = document.getElementById('emergencyContactList');
                contactListDiv.innerHTML = ''; // Clear existing list
                if (snapshot.empty) {
                    contactListDiv.innerHTML = `<p class="text-gray-500">${translations[currentLang].emergencyContactsTitle} ${translations[currentLang].moodAnalysisOutputDefault}</p>`; // Reusing default empty message
                } else {
                    snapshot.forEach((doc) => {
                        const contact = doc.data();
                        const contactItem = document.createElement('div');
                        contactItem.className = 'flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-200';
                        contactItem.innerHTML = `
                            <div>
                                <p class="font-semibold text-gray-800">${contact.name}</p>
                                <p class="text-sm text-gray-600">${contact.number}</p>
                            </div>
                            <button class="delete-contact-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition-colors" data-id="${doc.id}">
                                Delete
                            </button>
                        `;
                        contactListDiv.appendChild(contactItem);
                    });
                }
                document.querySelectorAll('.delete-contact-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const docId = event.target.dataset.id;
                        deleteEmergencyContact(docId);
                    });
                });
            }, (error) => {
                console.error("Error listening to emergency contacts:", error);
            });
        }

        document.getElementById('addEmergencyContactBtn').addEventListener('click', addEmergencyContact);

        document.getElementById('getFirstAidInfoBtn').addEventListener('click', async () => {
            const query = document.getElementById('firstAidSearchInput').value.trim();
            if (!query) {
                showCustomModal("Please enter a first aid topic to search.", false);
                return;
            }
            const prompt = `Provide concise and actionable first aid information for "${query}". Include immediate steps and what to avoid. Provide the response in ${currentLang === 'ta' ? 'Tamil' : 'English'}.`;
            await callGeminiAPI(prompt, 'firstAidOutput', 'loading', 'firstAidAiVoiceBtn', 'ttsVoiceSelect');
        });

        // --- Initial Load and Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Speech Recognition for relevant inputs
            setupSpeechRecognition(document.getElementById('goalInput'), document.getElementById('micBtn'));
            setupSpeechRecognition(document.getElementById('localTipCategory'), document.getElementById('localTipMicBtn'));
            setupSpeechRecognition(document.getElementById('dietGoalInput'), document.getElementById('dietGoalMicBtn'));
            setupSpeechRecognition(document.getElementById('allergiesInput'), document.getElementById('allergiesMicBtn'));
            setupSpeechRecognition(document.getElementById('medicationNameInput'), document.getElementById('medicationNameMicBtn'));
            setupSpeechRecognition(document.getElementById('firstAidSearchInput'), document.getElementById('firstAidSearchMicBtn'));
            setupSpeechRecognition(document.getElementById('emergencyContactNameInput'), document.getElementById('emergencyContactNameMicBtn'));
            setupSpeechRecognition(document.getElementById('emergencyContactNumberInput'), document.getElementById('emergencyContactNumberMicBtn'));

            // Setup Text-to-Speech for relevant outputs
            setupTextToSpeech(document.getElementById('ttsVoiceSelect'), document.getElementById('aiVoiceBtn'), 'tipOutput');
            setupTextToSpeech(document.getElementById('stepTipTtsVoiceSelect'), document.getElementById('stepTipAiVoiceBtn'), 'stepTipOutput'); // New TTS for Step Tracker tip
            setupTextToSpeech(document.getElementById('ttsVoiceSelect'), document.getElementById('localTipAiVoiceBtn'), 'localTipOutput');
            setupTextToSpeech(document.getElementById('ttsVoiceSelect'), document.getElementById('mealPlanAiVoiceBtn'), 'mealPlanOutput');
            setupTextToSpeech(document.getElementById('ttsVoiceSelect'), document.getElementById('moodAnalysisAiVoiceBtn'), 'moodAnalysisResultOutput');
            setupTextToSpeech(document.getElementById('ttsVoiceSelect'), document.getElementById('exercisePlanAiVoiceBtn'), 'exercisePlanOutput');
            setupTextToSpeech(document.getElementById('ttsVoiceSelect'), document.getElementById('preventionInfoAiVoiceBtn'), 'preventionInfoOutput');
            setupTextToSpeech(document.getElementById('ttsVoiceSelect'), document.getElementById('challengeAiVoiceBtn'), 'challengeOutput');
            setupTextToSpeech(document.getElementById('ttsVoiceSelect'), document.getElementById('firstAidAiVoiceBtn'), 'firstAidOutput');


            updateUI(document.getElementById('languageSelect').value); // Set initial language

            // Hide splash screen after a delay and show main content
            setTimeout(() => {
                document.getElementById('splashScreen').classList.add('fade-out');
                document.body.style.backgroundColor = '#E6F7FF'; // Ensure body background is set
                setTimeout(() => {
                    document.getElementById('splashScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    document.body.classList.add('main-content-active'); // Set active class for initial view
                    initializeFirebase(); // Initialize Firebase after splash screen
                }, 1000); // Wait for fade-out transition
            }, 2000); // Display splash screen for 2 seconds

            // Main "Get Tip" button
            document.getElementById('generateBtn').addEventListener('click', async () => {
                const goal = document.getElementById('goalInput').value.trim();
                if (!goal) {
                    document.getElementById('tipOutput').textContent = "Please enter a health goal.";
                    return;
                }
                const prompt = `Provide a concise, actionable health tip for the goal: "${goal}". Focus on one specific, easy-to-implement action. Provide the response in ${currentLang === 'ta' ? 'Tamil' : 'English'}.`;
                await callGeminiAPI(prompt, 'tipOutput', 'loading', 'aiVoiceBtn', 'ttsVoiceSelect');
            });
        });

        // Fetch user data on Firebase auth ready
        async function fetchUserData() {
            if (!isAuthReady || !userId) {
                console.log("Auth not ready or userId not available for fetching user data.");
                return;
            }
            fetchTrackerData(); // Fetch steps, heart rate, water
            // Other data listeners are set up in onAuthStateChanged
        }
    </script>
</body>
</html>
